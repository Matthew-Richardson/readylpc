<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReadyLaPlata — La Plata County Evacuation Viewer</title>
  
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta name="description" content="Official evacuation information and interactive maps for La Plata County, Colorado. View active incidents, evacuation zones, and sign up for emergency alerts.">
  <meta name="theme-color" content="#0b4da2">
  
  <meta property="og:title" content="ReadyLaPlata — La Plata County Evacuation Viewer">
  <meta property="og:description" content="Official evacuation information and interactive maps for La Plata County, Colorado. View active incidents and evacuation zones.">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="en_US">
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ReadyLaPlata — La Plata County Evacuation Viewer">
  <meta name="twitter:description" content="Official evacuation information for La Plata County, Colorado.">

  <link rel="dns-prefetch" href="//js.arcgis.com">
  <link rel="dns-prefetch" href="//services2.arcgis.com">
  <link rel="preconnect" href="https://js.arcgis.com" crossorigin>
  <link rel="preconnect" href="https://services2.arcgis.com" crossorigin>

  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;font-family:Arial,sans-serif;background:#f5f5f7;font-size:18px;overflow-x:hidden;color:#000}
    .page-shell{min-height:100vh;display:flex;flex-direction:column}
    .map-wrapper{max-width:900px;width:100%;margin:16px auto 0;padding:12px}
    .map-card{width:100%;border-radius:14px;border:1px solid rgba(0,0,0,0.15);box-shadow:0 4px 20px rgba(0,0,0,0.12);overflow:hidden;background:#fff;display:flex;flex-direction:column}
    #viewDiv{width:100%;height:clamp(400px, 55vh, 550px);background:#e5e5e5;position:relative}
    @media (max-width: 600px) {
      #viewDiv{height:clamp(480px, 66vh, 660px)}
    }
    /* Custom mobile fullscreen */
    .map-fullscreen-btn{display:none;position:absolute;bottom:12px;left:12px;z-index:10;width:40px;height:40px;border:none;border-radius:8px;background:rgba(255,255,255,0.95);box-shadow:0 2px 8px rgba(0,0,0,0.2);cursor:pointer;align-items:center;justify-content:center}
    .map-fullscreen-btn svg{width:20px;height:20px;color:#333}
    @media (max-width:600px){.map-fullscreen-btn{display:flex}}
    .map-is-fullscreen{position:fixed!important;inset:0!important;z-index:9999!important;height:100%!important;width:100%!important;border-radius:0!important}
    .map-is-fullscreen .map-fullscreen-btn{bottom:24px}
  </style>

  <link rel="stylesheet" href="shared-styles.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="shared-styles.css"></noscript>

  <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css"></noscript>
</head>

<body>
  <div class="page-shell">
    <div class="map-wrapper">
      <div class="map-card">

        <button id="announcementAlertBtn" class="announcement-alert-btn" type="button" aria-label="View announcement">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
        </button>

        <div id="siteBanner" class="site-banner"></div>

        <div class="brand-banner">
          <div class="brand-center">
            <img src="https://cms9files.revize.com/laplata/_assets_/images/logo.png" alt="La Plata County Logo" class="header-logo" width="180" height="auto" loading="eager" fetchpriority="high" decoding="async">
            <div class="brand-text">
              <div class="site-name">ReadyLaPlata</div>
              <div class="site-subtitle">La Plata County Evacuation Viewer</div>
            </div>
            <div class="official-badge">Official Emergency Information</div>
          </div>
          <div class="banner-nav nav-3-buttons">
            <button id="infoButton" class="nav-btn" type="button">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
              <span>Home</span>
            </button>
            <button id="overviewButton" class="nav-btn" type="button">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
              <span>Overview</span>
            </button>
            <button id="coderedButton" class="nav-btn" type="button">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
              <span>CodeRED</span>
            </button>
            <div class="nav-divider"></div>
            <div class="call-center-inline">
              <span class="call-label">Call Center:</span>
              <svg class="phone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
              <a href="tel:9703858700">970-385-8700</a>
            </div>
          </div>
        </div>

        <div class="content-overlap">
          <div class="incident-strip">
            <div class="incident-strip-top">
              <div class="incident-bar-left">
                <span class="incident-label">Active incidents <span id="incidentCountBadge" class="incident-count-badge">0</span></span>
              </div>
            </div>
            <div class="incident-tip">Tap an incident below to view the evacuation map.</div>
            <div id="incidentChips" class="incident-chips"></div>
            <div id="noIncidentsMsg" class="incident-none">
              <div class="incident-none-content">
                <div class="incident-none-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <div class="incident-none-text">
                  <div class="incident-none-title">No Active Incidents</div>
                  <p class="incident-none-body">No active evacuations in La Plata County.</p>
                </div>
              </div>
              <a href="#" id="noIncidentCodered" class="incident-none-cta-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                Sign up for CodeRED Alerts
              </a>
            </div>
          </div>

          <div class="card-divider"></div>
          <div id="viewDiv">
            <button id="mapFullscreenBtn" class="map-fullscreen-btn" type="button" aria-label="Toggle fullscreen">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/>
              </svg>
            </button>
          </div>

          <div class="map-key-merged">
            <div class="legend-title">Map Key</div>
            <div class="legend-items">
              <div class="legend-item"><span class="legend-icon-road"></span><span>Road closure</span></div>
              <div class="legend-item"><span class="legend-icon-info">i</span><span>Information</span></div>
              <div class="legend-item"><span class="legend-icon-warning"></span><span>Special warning</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <main>
      <div id="evacRow" class="evac-row">Loading evacuation information…</div>
      <div class="incident-panel">
        <div id="incidentPanel">Loading incident status…</div>
      </div>
    </main>
  </div>

  <!-- CodeRED Overlay -->
  <div id="coderedOverlay" class="codered-overlay" aria-hidden="true">
    <div class="codered-dialog" role="dialog" aria-modal="true" aria-labelledby="coderedTitle">
      <button id="coderedClose" class="codered-close" type="button" aria-label="Close">×</button>
      <h2 id="coderedTitle" class="codered-title">CodeRED Emergency Alerts</h2>
      <p class="codered-subtitle">Stay informed about wildfires, floods, and other emergencies in La Plata County.</p>
      <div class="codered-body">
        <p><strong>CodeRED</strong> is the official emergency alerting system used by La Plata County Office of Emergency Management (LPCOEM).</p>
        <p>You can receive notifications by text, phone call, and email about evacuation notices, road closures, and other time-sensitive information.</p>
      </div>
      <div class="codered-actions">
        <a href="https://accountportal.onsolve.net/lpcalerts" class="primary-pill" target="_blank" rel="noopener noreferrer">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Sign up on CodeRED
        </a>
        <button id="callerIdButton" class="secondary-pill" type="button">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
          Save CodeRED Caller ID
        </button>
      </div>
    </div>
  </div>

  <!-- Caller ID Help Overlay -->
  <div id="callerIdOverlay" class="callerid-overlay" aria-hidden="true">
    <div class="callerid-dialog" role="dialog" aria-modal="true" aria-labelledby="callerIdTitle">
      <button id="callerIdClose" class="callerid-close" type="button" aria-label="Close">×</button>
      
      <div class="callerid-header">
        <h2 id="callerIdTitle" class="callerid-title">Save CodeRED Caller ID</h2>
        <p class="callerid-subtitle">Prevent emergency alerts from being marked as spam</p>
      </div>
      
      <div class="callerid-body">
        <p class="callerid-intro">CodeRED alerts may be blocked by your phone's spam filter. Save these numbers as a contact to ensure you receive emergency notifications:</p>
        
        <div class="callerid-numbers">
          <div class="callerid-number-card">
            <div class="callerid-number-label">Text Messages</div>
            <div class="callerid-number-value">386-71</div>
          </div>
          <div class="callerid-number-card">
            <div class="callerid-number-label">Voice Calls</div>
            <div class="callerid-number-value">(206) 536-3695</div>
          </div>
        </div>
        
        <div class="callerid-download callerid-download--top">
          <button type="button" class="callerid-download-btn" onclick="ReadyLaPlata.downloadVCard()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
            Add to Contacts Automatically
          </button>
          <p class="callerid-download-hint"><strong>Tap 'CREATE NEW CONTACT' inside your phone's app</strong></p>
        </div>
        
        <div class="callerid-manual-divider">
          <span>or add manually</span>
        </div>
        
        <div class="callerid-tabs">
          <button class="callerid-tab is-active" data-tab="iphone" type="button">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
            iPhone
          </button>
          <button class="callerid-tab" data-tab="android" type="button">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 18c0 .55.45 1 1 1h1v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h2v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h1c.55 0 1-.45 1-1V8H6v10zM3.5 8C2.67 8 2 8.67 2 9.5v7c0 .83.67 1.5 1.5 1.5S5 17.33 5 16.5v-7C5 8.67 4.33 8 3.5 8zm17 0c-.83 0-1.5.67-1.5 1.5v7c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-7c0-.83-.67-1.5-1.5-1.5zm-4.97-5.84l1.3-1.3c.2-.2.2-.51 0-.71-.2-.2-.51-.2-.71 0l-1.48 1.48C13.85 1.23 12.95 1 12 1c-.96 0-1.86.23-2.66.63L7.85.15c-.2-.2-.51-.2-.71 0-.2.2-.2.51 0 .71l1.31 1.31C6.97 3.26 6 5.01 6 7h12c0-1.99-.97-3.75-2.47-4.84zM10 5H9V4h1v1zm5 0h-1V4h1v1z"/></svg>
            Android
          </button>
        </div>
        
        <div id="iphoneInstructions" class="callerid-instructions is-visible">
          <div class="callerid-instructions-title">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
            iPhone Instructions
          </div>
          <ol class="callerid-steps">
            <li>Open the <strong>Contacts</strong> app</li>
            <li>Tap the <strong>+</strong> button to create a new contact</li>
            <li>Enter <code>CodeRED Alerts</code> as the name</li>
            <li>Add phone number: <code>206-536-3695</code></li>
            <li>Tap <strong>add phone</strong> and enter: <code>386-71</code></li>
            <li>Tap <strong>Done</strong> to save the contact</li>
          </ol>
        </div>
        
        <div id="androidInstructions" class="callerid-instructions">
          <div class="callerid-instructions-title">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 18c0 .55.45 1 1 1h1v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h2v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h1c.55 0 1-.45 1-1V8H6v10zM3.5 8C2.67 8 2 8.67 2 9.5v7c0 .83.67 1.5 1.5 1.5S5 17.33 5 16.5v-7C5 8.67 4.33 8 3.5 8zm17 0c-.83 0-1.5.67-1.5 1.5v7c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-7c0-.83-.67-1.5-1.5-1.5zm-4.97-5.84l1.3-1.3c.2-.2.2-.51 0-.71-.2-.2-.51-.2-.71 0l-1.48 1.48C13.85 1.23 12.95 1 12 1c-.96 0-1.86.23-2.66.63L7.85.15c-.2-.2-.51-.2-.71 0-.2.2-.2.51 0 .71l1.31 1.31C6.97 3.26 6 5.01 6 7h12c0-1.99-.97-3.75-2.47-4.84zM10 5H9V4h1v1zm5 0h-1V4h1v1z"/></svg>
            Android Instructions
          </div>
          <ol class="callerid-steps">
            <li>Open the <strong>Contacts</strong> app</li>
            <li>Tap <strong>+</strong> or <strong>Create contact</strong></li>
            <li>Enter <code>CodeRED Alerts</code> as the name</li>
            <li>Add phone number: <code>206-536-3695</code></li>
            <li>Tap <strong>Add phone</strong> and enter: <code>386-71</code></li>
            <li>Tap the <strong>checkmark</strong> or <strong>Save</strong></li>
          </ol>
        </div>
        
        <div class="callerid-note">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          <span>Some carriers may still filter messages. Check your spam/blocked messages folder if you're not receiving alerts.</span>
        </div>
      </div>
      
      <div class="callerid-footer">
        <button id="callerIdDismiss" class="secondary-pill" type="button">Done</button>
      </div>
    </div>
  </div>

  <!-- Announcement Overlay (content loaded from announcement.json) -->
  <div id="announcementOverlay" class="announcement-overlay" aria-hidden="true">
    <div class="announcement-dialog" role="dialog" aria-modal="true" aria-labelledby="announcementTitle">
      <button id="announcementClose" class="announcement-close" type="button" aria-label="Close">×</button>
      <!-- Content injected by initAnnouncement() -->
    </div>
  </div>

  <script src="https://js.arcgis.com/4.31/" defer></script>
  <script src="shared.js"></script>
  <script>
  (function() {
    'use strict';

    const { $, escHTML, escapeQuery, createChip, sortIncidents, getIncidentParam, formatTimestamp, initCoderedOverlay, initCallerIdOverlay, initDrillBanner, initAnnouncement, BRAND } = ReadyLaPlata;

    // Configuration
    const CONFIG = {
      webmapId: '58a8bb313db64271a55e7960cb839f64',
      incidentLayerUrl: 'https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0',
      statusJsonUrl: 'incident.json',
      incidentField: 'incident',
      statusValues: { SET: 'Set', GO: 'Go' }
    };

    const STATUS_DATA = {
      SET: { label: 'SET - Pre-Evacuation', color: '#fff36a', text: 'Voluntary Evacuation;<br>Evacuation orders are likely' },
      GO: { label: 'GO - Evacuate Now', color: '#41f56e', text: '<strong>LEAVE NOW.</strong> Immediate threat to life.<br>This area is closed to public access.' }
    };

    const INCIDENT = getIncidentParam();
    if (INCIDENT) document.title = `${INCIDENT} — ReadyLaPlata`;

    // DOM cache
    const DOM = {
      siteBanner: $('siteBanner'),
      evacRow: $('evacRow'),
      incidentPanel: $('incidentPanel'),
      chipsEl: $('incidentChips'),
      countBadge: $('incidentCountBadge'),
      noIncidentsMsg: $('noIncidentsMsg'),
      noIncidentCodered: $('noIncidentCodered'),
      infoButton: $('infoButton'),
      overviewButton: $('overviewButton'),
      coderedButton: $('coderedButton'),
      coderedOverlay: $('coderedOverlay'),
      coderedClose: $('coderedClose'),
      callerIdButton: $('callerIdButton'),
      callerIdOverlay: $('callerIdOverlay'),
      callerIdClose: $('callerIdClose'),
      announcementOverlay: $('announcementOverlay'),
      announcementClose: $('announcementClose'),
      announcementDismiss: $('announcementDismiss'),
      announcementAlertBtn: $('announcementAlertBtn')
    };

    // Initialize Caller ID tab switching
    function initCallerIdTabs() {
      const tabs = document.querySelectorAll('.callerid-tab');
      const iphoneInstructions = $('iphoneInstructions');
      const androidInstructions = $('androidInstructions');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('is-active'));
          tab.classList.add('is-active');
          
          const tabName = tab.dataset.tab;
          if (tabName === 'iphone') {
            iphoneInstructions?.classList.add('is-visible');
            androidInstructions?.classList.remove('is-visible');
          } else {
            iphoneInstructions?.classList.remove('is-visible');
            androidInstructions?.classList.add('is-visible');
          }
        });
      });
      
      // Dismiss button
      $('callerIdDismiss')?.addEventListener('click', () => {
        DOM.callerIdOverlay?.classList.remove('is-open');
        DOM.callerIdOverlay?.setAttribute('aria-hidden', 'true');
      });
    }

    // HTML Builders
    const buildBox = (statusCode, features) => {
      const data = STATUS_DATA[statusCode];
      const hasFeatures = features?.length > 0;
      
      const zonesHTML = hasFeatures
        ? `<div class="evac-zones">${features.map(f => `<div class="zone-chip">${escHTML(f?.attributes?.zonename)}</div>`).join('')}</div>`
        : `<div class="evac-zones"><div class="no-zones-chip">No ${statusCode} zones</div></div>`;

      const boxClass = statusCode === 'GO' ? ' evac-box-go' : statusCode === 'SET' ? ' evac-box-set' : '';

      return `<div class="evac-box${boxClass}" style="background:${data.color}">
        <div class="evac-title">${data.label}</div>
        <div class="evac-body">
          <div>The following zones are under ${statusCode} status for <strong>${INCIDENT ? escHTML(INCIDENT) : 'this incident'}</strong>.</div>
          ${zonesHTML}
          <div class="evac-note">${data.text}</div>
        </div>
      </div>`;
    };

    const showHelp = () => {
      DOM.evacRow.innerHTML = `<div class="evac-box" style="background:#f3f4f6">
        <div class="evac-title">How to use this page</div>
        <div class="evac-body">
          <div>This evacuation information requires an <strong>incident name</strong> in the URL.</div>
          <div style="margin-top:8px">Use this format:<br><code>?incident=YourIncidentName</code></div>
        </div>
      </div>`;

      DOM.incidentPanel.innerHTML = `<div class="evac-box" style="background:#f3f4f6">
        <div class="evac-title">Incident status</div>
        <div class="evac-body"><div>No incident was specified.</div></div>
      </div>`;
    };

    const showError = msg => {
      DOM.evacRow.innerHTML = `<div class="evac-box" style="background:#fff36a">
        <div class="evac-title">Error</div>
        <div class="evac-body">${escHTML(msg)}</div>
      </div>`;
    };

    // Data Loading
    async function loadEvacuationZones() {
      if (!INCIDENT) { showHelp(); return; }

      const where = `incident='${escapeQuery(INCIDENT)}' AND STATUS IN ('${CONFIG.statusValues.SET}','${CONFIG.statusValues.GO}')`;
      const params = new URLSearchParams({ where, outFields: '*', f: 'json', returnGeometry: 'false' });

      try {
        const res = await fetch(`${CONFIG.incidentLayerUrl}/query?${params}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data.features?.length) {
          DOM.evacRow.innerHTML = `<div class="evac-box" style="background:#f3f4f6">
            <div class="evac-title">No Active Zones</div>
            <div class="evac-body">
              <div>No evacuation zones are currently active for <strong>${escHTML(INCIDENT)}</strong>.</div>
              <div style="margin-top:12px"><a href="overview.html" class="primary-pill" style="text-decoration:none;">View All Active Incidents</a></div>
            </div>
          </div>`;
          return;
        }

        const setFeatures = [], goFeatures = [];
        for (const f of data.features) {
          if (f.attributes.STATUS === CONFIG.statusValues.SET) setFeatures.push(f);
          else if (f.attributes.STATUS === CONFIG.statusValues.GO) goFeatures.push(f);
        }
        DOM.evacRow.innerHTML = buildBox('SET', setFeatures) + buildBox('GO', goFeatures);
      } catch (err) {
        console.error('Error loading evacuation zones:', err);
        showError(`Failed to load evacuation data: ${err.message}`);
      }
    }

    // Status Card Builder (simplified - uses BRAND from shared)
    function buildStatusCard(data) {
      const esc = s => String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      const str = v => String(v || '').trim();

      const normalizeUrl = url => {
        url = str(url);
        if (!url) return '';
        if (/^https?:\/\//i.test(url)) return url;
        return 'https://' + url;
      };

      const formatSection = raw => {
        raw = str(raw);
        if (!raw) return `<span style="color:#64748b;font-style:italic;">No information available.</span>`;
        const lines = raw.split(/\n+/);
        const name = lines.shift().trim();
        const rest = lines.join('\n').trim();
        return `${name ? `<div style="font-weight:700;color:${BRAND.textHeading};">${esc(name)}</div>` : ''}
          ${rest ? `<div style="margin-top:4px;color:#334155;">${esc(rest).replace(/\n/g,'<br>')}</div>` : ''}`;
      };

      const directionsList = addr => {
        addr = str(addr);
        if (!addr) return '';
        const items = addr.split(/[\n;]+/).map(a => a.trim()).filter(Boolean);
        return `<div style="display:flex;flex-wrap:wrap;gap:4px;">${items.map(a => 
          `<a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(a)}" target="_blank" rel="noopener noreferrer" class="dir-btn" style="display:inline-flex;align-items:center;padding:6px 10px;border:2px solid ${BRAND.blue};border-radius:8px;background:#fff;color:${BRAND.blue};font-size:13px;font-weight:600;text-decoration:none;">${esc(a)}</a>`
        ).join('')}</div>`;
      };

      const addressBlock = addr => {
        const list = directionsList(addr);
        return list ? `<div style="margin-top:10px;padding-top:10px;border-top:1px dashed rgba(0,0,0,0.1);"><div style="font-size:11px;font-weight:600;color:#64748b;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:6px;">Directions</div>${list}</div>` : '';
      };

      const roadContent = val => {
        val = str(val);
        if (!val) return `<span style="color:#64748b;font-style:italic;">No road closures reported.</span>`;
        const list = val.split(/\n+/).map(l => l.trim()).filter(Boolean);
        return list.length === 1 ? `<div>${esc(list[0])}</div>` : `<ul style="margin:0;padding-left:20px;">${list.map(l => `<li style="margin-bottom:4px;">${esc(l)}</li>`).join('')}</ul>`;
      };

      const sectionCard = (icon, title, body) => `
        <div style="background:${BRAND.grayLight};border:1px solid ${BRAND.border};border-radius:12px;padding:14px 16px;margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
            <div style="width:32px;height:32px;display:flex;align-items:center;justify-content:center;">${icon}</div>
            <h3 style="margin:0;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;">${esc(title)}</h3>
          </div>
          <div style="margin-left:42px;font-size:14px;line-height:1.6;color:#334155;">${body}</div>
        </div>`;

      const animalSubCard = (label, value, addr) => `
        <div style="background:#ffffff;border:1px solid ${BRAND.border};border-radius:8px;padding:10px 12px;">
          <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:${BRAND.textMuted};margin-bottom:4px;">${esc(label)}</div>
          <div style="font-size:14px;line-height:1.6;color:#334155;">${formatSection(value)}${addressBlock(addr)}</div>
        </div>`;

      // Icons
      const icons = {
        info: '<svg width="20" height="20" fill="none" stroke="#000" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
        location: '<svg width="20" height="20" fill="none" stroke="#000" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a2 2 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>',
        shelter: '<svg width="20" height="20" fill="none" stroke="#000" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>',
        road: '<svg width="20" height="20" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" fill="#000"/><rect x="6" y="11" width="12" height="2" fill="#fff" rx="1"/></svg>',
        paw: '<svg width="20" height="20" viewBox="0 0 512 512" fill="#000"><path d="M226.5 92.9c14.3 42.9-.3 86.2-32.6 96.8s-70.1-15.6-84.4-58.5s.3-86.2 32.6-96.8s70.1 15.6 84.4 58.5zM100.4 198.6c18.9 32.4 14.3 70.1-10.2 84.1s-59.7-.9-78.5-33.3S-2.7 179.3 21.8 165.3s59.7 .9 78.5 33.3zM69.2 401.2C121.6 259.9 214.7 224 256 224s134.4 35.9 186.8 177.2c3.6 9.7 5.2 20.1 5.2 30.5v1.6c0 25.8-20.9 46.7-46.7 46.7c-11.5 0-22.9-1.4-34-4.2l-88-22c-15.3-3.8-31.3-3.8-46.6 0l-88 22c-11.1 2.8-22.5 4.2-34 4.2C84.9 480 64 459.1 64 433.3v-1.6c0-10.4 1.6-20.8 5.2-30.5zM421.8 282.7c-24.5-14-29.1-51.7-10.2-84.1s54-47.3 78.5-33.3s29.1 51.7 10.2 84.1s-54 47.3-78.5 33.3zM310.1 189.7c-32.3-10.6-46.9-53.9-32.6-96.8s52.1-69.1 84.4-58.5s46.9 53.9 32.6 96.8s-52.1 69.1-84.4 58.5z"/></svg>'
      };

      const normalizedLink = normalizeUrl(data.statusLink);

      return `<style>.status-btn:hover,.dir-btn:hover{background:${BRAND.blue}!important;color:#fff!important;}</style>
        <div style="font-family:Arial,sans-serif;background:#fff;border-radius:14px;border:1px solid ${BRAND.border};box-shadow:0 2px 10px rgba(0,0,0,0.25);overflow:hidden;">
          <div style="padding:14px 18px;background:#fff;border-bottom:1px solid ${BRAND.borderLight};display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
            <div style="display:flex;align-items:center;gap:10px;">
              <div style="width:36px;height:36px;border-radius:50%;background:#f8fafc;display:flex;align-items:center;justify-content:center;">${icons.info}</div>
              <div style="font-size:17px;font-weight:700;">Incident Support Resources</div>
            </div>
            ${normalizedLink ? `<a href="${normalizedLink}" target="_blank" rel="noopener noreferrer" class="status-btn" style="display:inline-flex;padding:8px 16px;border:2px solid ${BRAND.blue};border-radius:8px;background:#fff;color:${BRAND.blue};font-size:14px;font-weight:600;text-decoration:none;">View Status Update</a>` : ''}
          </div>
          <div style="padding:16px 18px 18px;">
            ${sectionCard(icons.location, 'Check-in Location', formatSection(data.checkIn) + addressBlock(data.checkInAddr))}
            ${sectionCard(icons.shelter, 'Evacuation Shelters', formatSection(data.shelters) + addressBlock(data.sheltersAddr))}
            ${sectionCard(icons.road, 'Road Closures', roadContent(data.road))}
            <div style="background:${BRAND.grayLight};border:1px solid ${BRAND.border};border-radius:12px;padding:14px 16px;">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                <div style="width:32px;height:32px;display:flex;align-items:center;justify-content:center;">${icons.paw}</div>
                <h3 style="margin:0;font-size:14px;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;">Animal Evacuation</h3>
              </div>
              <div style="margin-left:42px;display:grid;gap:10px;">
                ${animalSubCard('Small Animals', data.smallAnimals, data.smallAnimalsAddr)}
                ${animalSubCard('Large Animals', data.largeAnimals, data.largeAnimalsAddr)}
              </div>
            </div>
          </div>
        </div>`;
    }

    async function loadIncidentStatus() {
      if (!INCIDENT) return;

      try {
        const res = await fetch(CONFIG.statusJsonUrl);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const incidents = await res.json();

        const incidentLower = INCIDENT.toLowerCase();
        const data = incidents.find(inc => inc.name && inc.name.toLowerCase() === incidentLower);

        if (!data) {
          DOM.incidentPanel.innerHTML = `<div class="status-html">
            <div class="status-card status-card-empty">
              <h2 class="status-card-title">No Status Information</h2>
              <p>No detailed status information is currently available for <strong>${escHTML(INCIDENT)}</strong>.</p>
            </div>
          </div>
          <div class="status-timestamp">Last loaded: ${formatTimestamp()} &nbsp;•&nbsp; <span class="source-label">Source: La Plata County Office of Emergency Management</span></div>`;
          return;
        }

        DOM.incidentPanel.innerHTML = `<div class="status-html">${buildStatusCard(data)}</div>
          <div class="status-timestamp">Last loaded: ${formatTimestamp()} &nbsp;•&nbsp; <span class="source-label">Source: La Plata County Office of Emergency Management</span></div>`;
      } catch (err) {
        console.error('Error loading incident status:', err);
        DOM.incidentPanel.textContent = 'Error loading incident status.';
      }
    }

    // Map view reference for fullscreen toggle
    let mapView = null;

    // Map Initialization
    function initMap() {
      if (typeof require === 'undefined') {
        setTimeout(initMap, 100);
        return;
      }

      require([
        'esri/WebMap', 'esri/views/MapView', 'esri/layers/FeatureLayer',
        'esri/widgets/Search', 'esri/widgets/Fullscreen', 'esri/widgets/Locate'
      ], (WebMap, MapView, FeatureLayer, Search, Fullscreen, Locate) => {

        DOM.infoButton?.addEventListener('click', () => location.href = 'index.html');
        DOM.overviewButton?.addEventListener('click', () => location.href = 'overview.html');

        const webmap = new WebMap({ portalItem: { id: CONFIG.webmapId } });
        const view = new MapView({
          container: 'viewDiv',
          map: webmap,
          constraints: {
            rotationEnabled: false
          }
        });

        // Store reference for fullscreen toggle
        mapView = view;

        if (window.innerWidth < 700 && view.navigation) {
          view.navigation.mouseWheelZoomEnabled = false;
          view.navigation.browserTouchPanEnabled = false;
        }

        const incidentLayer = new FeatureLayer({
          url: CONFIG.incidentLayerUrl,
          outFields: ['*'],
          visible: false,
          listMode: 'hide'
        });
        webmap.add(incidentLayer);

        const zoomToIncident = name => {
          incidentLayer.queryExtent({ where: `${CONFIG.incidentField} = '${escapeQuery(name)}'` })
            .then(res => res.extent && view.goTo(res.extent.expand(1.2)))
            .catch(console.error);
        };

        view.when()
          .then(() => {
            // Add widgets
            view.ui.add(new Locate({ view }), 'top-left');
            view.ui.add(new Search({ view, includeDefaultSources: true }), 'top-right');
            view.ui.add(new Fullscreen({ view }), 'top-right');
            return incidentLayer.when();
          })
          .then(() => incidentLayer.queryFeatures({
            where: '1=1',
            outFields: [CONFIG.incidentField],
            returnDistinctValues: true,
            orderByFields: [CONFIG.incidentField]
          }))
          .then(fs => {
            const names = (fs.features || []).map(f => f.attributes[CONFIG.incidentField]).filter(Boolean);

            DOM.countBadge.textContent = names.length;
            if (names.length) DOM.countBadge.classList.add('has-incidents');
            else { DOM.noIncidentsMsg.classList.add('is-visible'); return; }
            DOM.noIncidentsMsg.classList.remove('is-visible');

            sortIncidents(names, INCIDENT);

            const frag = document.createDocumentFragment();
            for (const name of names) {
              frag.appendChild(createChip(name, () => {
                const url = new URL(location.href);
                url.searchParams.set('incident', name);
                location.href = url;
              }));
            }
            DOM.chipsEl.appendChild(frag);

            if (INCIDENT) {
              const match = DOM.chipsEl.querySelector(`[data-incident="${INCIDENT}"]`);
              if (match) {
                match.classList.add('active');
                zoomToIncident(INCIDENT);
              }
            }
          })
          .catch(err => {
            console.error('Error loading incidents:', err);
            DOM.countBadge.textContent = '0';
          });
      });
    }

    // Mobile fullscreen toggle
    function initMobileFullscreen() {
      const btn = $('mapFullscreenBtn');
      const viewDiv = $('viewDiv');
      if (!btn || !viewDiv) return;

      const expandIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>';
      const collapseIcon = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" y1="10" x2="21" y2="3"/><line x1="3" y1="21" x2="10" y2="14"/></svg>';

      btn.addEventListener('click', () => {
        const isFullscreen = viewDiv.classList.toggle('map-is-fullscreen');
        btn.innerHTML = isFullscreen ? collapseIcon : expandIcon;
        document.body.style.overflow = isFullscreen ? 'hidden' : '';
        
        // Enable/disable single-finger panning based on fullscreen state
        if (mapView && mapView.navigation) {
          mapView.navigation.browserTouchPanEnabled = isFullscreen;
        }
      });
    }

    // Initialize
    initCoderedOverlay(DOM);
    initCallerIdOverlay(DOM);
    initCallerIdTabs();
    initDrillBanner(DOM);
    initAnnouncement(DOM);
    initMobileFullscreen();
    loadEvacuationZones();
    loadIncidentStatus();
    initMap();
  })();
  </script>
</body>
</html>
