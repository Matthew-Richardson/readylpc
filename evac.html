<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReadyLaPlata — La Plata County Evacuation Viewer</title>
  
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta name="description" content="Official evacuation information and interactive maps for La Plata County, Colorado. View active incidents, evacuation zones, and sign up for emergency alerts.">
  <meta name="theme-color" content="#0b4da2">
  
  <meta property="og:title" content="ReadyLaPlata — La Plata County Evacuation Viewer">
  <meta property="og:description" content="Official evacuation information and interactive maps for La Plata County, Colorado. View active incidents and evacuation zones.">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="en_US">
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ReadyLaPlata — La Plata County Evacuation Viewer">
  <meta name="twitter:description" content="Official evacuation information for La Plata County, Colorado.">

  <link rel="dns-prefetch" href="//js.arcgis.com">
  <link rel="dns-prefetch" href="//services2.arcgis.com">
  <link rel="dns-prefetch" href="//cms9files.revize.com">
  <link rel="preconnect" href="https://js.arcgis.com" crossorigin>
  <link rel="preconnect" href="https://services2.arcgis.com" crossorigin>

  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;font-family:Arial,sans-serif;background:#f5f5f7;font-size:18px;overflow-x:hidden;color:#000}
    .page-shell{min-height:100vh;display:flex;flex-direction:column}
    .map-wrapper{max-width:900px;width:100%;margin:16px auto 0;padding:12px}
    .map-card{width:100%;border-radius:14px;border:1px solid rgba(0,0,0,0.15);box-shadow:0 4px 20px rgba(0,0,0,0.12);overflow:hidden;background:#fff;display:flex;flex-direction:column}
    #viewDiv{width:100%;height:clamp(400px, 55vh, 550px);background:#e5e5e5}
  </style>

  <link rel="stylesheet" href="shared-styles.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="shared-styles.css"></noscript>

  <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css"></noscript>
</head>

<body>
  <div class="page-shell">
    <div class="map-wrapper">
      <div class="map-card">

        <!-- Announcement Alert Button - appears in upper right when active -->
        <button id="announcementAlertBtn" class="announcement-alert-btn" type="button" aria-label="View announcement">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
        </button>

        <!-- Site Banner: Leave empty to hide, add text to display -->
        <div id="siteBanner" class="site-banner"></div>

        <div class="brand-banner">
          <div class="brand-center">
            <img src="https://cms9files.revize.com/laplata/_assets_/images/logo.png" alt="La Plata County Logo" class="header-logo" width="180" height="auto" loading="eager" fetchpriority="high" decoding="async">
            <div class="brand-text">
              <div class="site-name">ReadyLaPlata</div>
              <div class="site-subtitle">La Plata County Evacuation Viewer</div>
            </div>
            <div class="official-badge">Official Emergency Information</div>
          </div>
          <div class="banner-nav nav-3-buttons">
            <button id="infoButton" class="nav-btn" type="button" aria-label="Home">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
              <span>Home</span>
            </button>
            <button id="overviewButton" class="nav-btn" type="button" aria-label="Overview Map">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
              <span>Overview</span>
            </button>
            <button id="coderedButton" class="nav-btn" type="button" aria-label="CodeRED Alerts">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
              <span>CodeRED</span>
            </button>
            <div class="nav-divider"></div>
            <div class="call-center-inline">
              <span class="call-label">Call Center:</span>
              <svg class="phone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
              <a href="tel:9703858700">970-385-8700</a>
            </div>
          </div>
        </div>

        <div class="content-overlap"><div class="incident-strip">
          <div class="incident-strip-top">
            <div class="incident-bar-left">
              <span class="incident-label">
                Active incidents
                <span id="incidentCountBadge" class="incident-count-badge">0</span>
              </span>
            </div>
          </div>
          <div class="incident-tip">Tap an incident below to view the evacuation map.</div>
          <div id="incidentChips" class="incident-chips"></div>
          <div id="noIncidentsMsg" class="incident-none">
            <div class="incident-none-content">
              <div class="incident-none-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
              </div>
              <div class="incident-none-text">
                <div class="incident-none-title">No Active Incidents</div>
                <p class="incident-none-body">No active evacuations in La Plata County.</p>
              </div>
            </div>
            <a href="#" id="noIncidentCodered" class="incident-none-cta-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
              Sign up for CodeRED Alerts
            </a>
          </div>
        </div>

        <div class="card-divider"></div>
        <div id="viewDiv"></div>

        <div class="map-key-merged">
          <div class="legend-title">Map Key</div>
          <div class="legend-items">
            <div class="legend-item"><span class="legend-icon-road"></span><span>Road closure</span></div>
            <div class="legend-item"><span class="legend-icon-info">i</span><span>Information</span></div>
            <div class="legend-item"><span class="legend-icon-warning"></span><span>Special warning</span></div>
          </div>
        </div>
        </div><!-- end content-overlap -->
      </div>
    </div>

    <main>
      <div id="evacRow" class="evac-row">Loading evacuation information…</div>
      <div class="incident-panel">
        <div id="incidentPanel">Loading incident status…</div>
      </div>
    </main>
  </div>

  <div id="coderedOverlay" class="codered-overlay" aria-hidden="true">
    <div class="codered-dialog" role="dialog" aria-modal="true" aria-labelledby="coderedTitle">
      <button id="coderedClose" class="codered-close" type="button" aria-label="Close CodeRED info">×</button>
      <h2 id="coderedTitle" class="codered-title">CodeRED Emergency Alerts</h2>
      <p class="codered-subtitle">Stay informed about wildfires, floods, and other emergencies in La Plata County.</p>
      <div class="codered-body">
        <p><strong>CodeRED</strong> is the official emergency alerting system used by La Plata County Office of Emergency Management (LPCOEM).</p>
        <p>You can receive notifications by text, phone call, and email about evacuation notices, road closures, and other time-sensitive information.</p>
      </div>
      <div class="codered-actions">
        <a href="https://identityservice.onsolve.net/SignIn?ReturnUrl=%2Fconnect%2Fauthorize%2Fcallback%3Fclient_id%3Dself-registration-user%26redirect_uri%3Dhttps%253A%252F%252Faccountportal.onsolve.net%252Fidentity%252Fsignin%252Fcallback%26response_type%3Dcode%26scope%3Dopenid%2520profile%2520onsolve-selfregistration-api%2520openid%2520profile%26state%3D85a9ec83f55a4afea5a0380232f88694_eyJwb3J0YWxVcmwiOiIvbHBjYWxlcnRzIn0%253D%26code_challenge%3DRYhfdUsw4RIs8t0X7Krl-sRnm_aB6kL89QgYzYy_Ea8%26code_challenge_method%3DS256%26response_mode%3Dquery%26branding_descriptor%3DeyJwb3J0YWxJZCI6NTM1MX0%253D%26organization_uuid%3D9f2d09f5-273c-465d-a5d8-993d5e9d88f4%26division_uuid%3D009d9956-000e-3000-80c0-fceb55463ffe%26ui_lang%3Den-US%26origin%3Dhttps%253A%252F%252Faccountportal.onsolve.net%252Flpcalerts" class="primary-pill" target="_blank" rel="noopener noreferrer">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Sign up on CodeRED
        </a>
      </div>
    </div>
  </div>

  <!-- ========== ANNOUNCEMENT OVERLAY ========== -->
  <!-- Set SHOW_ANNOUNCEMENT to true to display on page load, false to hide -->
  <div id="announcementOverlay" class="announcement-overlay" aria-hidden="true">
    <div class="announcement-dialog" role="dialog" aria-modal="true" aria-labelledby="announcementTitle">
      <button id="announcementClose" class="announcement-close" type="button" aria-label="Close">×</button>
      
      <div class="announcement-header">
        <img src="https://cms9files.revize.com/laplata/_assets_/images/logo.png" alt="La Plata County Logo" class="announcement-logo">
        <div class="announcement-header-text">
          <h2 id="announcementTitle" class="announcement-title">CodeRED Security Update</h2>
          <p class="announcement-subtitle">Important information about your alert account</p>
        </div>
        <div class="announcement-badge">Official Notice</div>
      </div>
      
      <div class="announcement-body">
        <div class="announcement-content">
          <p>We are reaching out to share an important update regarding the security of our alert system <strong>CodeRED</strong>.</p>
          
          <p>Out of an abundance of caution, <strong>we recommend that all users who currently have an account change their password</strong>. Updating your password helps ensure your information remains secure and protected.</p>
          
          <p>Some individuals receive alerts through CodeRED without having an online account. If you are one of these legacy users, no immediate action is required. However, if you would like to view, update, or manage your information, you can do so by creating an account at any time.</p>
          
          <p>Creating an account allows you to:</p>
          <ul class="announcement-list">
            <li>Review and update your contact information</li>
            <li>Manage alert preferences</li>
            <li>Ensure your information stays current</li>
          </ul>
          
          <div class="announcement-contact">
            <div class="announcement-contact-title">Questions or Need Assistance?</div>
            <div class="announcement-contact-row">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
              <a href="/cdn-cgi/l/email-protection#68272d252d2b2b2804180b0f071e46071a0f"><span class="__cf_email__" data-cfemail="eda2a8a0a8aeaead819d8e8a829bc3829f8a">[email&#160;protected]</span></a>
            </div>
            <div class="announcement-contact-row">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
              <a href="tel:9703826275">970-382-6275</a>
            </div>
          </div>
        </div>
      </div>
      
      <div class="announcement-footer">
        <a href="https://identityservice.onsolve.net/SignIn?ReturnUrl=%2Fconnect%2Fauthorize%2Fcallback%3Fclient_id%3Dself-registration-user%26redirect_uri%3Dhttps%253A%252F%252Faccountportal.onsolve.net%252Fidentity%252Fsignin%252Fcallback%26response_type%3Dcode%26scope%3Dopenid%2520profile%2520onsolve-selfregistration-api%2520openid%2520profile%26state%3D85a9ec83f55a4afea5a0380232f88694_eyJwb3J0YWxVcmwiOiIvbHBjYWxlcnRzIn0%253D%26code_challenge%3DRYhfdUsw4RIs8t0X7Krl-sRnm_aB6kL89QgYzYy_Ea8%26code_challenge_method%3DS256%26response_mode%3Dquery%26branding_descriptor%3DeyJwb3J0YWxJZCI6NTM1MX0%253D%26organization_uuid%3D9f2d09f5-273c-465d-a5d8-993d5e9d88f4%26division_uuid%3D009d9956-000e-3000-80c0-fceb55463ffe%26ui_lang%3Den-US%26origin%3Dhttps%253A%252F%252Faccountportal.onsolve.net%252Flpcalerts" class="primary-pill" target="_blank" rel="noopener noreferrer">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Manage My CodeRED Account
        </a>
        <button id="announcementDismiss" class="secondary-pill" type="button">
          I'll do this later
        </button>
      </div>
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://js.arcgis.com/4.31/" defer></script>

  <script>
  (function() {
    'use strict';

    // ========== CONFIGURATION ==========
    const CONFIG = {
      webmapId: '58a8bb313db64271a55e7960cb839f64',
      incidentLayerUrl: 'https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0',
      // JSON file path - update this when moving to IIS server
      statusJsonUrl: 'incident.json',
      incidentField: 'incident',
      statusValues: { SET: 'Set', GO: 'Go' }
    };

    // ========== ANNOUNCEMENT TOGGLE ==========
    // SHOW_ANNOUNCEMENT: shows the bell icon when true
    // AUTO_OPEN_ANNOUNCEMENT: auto-opens the popup on page load when true
    const SHOW_ANNOUNCEMENT = true;
    const AUTO_OPEN_ANNOUNCEMENT = false;

    const STATUS_DATA = {
      SET: { label: 'SET - Pre-Evacuation', color: '#fff36a', text: 'Voluntary Evacuation;<br>Evacuation orders are likely' },
      GO: { label: 'GO - Evacuate Now', color: '#41f56e', text: '<strong>LEAVE NOW.</strong> Immediate threat to life.<br>This area is closed to public access.' }
    };

    // ========== DOM CACHE ==========
    const $ = id => document.getElementById(id);
    const DOM = {};

    // ========== URL PARAMETER (computed once) ==========
    const INCIDENT = (() => {
      const params = new URLSearchParams(location.search);
      const inc = (params.get('incident') || params.get('Incident') || '').trim();
      if (inc) document.title = `${inc} — ReadyLaPlata`;
      return inc || null;
    })();

    // ========== UTILITIES ==========
    const escapeQuery = s => s.replace(/'/g, "''");

    const sortIncidents = (names, target) => {
      const targetLower = target?.toLowerCase();
      return names.sort((a, b) => {
        const al = a.toLowerCase(), bl = b.toLowerCase();
        if (targetLower) {
          if (al === targetLower) return -1;
          if (bl === targetLower) return 1;
        }
        return al.localeCompare(bl);
      });
    };

    const createChip = (name, onClick) => {
      const chip = document.createElement('button');
      chip.className = 'incident-chip';
      chip.dataset.incident = name;
      chip.innerHTML = `<span class="incident-chip-icon">!</span><span>${name}</span>`;
      chip.addEventListener('click', onClick);
      return chip;
    };

    // ========== HTML BUILDERS ==========
    const buildBox = (statusCode, features) => {
      const data = STATUS_DATA[statusCode];
      const hasFeatures = features?.length > 0;
      
      const zonesHTML = hasFeatures
        ? `<div class="evac-zones">${features.map(f => `<div class="zone-chip">${f.attributes.zonename}</div>`).join('')}</div>`
        : `<div class="evac-zones"><div class="no-zones-chip">No ${statusCode} zones</div></div>`;

      const boxClass = statusCode === 'GO' ? ' evac-box-go' : statusCode === 'SET' ? ' evac-box-set' : '';

      return `<div class="evac-box${boxClass}" style="background:${data.color}">
        <div class="evac-title">${data.label}</div>
        <div class="evac-body">
          <div>The following zones are under ${statusCode} status for <strong>${INCIDENT || 'this incident'}</strong>.</div>
          ${zonesHTML}
          <div class="evac-note">${data.text}</div>
        </div>
      </div>`;
    };

    const showHelp = () => {
      DOM.evacRow.innerHTML = `<div class="evac-box" style="background:#f3f4f6">
        <div class="evac-title">How to use this page</div>
        <div class="evac-body">
          <div>This evacuation information requires an <strong>incident name</strong> in the URL.</div>
          <div style="margin-top:8px">Use this format:<br><code>?incident=YourIncidentName</code></div>
          <div style="margin-top:8px">Example:<br><code>?incident=East%20Canyon</code></div>
        </div>
      </div>`;

      DOM.incidentPanel.innerHTML = `<div class="evac-box" style="background:#f3f4f6">
        <div class="evac-title">Incident status</div>
        <div class="evac-body">
          <div>No incident was specified.</div>
          <div style="margin-top:8px">Append <code>?incident=YourIncidentName</code> to the URL.</div>
        </div>
      </div>`;
    };

    const showError = msg => {
      DOM.evacRow.innerHTML = `<div class="evac-box" style="background:#fff36a">
        <div class="evac-title">Error</div>
        <div class="evac-body">${msg}</div>
      </div>`;
    };

    // ========== DATA FETCHING ==========
    async function loadEvacuationZones() {
      if (!INCIDENT) { showHelp(); return; }

      const where = `incident='${escapeQuery(INCIDENT)}' AND STATUS IN ('${CONFIG.statusValues.SET}','${CONFIG.statusValues.GO}')`;
      const params = new URLSearchParams({ where, outFields: '*', f: 'json', returnGeometry: 'false' });

      try {
        const res = await fetch(`${CONFIG.incidentLayerUrl}/query?${params}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data.features?.length) {
          DOM.evacRow.innerHTML = `<div class="evac-box" style="background:#f3f4f6">
            <div class="evac-title">No Active Zones</div>
            <div class="evac-body">
              <div>No evacuation zones are currently active for <strong>${INCIDENT}</strong>.</div>
              <div style="margin-top:12px">This incident may have ended or the name may have changed.</div>
              <div style="margin-top:12px"><a href="overview.html" class="primary-pill" style="text-decoration:none;">View All Active Incidents</a></div>
            </div>
          </div>`;
          return;
        }

        const setFeatures = [], goFeatures = [];
        for (const f of data.features) {
          if (f.attributes.STATUS === CONFIG.statusValues.SET) setFeatures.push(f);
          else if (f.attributes.STATUS === CONFIG.statusValues.GO) goFeatures.push(f);
        }
        DOM.evacRow.innerHTML = buildBox('SET', setFeatures) + buildBox('GO', goFeatures);
      } catch (err) {
        console.error('Error loading evacuation zones:', err);
        showError(`Failed to load evacuation data: ${err.message}`);
      }
    }

    // ========== BUILD STATUS CARD HTML FROM JSON ==========
    function buildStatusCard(data) {
      // Format multi-line text (e.g., road closures, check-in info)
      const formatMultiline = (text) => {
        if (!text) return '<span class="no-data">—</span>';
        return text.split('\n').map(line => `<div>${line}</div>`).join('');
      };

      // Build Google Maps link
      const mapsLink = (addr) => {
        if (!addr) return '';
        return `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}" target="_blank" rel="noopener noreferrer" class="maps-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          Map
        </a>`;
      };

      return `
        <div class="status-card">
          <h2 class="status-card-title">${data.name || 'Incident Information'}</h2>
          
          ${data.statusLink ? `
          <div class="status-row status-link-row">
            <span class="status-label">Status Updates:</span>
            <a href="https://${data.statusLink}" target="_blank" rel="noopener noreferrer">${data.statusLink}</a>
          </div>` : ''}

          <div class="status-section">
            <h3 class="status-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18" height="18"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
              Check-In / Registration
            </h3>
            <div class="status-row">
              <span class="status-value">${formatMultiline(data.checkIn)}</span>
              ${mapsLink(data.checkInAddr)}
            </div>
          </div>

          <div class="status-section">
            <h3 class="status-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18" height="18"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
              Shelters
            </h3>
            <div class="status-row">
              <span class="status-value">${data.shelters || '<span class="no-data">—</span>'}</span>
              ${mapsLink(data.sheltersAddr)}
            </div>
          </div>

          ${data.road ? `
          <div class="status-section">
            <h3 class="status-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18" height="18"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
              Road Closures
            </h3>
            <div class="status-row">
              <span class="status-value">${formatMultiline(data.road)}</span>
            </div>
          </div>` : ''}

          <div class="status-section">
            <h3 class="status-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18" height="18"><path d="M10 5.172C10 3.782 8.423 2.679 6.5 3c-2.823.47-4.113 6.006-4 7 .08.703 1.725 1.722 3.656 1 1.261-.472 1.96-1.45 2.344-2.5"/><path d="M14.267 5.172c0-1.39 1.577-2.493 3.5-2.172 2.823.47 4.113 6.006 4 7-.08.703-1.725 1.722-3.656 1-1.261-.472-1.855-1.45-2.239-2.5"/><path d="M8 14v.5"/><path d="M16 14v.5"/><path d="M11.25 16.25h1.5L12 17l-.75-.75z"/><path d="M4.42 11.247A13.152 13.152 0 0 0 4 14.556C4 18.728 7.582 21 12 21s8-2.272 8-6.444c0-1.061-.162-2.2-.493-3.309m-9.243-6.082A8.801 8.801 0 0 1 12 5c.78 0 1.5.108 2.161.306"/></svg>
              Small Animals
            </h3>
            <div class="status-row">
              <span class="status-value">${data.smallAnimals || '<span class="no-data">—</span>'}</span>
              ${mapsLink(data.smallAnimalsAddr)}
            </div>
          </div>

          <div class="status-section">
            <h3 class="status-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18" height="18"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
              Large Animals / Livestock
            </h3>
            <div class="status-row">
              <span class="status-value">${data.largeAnimals || '<span class="no-data">—</span>'}</span>
              ${mapsLink(data.largeAnimalsAddr)}
            </div>
          </div>
        </div>
      `;
    }

    async function loadIncidentStatus() {
      if (!INCIDENT) return;

      try {
        // Fetch JSON data
        const res = await fetch(CONFIG.statusJsonUrl);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const incidents = await res.json();

        // Find matching incident (case-insensitive)
        const incidentLower = INCIDENT.toLowerCase();
        const data = incidents.find(inc => 
          inc.name && inc.name.toLowerCase() === incidentLower
        );

        if (!data) {
          DOM.incidentPanel.innerHTML = `
            <div class="status-html">
              <div class="status-card status-card-empty">
                <h2 class="status-card-title">No Status Information</h2>
                <p>No detailed status information is currently available for <strong>${INCIDENT}</strong>.</p>
                <p style="margin-top:8px;">Check back later for updates on shelters, check-in locations, and road closures.</p>
              </div>
            </div>
            <div class="status-timestamp">
              Last loaded: ${new Date().toLocaleString()}
              &nbsp;•&nbsp;
              <span class="source-label">Source: La Plata County Office of Emergency Management</span>
            </div>`;
          return;
        }

        DOM.incidentPanel.innerHTML = `<div class="status-html">${buildStatusCard(data)}</div>
          <div class="status-timestamp">
            Last loaded: ${new Date().toLocaleString()}
            &nbsp;•&nbsp;
            <span class="source-label">Source: La Plata County Office of Emergency Management</span>
          </div>`;
      } catch (err) {
        console.error('Error loading incident status:', err);
        DOM.incidentPanel.innerHTML = `
          <div class="status-html">
            <div class="status-card status-card-error">
              <h2 class="status-card-title">Error Loading Status</h2>
              <p>Unable to load incident status information.</p>
              <p style="margin-top:8px;font-size:13px;color:#666;">Error: ${err.message}</p>
            </div>
          </div>`;
      }
    }

    // ========== MAP INITIALIZATION ==========
    function initMap() {
      if (typeof require === 'undefined') {
        setTimeout(initMap, 100);
        return;
      }

      require([
        'esri/WebMap', 'esri/views/MapView', 'esri/layers/FeatureLayer',
        'esri/widgets/Search', 'esri/widgets/Fullscreen'
      ], (WebMap, MapView, FeatureLayer, Search, Fullscreen) => {

        DOM.infoButton?.addEventListener('click', () => location.href = 'index.html');
        DOM.overviewButton?.addEventListener('click', () => location.href = 'overview.html');

        const webmap = new WebMap({ portalItem: { id: CONFIG.webmapId } });
        const view = new MapView({ container: 'viewDiv', map: webmap });

        // Disable scroll zoom on mobile
        if (window.innerWidth < 700 && view.navigation) {
          view.navigation.mouseWheelZoomEnabled = false;
          view.navigation.browserTouchPanEnabled = false;
        }

        const incidentLayer = new FeatureLayer({
          url: CONFIG.incidentLayerUrl,
          outFields: ['*'],
          visible: false,
          listMode: 'hide'
        });
        webmap.add(incidentLayer);

        const zoomToIncident = name => {
          incidentLayer.queryExtent({ where: `${CONFIG.incidentField} = '${escapeQuery(name)}'` })
            .then(res => res.extent && view.goTo(res.extent.expand(1.2)))
            .catch(console.error);
        };

        view.when()
          .then(() => {
            view.ui.add(new Search({ view, includeDefaultSources: true }), 'top-right');
            view.ui.add(new Fullscreen({ view }), 'top-right');
            return incidentLayer.when();
          })
          .then(() => incidentLayer.queryFeatures({
            where: '1=1',
            outFields: [CONFIG.incidentField],
            returnDistinctValues: true,
            orderByFields: [CONFIG.incidentField]
          }))
          .then(fs => {
            const names = (fs.features || [])
              .map(f => f.attributes[CONFIG.incidentField])
              .filter(Boolean);

            DOM.countBadge.textContent = names.length;
            if (names.length) DOM.countBadge.classList.add('has-incidents');
            else { DOM.noIncidentsMsg.classList.add('is-visible'); return; }
            DOM.noIncidentsMsg.classList.remove('is-visible');

            sortIncidents(names, INCIDENT);

            const frag = document.createDocumentFragment();
            for (const name of names) {
              frag.appendChild(createChip(name, () => {
                const url = new URL(location.href);
                url.searchParams.set('incident', name);
                location.href = url;
              }));
            }
            DOM.chipsEl.appendChild(frag);

            if (INCIDENT) {
              const match = DOM.chipsEl.querySelector(`[data-incident="${INCIDENT}"]`);
              if (match) {
                match.classList.add('active');
                zoomToIncident(INCIDENT);
              }
            }
          })
          .catch(err => {
            console.error('Error loading incidents:', err);
            DOM.countBadge.textContent = '0';
          });
      });
    }

    // ========== CODERED OVERLAY ==========
    function initCoderedOverlay() {
      const overlay = DOM.coderedOverlay;
      if (!DOM.coderedButton || !overlay) return;

      const toggle = open => {
        overlay.classList.toggle('is-open', open);
        overlay.setAttribute('aria-hidden', String(!open));
      };

      DOM.coderedButton.addEventListener('click', () => toggle(true));
      DOM.coderedClose?.addEventListener('click', () => toggle(false));
      DOM.noIncidentCodered?.addEventListener('click', e => { e.preventDefault(); toggle(true); });
      overlay.addEventListener('click', e => { if (e.target === overlay) toggle(false); });
      document.addEventListener('keydown', e => { if (e.key === 'Escape' && overlay.classList.contains('is-open')) toggle(false); });
    }

    // ========== ANNOUNCEMENT OVERLAY ==========
    function initAnnouncement() {
      const overlay = DOM.announcementOverlay;
      const alertBtn = DOM.announcementAlertBtn;
      
      if (!SHOW_ANNOUNCEMENT || !overlay) return;
      
      // Show the alert button when announcement is active
      if (alertBtn) alertBtn.classList.add('is-active');

      const toggle = open => {
        overlay.classList.toggle('is-open', open);
        overlay.setAttribute('aria-hidden', String(!open));
        
        // Mark as viewed when closed
        if (!open && alertBtn) {
          alertBtn.classList.add('is-viewed');
        }
      };

      // Auto-open on page load only if enabled
      if (AUTO_OPEN_ANNOUNCEMENT) {
        toggle(true);
      }

      // Close handlers
      DOM.announcementClose?.addEventListener('click', () => toggle(false));
      DOM.announcementDismiss?.addEventListener('click', () => toggle(false));
      overlay.addEventListener('click', e => { if (e.target === overlay) toggle(false); });
      document.addEventListener('keydown', e => { if (e.key === 'Escape' && overlay.classList.contains('is-open')) toggle(false); });
      
      // Alert button opens the announcement
      alertBtn?.addEventListener('click', () => toggle(true));
    }

    // ========== INIT ==========
    function init() {
      DOM.evacRow = $('evacRow');
      DOM.incidentPanel = $('incidentPanel');
      DOM.chipsEl = $('incidentChips');
      DOM.countBadge = $('incidentCountBadge');
      DOM.noIncidentsMsg = $('noIncidentsMsg');
      DOM.noIncidentCodered = $('noIncidentCodered');
      DOM.infoButton = $('infoButton');
      DOM.overviewButton = $('overviewButton');
      DOM.coderedButton = $('coderedButton');
      DOM.coderedOverlay = $('coderedOverlay');
      DOM.coderedClose = $('coderedClose');
      
      // Announcement elements
      DOM.announcementOverlay = $('announcementOverlay');
      DOM.announcementClose = $('announcementClose');
      DOM.announcementDismiss = $('announcementDismiss');
      DOM.announcementAlertBtn = $('announcementAlertBtn');

      initCoderedOverlay();
      initAnnouncement();
      loadEvacu
