<script>
  // Get incident from URL parameters
  const params = new URLSearchParams(window.location.search);
  const rawIncident = params.get('incident');
  const urlIncident = rawIncident && rawIncident.trim() ? rawIncident.trim() : null;

  // ========== MAP INITIALIZATION ========== 
  require([
    "esri/config",
    "esri/WebMap",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/widgets/Search"
  ], function(esriConfig, WebMap, MapView, FeatureLayer, Search) {

    // Make sure we're using your org portal
    esriConfig.portalUrl = "https://lpcgis.maps.arcgis.com";

    const webmapId = "58a8bb313db64271a55e7960cb839f64";
    const incidentLayerUrl = "https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0";
    const incidentFieldName = "incident";

    const incidentMenu = document.getElementById('incidentMenu');
    const mapStatus = document.getElementById('mapStatus');

    // Load the full webmap with all layers as configured in Map Viewer
    const webmap = new WebMap({
      portalItem: {
        id: webmapId
      }
    });

    const view = new MapView({
      container: "viewDiv",
      map: webmap
    });

    // Add Search widget (address / place search) to the map
    const searchWidget = new Search({
      view: view,
      includeDefaultSources: true,
      allPlaceholder: "Search by address or place"
    });
    view.ui.add(searchWidget, "top-right");

    // Try to reuse the evac layer from the webmap if it already exists
    let incidentLayer = null;

    webmap.when().then(() => {
      incidentLayer = webmap.layers.find(layer =>
        layer.url && layer.url.indexOf(incidentLayerUrl) === 0
      );

      // If it's not already in the webmap, add it (so zoom/query still work)
      if (!incidentLayer) {
        incidentLayer = new FeatureLayer({
          url: incidentLayerUrl,
          outFields: ["*"]
        });
        webmap.add(incidentLayer);
      }

      // Once view + incident layer are ready, build the incident menu + handle zoom
      return view.when().then(() => incidentLayer.when());
    }).then(() => {
      mapStatus.textContent = "Loading incidents…";

      // Query distinct incident names from the evac layer
      return incidentLayer.queryFeatures({
        where: "1=1",
        outFields: [incidentFieldName],
        returnDistinctValues: true,
        orderByFields: [incidentFieldName]
      });
    }).then((featureSet) => {
      const features = featureSet.features || [];

      const incidentNames = features
        .map(f => f.attributes[incidentFieldName])
        .filter(val => val)
        .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));

      // Clear any placeholder buttons
      incidentMenu.innerHTML = "";

      // Build incident buttons
      incidentNames.forEach((val) => {
        const btn = document.createElement('a');
        btn.className = 'incident-btn';
        btn.textContent = val;
        btn.href = '?incident=' + encodeURIComponent(val);

        // Mark as active if it matches current URL incident
        if (urlIncident && urlIncident.toLowerCase() === val.toLowerCase()) {
          btn.classList.add('active');
        }

        incidentMenu.appendChild(btn);
      });

      mapStatus.textContent = `${incidentNames.length} incident(s) available`;

      // Zoom helper
      function zoomToIncident(incidentVal) {
        if (!incidentVal) return;

        mapStatus.textContent = "Zooming…";

        const safeVal = incidentVal.replace(/'/g, "''");
        const whereClause = `${incidentFieldName} = '${safeVal}'`;

        incidentLayer.queryExtent({ where: whereClause })
          .then((result) => {
            if (result.extent) {
              return view.goTo(result.extent.expand(1.2));
            } else {
              mapStatus.textContent = "No features for this incident.";
            }
          })
          .then(() => {
            mapStatus.textContent = `Zoomed to ${incidentVal}`;
          })
          .catch((err) => {
            console.error(err);
            mapStatus.textContent = "Zoom error.";
          });
      }

      // Auto-zoom if ?incident= is present in the URL
      if (urlIncident) {
        const urlNorm = urlIncident.toLowerCase().trim();
        let matchedValue = null;

        incidentNames.forEach((val) => {
          if (val.toLowerCase().trim() === urlNorm) {
            matchedValue = val;
          }
        });

        if (matchedValue) {
          zoomToIncident(matchedValue);
        } else {
          // Fallback to raw URL value
          zoomToIncident(urlIncident);
        }
      }
    }).catch((err) => {
      console.error(err);
      mapStatus.textContent = "Error loading map/incidents.";
      incidentMenu.innerHTML = '<div class="incident-btn loading">Error loading incidents</div>';
    });
  });
</script>
