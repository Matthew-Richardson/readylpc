<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />

  <!-- Mobile viewport so media queries and scaling work correctly -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Incident Map & Evacuation Info</title>

  <!-- Shared styles -->
  <link rel="stylesheet" href="shared-styles.css" />

  <!-- ArcGIS Maps SDK -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.31/"></script>
</head>

<body>
  <div class="page-shell">

    <div class="map-wrapper">
      <div class="map-card">

        <div class="card-brand">
          <img
            src="https://cms9files.revize.com/laplata/_assets_/images/logo.png"
            alt="La Plata County Logo"
            class="header-logo"
          />
          <div class="site-title">
            ReadyLaPlata ‚Äî La Plata County Evacuation Viewer
          </div>
          <div class="call-center">
            <strong>Call Center</strong>
            <a href="tel:9703858700">970-385-8700</a>
          </div>
        </div>

        <div class="card-divider"></div>

        <div class="incident-strip">
          <div class="incident-strip-top">
            <div class="incident-bar-left">
              <span class="incident-label">
                Active incidents
                <span id="incidentCountBadge" class="incident-count-badge">0</span>
              </span>
            </div>

            <button
              id="infoButton"
              class="info-link"
              type="button"
              aria-label="Evacuation Information"
            >
              <span class="info-icon-home">üè†</span>
              <span class="info-label">Evacuation Information</span>
            </button>
          </div>

          <div class="incident-tip">
            Tap an incident below to view the evacuation map.
          </div>

          <div id="incidentChips" class="incident-chips"></div>
          <div id="noIncidentsMsg" class="incident-none" style="display:none;">
            No active incidents are listed.
          </div>
        </div>

        <div class="card-divider"></div>

        <div id="viewDiv"></div>

        <div class="map-key-merged">
          <div class="legend-title">Map Key</div>
          <div class="legend-items">
            <div class="legend-item">
              <span class="legend-icon-road"></span>
              <span>Road closure</span>
            </div>
            <div class="legend-item">
              <span class="legend-icon-info">i</span>
              <span>Information</span>
            </div>
            <div class="legend-item">
              <span class="legend-icon-warning"></span>
              <span>Special warning</span>
            </div>
          </div>
        </div>

      </div>
    </div>

    <main>
      <div id="evacRow" class="evac-row">
        Loading evacuation information‚Ä¶
      </div>

      <div class="incident-panel">
        <div id="incident-panel">Loading incident status‚Ä¶</div>
      </div>
    </main>
  </div>

  <!-- Scroll hint pill -->
  <div class="scroll-hint" id="scrollHint">
    <div class="scroll-hint-button">
      <span class="scroll-hint-text">Scroll</span>
      <span class="scroll-hint-arrow">‚ñæ</span>
    </div>
  </div>

  <script>
    const webmapId = "58a8bb313db64271a55e7960cb839f64";
    const incidentLayerUrl =
      "https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0";
    const incidentFieldName = "incident";

    function getIncidentFromUrl() {
      try {
        const params = new URLSearchParams(window.location.search);
        return (params.get("incident") || params.get("Incident") || "").trim();
      } catch {
        return "";
      }
    }

    const INCIDENT = (() => {
      const inc = getIncidentFromUrl();
      return inc && inc.trim() ? inc.trim() : null;
    })();

    const STATUS_LABELS = {
      SET: "SET - Pre-Evacuation",
      GO: "GO - Evacuate Now",
    };

    const STATUS_COLORS = {
      SET: "#fff36a",
      GO: "#41f56e",
    };

    const STATUS_TEXT = {
      SET: "Voluntary Evacuation;<br>Evacuation orders are likely",
      GO: "<strong>LEAVE NOW.</strong> Immediate threat to life.<br>This area is closed to public access.",
    };

    const STATUS_VALUES = {
      SET: "Set",
      GO: "Go",
    };

    const ARCGIS_URL =
      "https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0/query";
    const STATUS_BASE_URL =
      "https://script.google.com/macros/s/AKfycbxOFlSc6xXHqERr7n9VQbfnXnPGRqsvbgUs5lx4y6cy9YfnYSGFkLk5nSut66ecoRUwtA/exec";

    function escapeForQuery(str) {
      return str.replace(/'/g, "''");
    }

    function showHelp() {
      const helpEvacHtml = `
        <div class="evac-box" style="background:#f3f4f6;">
          <div class="evac-title">How to use this page</div>
          <div class="evac-body">
            <div>
              This evacuation information requires an <strong>incident name</strong> in the URL.
            </div>
            <div style="margin-top:8px;">
              Use this format:
              <br>
              <code>?incident=YourIncidentName</code>
            </div>
            <div style="margin-top:8px;">
              Example:
              <br>
              <code>?incident=East%20Canyon</code>
            </div>
            <div style="margin-top:8px;">
              The incident name must match the name used in the map and Google Sheet.
            </div>
          </div>
        </div>
      `;

      const helpStatusHtml = `
        <div class="evac-box" style="background:#f3f4f6;">
          <div class="evac-title">Incident status</div>
          <div class="evac-body">
            <div>No incident was specified.</div>
            <div style="margin-top:8px;">
              Append <code>?incident=YourIncidentName</code> to the URL
              (for example: <code>?incident=East%20Canyon</code>).
            </div>
          </div>
        </div>
      `;

      const row = document.getElementById("evacRow");
      if (row) row.innerHTML = helpEvacHtml;

      const panel = document.getElementById("incident-panel");
      if (panel) panel.innerHTML = helpStatusHtml;
    }

    function buildBox(statusCode, features) {
      const label = STATUS_LABELS[statusCode];
      const bg = STATUS_COLORS[statusCode];
      const note = STATUS_TEXT[statusCode];

      let zonesHTML;
      if (!features || features.length === 0) {
        zonesHTML = `
          <div class="evac-zones">
            <div class="no-zones-chip">No ${statusCode} zones</div>
          </div>`;
      } else {
        const chips = features
          .map((f) => {
            const zn = f.attributes.zonename;
            return `<div class="zone-chip">${zn}</div>`;
          })
          .join("");
        zonesHTML = `<div class="evac-zones">${chips}</div>`;
      }

      const extraClass =
        statusCode === "GO"
          ? " evac-box-go"
          : statusCode === "SET"
          ? " evac-box-set"
          : "";

      return `
        <div class="evac-box${extraClass}" style="background:${bg};">
          <div class="evac-title">${label}</div>
          <div class="evac-body">
            <div>
              The following zones are under ${statusCode} status for
              <strong>${INCIDENT || "this incident"}</strong>.
            </div>
            ${zonesHTML}
            <div class="evac-note">${note}</div>
          </div>
        </div>`;
    }

    function showError(message) {
      document.getElementById("evacRow").innerHTML = `
        <div class="evac-box" style="background:#fff36a;">
          <div class="evac-title">Error</div>
          <div class="evac-body">${message}</div>
        </div>`;
    }

    function loadEvacuationZones() {
      if (!INCIDENT) {
        showHelp();
        return;
      }

      const escapedIncident = escapeForQuery(INCIDENT);
      const where = `incident='${escapedIncident}' AND STATUS IN ('${STATUS_VALUES.SET}','${STATUS_VALUES.GO}')`;

      const queryParams = new URLSearchParams({
        where,
        outFields: "*",
        f: "json",
        returnGeometry: "false",
      });

      fetch(ARCGIS_URL + "?" + queryParams.toString())
        .then((r) => {
          if (!r.ok) {
            throw new Error(`HTTP error! status: ${r.status}`);
          }
          return r.json();
        })
        .then((data) => {
          const row = document.getElementById("evacRow");

          if (!data.features || data.features.length === 0) {
            row.innerHTML = `
              <div class="evac-box" style="background:#fff36a;">
                <div class="evac-title">No data</div>
                <div class="evac-body">
                  No zones found for <strong>${INCIDENT}</strong>.
                </div>
              </div>`;
            return;
          }

          const setFeatures = data.features.filter(
            (f) => f.attributes.STATUS === STATUS_VALUES.SET
          );
          const goFeatures = data.features.filter(
            (f) => f.attributes.STATUS === STATUS_VALUES.GO
          );

          row.innerHTML =
            buildBox("SET", setFeatures) + buildBox("GO", goFeatures);
        })
        .catch((err) => {
          console.error("Error loading evacuation zones:", err);
          showError(`Failed to load evacuation data: ${err.message}`);
        });
    }

    function loadIncidentStatus(incidentName) {
      if (!incidentName) {
        return;
      }

      const url =
        STATUS_BASE_URL + "?incident=" + encodeURIComponent(incidentName);

      fetch(url)
        .then((r) => {
          if (!r.ok) {
            throw new Error(`HTTP error! status: ${r.status}`);
          }
          return r.text();
        })
        .then((html) => {
          const panel = document.getElementById("incident-panel");

          panel.innerHTML = `<div class="status-html">${html}</div>`;

          const stamp = document.createElement("div");
          stamp.className = "status-timestamp";
          const now = new Date();
          stamp.innerHTML = `
            Last loaded: ${now.toLocaleString()}
            &nbsp;‚Ä¢&nbsp;
            <span class="source-label">Source: La Plata County Office of Emergency Management</span>
          `;
          panel.appendChild(stamp);
        })
        .catch((err) => {
          console.error("Error loading incident status:", err);
          document.getElementById("incident-panel").innerHTML =
            "<div>Error loading incident status.</div>";
        });
    }

    loadEvacuationZones();
    loadIncidentStatus(INCIDENT);

    // Scroll hint: visible on load, disappears once the user scrolls a bit (one-time)
    function handleScrollHint() {
      const scrollTop =
        window.scrollY ||
        document.documentElement.scrollTop ||
        document.body.scrollTop ||
        0;

      if (scrollTop > 5) {
        document.body.classList.add("scrolled");
        window.removeEventListener("scroll", handleScrollHint);
      }
    }

    window.addEventListener("scroll", handleScrollHint);

    /* ---------- MAP & INCIDENT CHIPS LOGIC ---------- */
    require(
      [
        "esri/WebMap",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/widgets/Search",
        "esri/widgets/Fullscreen"
      ],
      function (WebMap, MapView, FeatureLayer, Search, Fullscreen) {
        const infoButton = document.getElementById("infoButton");
        const chipsEl = document.getElementById("incidentChips");
        const countBadge = document.getElementById("incidentCountBadge");
        const noIncidentsMsg = document.getElementById("noIncidentsMsg");

        infoButton.addEventListener("click", () => {
          window.location.href = "info.html";
        });

        const webmap = new WebMap({
          portalItem: { id: webmapId },
        });

        const view = new MapView({
          container: "viewDiv",
          map: webmap,
        });

        // On small screens, let the PAGE scroll instead of the map
        if (window.innerWidth < 700 && view.navigation) {
          view.navigation.mouseWheelZoomEnabled = false;
          if ("browserTouchPanEnabled" in view.navigation) {
            view.navigation.browserTouchPanEnabled = false;
          }
          if ("touchZoomEnabled" in view.navigation) {
            view.navigation.touchZoomEnabled = true; // keep pinch zoom
          }
        }

        const incidentLayer = new FeatureLayer({
          url: incidentLayerUrl,
          outFields: ["*"],
          visible: false,
          listMode: "hide",
        });
        webmap.add(incidentLayer);

        function zoomToIncident(name) {
          const safe = name.replace(/'/g, "''");
          const where = `${incidentFieldName} = '${safe}'`;

          return incidentLayer
            .queryExtent({ where })
            .then((res) => {
              if (res.extent) {
                return view.goTo(res.extent.expand(1.2));
              }
            })
            .catch(console.error);
        }

        view
          .when()
          .then(() => {
            const search = new Search({
              view,
              includeDefaultSources: true,
            });
            view.ui.add(search, "top-right");

            const fullscreen = new Fullscreen({
              view: view
            });
            view.ui.add(fullscreen, "top-right");

            return incidentLayer.when();
          })
          .then(() => {
            return incidentLayer.queryFeatures({
              where: "1=1",
              outFields: [incidentFieldName],
              returnDistinctValues: true,
              orderByFields: [incidentFieldName],
            });
          })
          .then((fs) => {
            const features = fs.features || [];

            const incidentNames = [];
            features.forEach((f) => {
              const name = f.attributes[incidentFieldName];
              if (name) incidentNames.push(name);
            });

            if (countBadge) {
              countBadge.textContent = incidentNames.length;
            }

            if (!incidentNames.length) {
              if (noIncidentsMsg) noIncidentsMsg.style.display = "block";
              return;
            } else {
              if (noIncidentsMsg) noIncidentsMsg.style.display = "none";
            }

            if (INCIDENT) {
              const target = INCIDENT.toLowerCase();
              incidentNames.sort((a, b) => {
                const al = a.toLowerCase();
                const bl = b.toLowerCase();
                if (al === target && bl !== target) return -1;
                if (bl === target && al !== target) return 1;
                return al.localeCompare(bl);
              });
            } else {
              incidentNames.sort((a, b) =>
                a.toLowerCase().localeCompare(b.toLowerCase())
              );
            }

            incidentNames.forEach((name) => {
              const chip = document.createElement("button");
              chip.className = "incident-chip";
              chip.setAttribute("data-incident", name);
              chip.innerHTML = `
                <span class="incident-chip-dot"></span>
                <span>${name}</span>
              `;

              chip.addEventListener("click", () => {
                const url = new URL(window.location.href);
                url.searchParams.set("incident", name);
                window.location.href = url.toString();
              });

              chipsEl.appendChild(chip);
            });

            if (INCIDENT) {
              const chips = Array.from(
                chipsEl.querySelectorAll(".incident-chip")
              );
              const match = chips.find(
                (el) =>
                  (el.getAttribute("data-incident") || "").toLowerCase() ===
                  INCIDENT.toLowerCase()
              );
              if (match) {
                match.classList.add("active");
                zoomToIncident(INCIDENT);
              }
            }
          })
          .catch((err) => {
            console.error("Error loading incidents:", err);
            if (countBadge) countBadge.textContent = "0";
          });
      }
    );
  </script>
</body>
</html>
