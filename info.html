<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evacuation Information ‚Äî ReadyLaPlata</title>

  <!-- Critical inline CSS to avoid FOUC -->
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{
      margin:0;
      padding:0;
      height:100%;
      font-family:Arial,sans-serif;
      background:#f5f5f7;
      font-size:18px;
      overflow-x:hidden;
      color:#000;
    }
    .page-shell{min-height:100vh;display:flex;flex-direction:column}
    .map-wrapper{max-width:900px;width:100%;margin:16px auto 0;padding:12px}
    .map-card{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.2);
      box-shadow:0 2px 10px rgba(0,0,0,0.25);
      overflow:hidden;
      background:#fff;
      display:flex;
      flex-direction:column;
    }
  </style>

  <link rel="stylesheet" href="shared-styles.css">
</head>

<body>
  <div class="page-shell">
    <div class="map-wrapper">
      <div class="map-card">

        <div class="card-brand">
          <img
            src="https://cms9files.revize.com/laplata/_assets_/images/logo.png"
            alt="La Plata County Logo"
            class="header-logo"
            width="260"
          >
          <div class="site-title">
            ReadyLaPlata ‚Äî La Plata County Evacuation Viewer
          </div>
          <div class="call-center">
            <strong>Call Center</strong>
            <a href="tel:9703858700">970-385-8700</a>
          </div>
        </div>

        <div class="card-divider"></div>

        <div class="incident-strip">
          <div class="incident-strip-top">
            <div class="incident-bar-left">
              <span class="incident-label">
                Active incidents
                <span id="incidentCountBadge" class="incident-count-badge">0</span>
              </span>
            </div>
          </div>

          <div class="incident-tip">Tap an incident below to view the evacuation map.</div>
          <div id="incidentChips" class="incident-chips"></div>
          <div id="noIncidentsMsg" class="incident-none" style="display:none">No active incidents are listed.</div>
        </div>

        <div class="incident-nav-centered">
          <button id="overviewButton" class="info-link" type="button" aria-label="Overview Map">
            <span class="info-icon-home">üó∫Ô∏è</span>
            <span class="info-label-full">Overview Map</span>
            <span class="info-label-short">Overview</span>
          </button>
          <button id="coderedButton" class="alert-link" type="button" aria-label="CodeRED Alerts">
            <span class="alert-icon">üîî</span>
            <span class="alert-label">CodeRED Alerts</span>
            <span class="alert-label-short">CodeRED</span>
          </button>
        </div>

        <div class="card-divider"></div>
      </div>
    </div>

    <main>
      <div class="incident-panel">
        <div class="home-wrapper">

          <!-- TIMELINE BLOCK CARD -->
          <div class="preview-container">
            <div class="preview-frame">

              <div class="evac-stages">
                <div class="stage-header-main">
                  <div class="stage-tagline">La Plata County</div>
                  <div class="stage-headline">Stay Ready, Year-Round</div>
                  <div class="stage-body" style="margin-top:8px;max-width:780px;margin-left:auto;margin-right:auto;font-size:15px;line-height:1.5;">
                    <p>
                      La Plata County Office of Emergency Management (<strong>LPCOEM</strong>) ‚Äî uses the Ready, Set, Go! system to establish evacuation zones.
                      Click the incident map above to confirm your zone. During an incident your zone name and area is subject to change.
                    </p>
                  </div>
                </div>

                <!-- Centered subheader -->
                <div class="stage-subhead">Ready, Set, Go! System</div>

                <div id="stageTimeline" class="stage-timeline">

                  <!-- SVG Triangle Connectors - Dynamically drawn -->
                  <svg id="triangleLines" class="triangle-lines" aria-hidden="true">
                    <defs>
                      <linearGradient id="grad-ready-set" gradientUnits="userSpaceOnUse">
                        <stop offset="0%" stop-color="#b33a3a"/>
                        <stop offset="100%" stop-color="#a68f00"/>
                      </linearGradient>
                      <linearGradient id="grad-ready-go" gradientUnits="userSpaceOnUse">
                        <stop offset="0%" stop-color="#b33a3a"/>
                        <stop offset="100%" stop-color="#0a7c25"/>
                      </linearGradient>
                      <linearGradient id="grad-set-go" gradientUnits="userSpaceOnUse">
                        <stop offset="0%" stop-color="#a68f00"/>
                        <stop offset="100%" stop-color="#0a7c25"/>
                      </linearGradient>
                    </defs>
                    <line id="line-ready-set" stroke="url(#grad-ready-set)" stroke-width="4" stroke-linecap="round"/>
                    <line id="line-ready-go" stroke="url(#grad-ready-go)" stroke-width="4" stroke-linecap="round"/>
                    <line id="line-set-go" stroke="url(#grad-set-go)" stroke-width="4" stroke-linecap="round"/>
                  </svg>

                  <!-- READY (top center) -->
                  <div class="stage-item stage-item-ready">
                    <div id="pinReady" class="stage-pin stage-pin-ready"></div>
                    <div class="stage-card stage-card-ready">
                      <h2 class="stage-title">READY</h2>
                      <div class="stage-subtitle">Be READY, Stay SAFE</div>
                      <div class="stage-body">
                        <p><strong>Stay Informed:</strong> CodeRED signup or text 'LPCOEM' to 99411, ensure Gov't Alerts are enabled on your cell phone, and use apps like Watch Duty.</p>
                        <p><strong>Arrangements:</strong> Make a plan and practice your evacuation; People, Pets, Photos, Papers and Pills.</p>
                        <p><strong>Fire Ready:</strong> Fire Mitigation and last minute safety measures, "Go Kit" with Protective Clothing and masks.</p>
                        <p><strong>Evacuate:</strong> Don't hesitate or ignore evacuation orders. Know multiple ways out.</p>
                      </div>
                    </div>
                  </div>

                  <!-- Bottom row container for SET and GO -->
                  <div class="stage-bottom-row">
                    <!-- SET (bottom left) -->
                    <div class="stage-item stage-item-set">
                      <div id="pinSet" class="stage-pin stage-pin-set"></div>
                      <div class="stage-card stage-card-set">
                        <h2 class="stage-title">SET</h2>
                        <div class="stage-subtitle">Pre-Evacuation</div>
                        <div class="stage-body stage-body-center">
                          <p><strong>SET - Pre-Evacuation</strong></p>
                          <p>Voluntary Evacuation; Evacuation orders are likely.</p>
                        </div>
                      </div>
                    </div>

                    <!-- GO (bottom right) -->
                    <div class="stage-item stage-item-go">
                      <div id="pinGo" class="stage-pin stage-pin-go"></div>
                      <div class="stage-card stage-card-go">
                        <h2 class="stage-title">GO</h2>
                        <div class="stage-subtitle">Evacuate Now</div>
                        <div class="stage-body stage-body-center">
                          <p><strong>GO - Evacuate Now</strong></p>
                          <p>LEAVE NOW. Immediate threat to life.</p>
                          <p>This area is closed to public access.</p>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>

            </div>
          </div>

        </div>
      </div>
    </main>
  </div>

  <!-- CodeRED Overlay (same as evac.html) -->
  <div id="coderedOverlay" class="codered-overlay" aria-hidden="true">
    <div class="codered-dialog" role="dialog" aria-modal="true" aria-labelledby="coderedTitle">
      <button id="coderedClose" class="codered-close" type="button" aria-label="Close CodeRED info">√ó</button>
      <h2 id="coderedTitle" class="codered-title">CodeRED Emergency Alerts</h2>
      <p class="codered-subtitle">Stay informed about wildfires, floods, and other emergencies in La Plata County.</p>
      <div class="codered-body">
        <p><strong>CodeRED</strong> is the official emergency alerting system used by La Plata County Office of Emergency Management (LPCOEM).</p>
        <p>You can receive notifications by text, phone call, and email about evacuation notices, road closures, and other time-sensitive information.</p>
        <p>Choose one of the options below to enroll or confirm your subscription:</p>
      </div>
      <div class="codered-actions">
        <a
          href="https://public.coderedweb.com/CNE/en-US/"
          class="primary-pill"
          target="_blank"
          rel="noopener noreferrer"
        >
          Sign up on CodeRED website
        </a>
        <a href="sms:99411?&body=LPCOEM" class="secondary-pill">
          Text ‚ÄúLPCOEM‚Äù to 99411
        </a>
      </div>
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      const CONFIG = {
        mapUrl: 'evac.html',
        incidentLayerUrl: 'https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0/query',
        incidentField: 'incident'
      };

      const DOM = {
        chipsEl: document.getElementById('incidentChips'),
        countBadge: document.getElementById('incidentCountBadge'),
        noIncidentsMsg: document.getElementById('noIncidentsMsg'),
        overviewButton: document.getElementById('overviewButton'),
        coderedButton: document.getElementById('coderedButton'),
        coderedOverlay: document.getElementById('coderedOverlay'),
        coderedClose: document.getElementById('coderedClose')
      };

      const INCIDENT = (() => {
        try {
          const p = new URLSearchParams(location.search);
          const inc = (p.get('incident') || p.get('Incident') || '').trim();
          return inc || null;
        } catch { return null; }
      })();

      async function loadIncidents() {
        const params = new URLSearchParams({
          where: '1=1',
          outFields: CONFIG.incidentField,
          returnDistinctValues: 'true',
          f: 'json'
        });

        try {
          const res = await fetch(`${CONFIG.incidentLayerUrl}?${params}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);

          const data = await res.json();
          const seen = new Set();

          const names = (data.features || [])
            .map(f => f.attributes?.[CONFIG.incidentField]?.trim())
            .filter(n => {
              if (!n) return false;
              const key = n.toLowerCase();
              if (seen.has(key)) return false;
              seen.add(key);
              return true;
            });

          const target = INCIDENT?.toLowerCase();
          names.sort((a, b) => {
            const al = a.toLowerCase(), bl = b.toLowerCase();
            if (target) {
              if (al === target && bl !== target) return -1;
              if (bl === target && al !== target) return 1;
            }
            return al.localeCompare(bl);
          });

          DOM.countBadge.textContent = names.length;

          if (!names.length) {
            DOM.noIncidentsMsg.style.display = 'block';
            return;
          }

          const frag = document.createDocumentFragment();
          names.forEach(name => {
            const chip = document.createElement('button');
            chip.className = 'incident-chip';
            chip.innerHTML = `<span class="incident-chip-dot"></span><span>${name}</span>`;
            chip.addEventListener('click', () => {
              const url = new URL(CONFIG.mapUrl, location.href);
              url.searchParams.set('incident', name);
              location.href = url;
            });
            frag.appendChild(chip);
          });

          DOM.chipsEl.appendChild(frag);

        } catch (err) {
          console.error(err);
          DOM.countBadge.textContent = '0';
          DOM.noIncidentsMsg.style.display = 'block';
        }
      }

      function initCoderedOverlay() {
        if (!DOM.coderedButton || !DOM.coderedOverlay) return;

        const open = () => {
          DOM.coderedOverlay.classList.add('is-open');
          DOM.coderedOverlay.setAttribute('aria-hidden', 'false');
        };

        const close = () => {
          DOM.coderedOverlay.classList.remove('is-open');
          DOM.coderedOverlay.setAttribute('aria-hidden', 'true');
        };

        DOM.coderedButton.addEventListener('click', open);
        if (DOM.coderedClose) DOM.coderedClose.addEventListener('click', close);

        DOM.coderedOverlay.addEventListener('click', (e) => {
          if (e.target === DOM.coderedOverlay) {
            close();
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && DOM.coderedOverlay.classList.contains('is-open')) {
            close();
          }
        });
      }

      function initOverviewButton() {
        if (!DOM.overviewButton) return;
        
        DOM.overviewButton.addEventListener('click', () => {
          location.href = 'overview.html';
        });
      }

      function initTriangleLines() {
        const container = document.getElementById('stageTimeline');
        const svg = document.getElementById('triangleLines');
        const pinReady = document.getElementById('pinReady');
        const pinSet = document.getElementById('pinSet');
        const pinGo = document.getElementById('pinGo');
        
        if (!container || !svg || !pinReady || !pinSet || !pinGo) return;

        const lineReadySet = document.getElementById('line-ready-set');
        const lineReadyGo = document.getElementById('line-ready-go');
        const lineSetGo = document.getElementById('line-set-go');
        const gradReadySet = document.getElementById('grad-ready-set');
        const gradReadyGo = document.getElementById('grad-ready-go');
        const gradSetGo = document.getElementById('grad-set-go');

        function updateLines() {
          const containerRect = container.getBoundingClientRect();
          const readyRect = pinReady.getBoundingClientRect();
          const setRect = pinSet.getBoundingClientRect();
          const goRect = pinGo.getBoundingClientRect();

          // Calculate center points relative to container
          const ready = {
            x: readyRect.left + readyRect.width / 2 - containerRect.left,
            y: readyRect.top + readyRect.height / 2 - containerRect.top
          };
          const set = {
            x: setRect.left + setRect.width / 2 - containerRect.left,
            y: setRect.top + setRect.height / 2 - containerRect.top
          };
          const go = {
            x: goRect.left + goRect.width / 2 - containerRect.left,
            y: goRect.top + goRect.height / 2 - containerRect.top
          };

          // Update line positions
          lineReadySet.setAttribute('x1', ready.x);
          lineReadySet.setAttribute('y1', ready.y);
          lineReadySet.setAttribute('x2', set.x);
          lineReadySet.setAttribute('y2', set.y);

          lineReadyGo.setAttribute('x1', ready.x);
          lineReadyGo.setAttribute('y1', ready.y);
          lineReadyGo.setAttribute('x2', go.x);
          lineReadyGo.setAttribute('y2', go.y);

          lineSetGo.setAttribute('x1', set.x);
          lineSetGo.setAttribute('y1', set.y);
          lineSetGo.setAttribute('x2', go.x);
          lineSetGo.setAttribute('y2', go.y);

          // Update gradient directions
          gradReadySet.setAttribute('x1', ready.x);
          gradReadySet.setAttribute('y1', ready.y);
          gradReadySet.setAttribute('x2', set.x);
          gradReadySet.setAttribute('y2', set.y);

          gradReadyGo.setAttribute('x1', ready.x);
          gradReadyGo.setAttribute('y1', ready.y);
          gradReadyGo.setAttribute('x2', go.x);
          gradReadyGo.setAttribute('y2', go.y);

          gradSetGo.setAttribute('x1', set.x);
          gradSetGo.setAttribute('y1', set.y);
          gradSetGo.setAttribute('x2', go.x);
          gradSetGo.setAttribute('y2', go.y);
        }

        // Initial draw
        updateLines();
        // Redraw after short delay to ensure layout is complete
        setTimeout(updateLines, 100);
        // Redraw on resize
        window.addEventListener('resize', updateLines);
      }

      function init() {
        loadIncidents();
        initOverviewButton();
        initCoderedOverlay();
        initTriangleLines();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
