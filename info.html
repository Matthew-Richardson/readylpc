<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Evacuation Information – ReadyLaPlata</title>

  <!-- Shared styles -->
  <link rel="stylesheet" href="shared-styles.css" />
</head>

<body>
  <div class="page-shell">
    <div class="map-wrapper">
      <div class="map-card">

        <!-- Header -->
        <div class="card-brand">
          <img src="https://cms9files.revize.com/laplata/_assets_/images/logo.png"
               alt="La Plata County Logo"
               class="header-logo" />
          <div class="site-title">ReadyLaPlata — La Plata County Evacuation Viewer</div>
          <div class="call-center">
            <strong>Call Center</strong>
            <a href="tel:9703858700">970-385-8700</a>
          </div>
        </div>

        <div class="card-divider"></div>

        <!-- Incident menu -->
        <div class="incident-strip">
          <div class="incident-strip-top">
            <div class="incident-bar-left">
              <span class="incident-label">
                Active incidents
                <span id="incidentCountBadge" class="incident-count-badge">0</span>
              </span>
            </div>
          </div>

          <div class="incident-tip">
            Tap an incident below to view the evacuation map.
          </div>

          <div id="incidentChips" class="incident-chips"></div>
          <div id="noIncidentsMsg" class="incident-none" style="display:none;">
            No active incidents are listed.
          </div>
        </div>

        <div class="card-divider"></div>
      </div>
    </div>

    <main>
      <div class="incident-panel">
        <div class="home-wrapper">

          <!-- Top blue card -->
          <div class="home-card home-card-info">
            <h2 class="home-card-title">
              La Plata County Office of Emergency Management (LPCOEM)
            </h2>
            <div class="home-small">
              La Plata County Office of Emergency Management (<strong>LPCOEM</strong>) uses the Ready, Set, Go! system to establish evacuation zones.
              <strong>Click the incident map above to confirm your zone.</strong>
              During a incident your zone name and area is subject to change.
            </div>
          </div>

          <!-- Red READY card -->
          <div class="home-card home-card-ready">
            <h2 class="home-card-title">Be READY, Stay SAFE</h2>
            <div class="home-small">
              <p>
                <strong>Stay Informed:</strong>
                <a class="primary-pill" href="#">CodeRED signup</a>
                or
                <a class="secondary-pill" href="sms:99411?&body=LPCOEM">text 'LPCOEM' to 99411</a>,
                ensure Gov’t Alerts are enabled on your cell phone, and use apps like
                <a href="#" style="text-decoration:underline; color:#0b4da2; font-weight:700;">Watch Duty</a>.
              </p>
              <p>
                <strong>Arrangements:</strong>
                Make a plan and practice your evacuation; People, Pets, Photos, Papers and Pills.
              </p>
              <p>
                <strong>Fire Ready:</strong>
                Fire Mitigation and last minute safety measures; “Go Kit” with Protective Clothing and masks.
              </p>
              <p>
                <strong>Evacuate:</strong>
                Don’t hesitate or ignore evacuation orders. Know multiple ways out.
              </p>
            </div>
          </div>

          <!-- Yellow SET card -->
          <div class="home-card home-card-set">
            <h2 class="home-card-title">SET - Pre-Evacuation</h2>
            <div class="home-small" style="text-align:center;">
              Voluntary Evacuation;<br />
              Evacuation orders are likely.
            </div>
          </div>

          <!-- Green GO card -->
          <div class="home-card home-card-go">
            <h2 class="home-card-title">GO - Evacuate Now</h2>
            <div class="home-small" style="text-align:center;">
              <strong>LEAVE NOW.</strong> Immediate threat to life.<br />
              This area is closed to public access.
            </div>
          </div>

          <!-- Bottom CodeRED card -->
          <div class="home-card home-card-codered">
            <h2 class="home-card-title">CodeRED Emergency Notifications</h2>
            <div class="home-small">
              <p>
                La Plata County’s emergency notification system is called CodeRed.
                If you live in La Plata County, you may now register up to five cell or Internet phone numbers with your physical street address,
                ensuring that you get emergency notifications even when you’re not at home or don’t have a land line.
                Register for CodeRed Community Notification Enrollment to receive notifications.
              </p>
              <p style="margin-top:10px;">
                <strong>Mobile Signup:</strong>
                <a class="secondary-pill" href="sms:99411?&body=LPCOEM">
                  Text 'LPCOEM' to 99411
                </a>
              </p>
            </div>
          </div>

        </div>
      </div>
    </main>
  </div>

  <!-- Scroll hint pill -->
  <div class="scroll-hint" id="scrollHint">
    <div class="scroll-hint-button">
      <span class="scroll-hint-text">Scroll</span>
      <span class="scroll-hint-arrow">▾</span>
    </div>
  </div>

  <script>
  const INCIDENT_MAP_URL = "evac.html";
  const incidentLayerUrl =
    "https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0/query";
  const incidentFieldName = "incident";

  const chipsEl = document.getElementById("incidentChips");
  const countBadge = document.getElementById("incidentCountBadge");
  const noIncidentsMsg = document.getElementById("noIncidentsMsg");

  function getIncidentFromUrl() {
    try {
      const params = new URLSearchParams(window.location.search);
      return (params.get("incident") || params.get("Incident") || "").trim();
    } catch {
      return "";
    }
  }

  const INCIDENT = (() => {
    const inc = getIncidentFromUrl();
    return inc && inc.trim() ? inc.trim() : null;
  })();

  // Scroll hint: visible on load, disappears once the user scrolls a bit (one-time)
  function handleScrollHint() {
    const scrollTop =
      window.scrollY ||
      document.documentElement.scrollTop ||
      document.body.scrollTop ||
      0;

    if (scrollTop > 5) {
      document.body.classList.add("scrolled");
      window.removeEventListener("scroll", handleScrollHint);
    }
  }

  window.addEventListener("scroll", handleScrollHint);

  function loadIncidentMenu() {
    const params = new URLSearchParams({
      where: "1=1",
      outFields: incidentFieldName,
      returnDistinctValues: "true",
      f: "json"
    });

    chipsEl.innerHTML = "";
    noIncidentsMsg.style.display = "none";

    fetch(incidentLayerUrl + "?" + params.toString())
      .then(r => {
        if (!r.ok) {
          throw new Error(`HTTP error ${r.status}`);
        }
        return r.json();
      })
      .then(data => {
        const features = data.features || [];

        const seen = new Set();
        const incidentNames = [];

        features.forEach(f => {
          const raw = f.attributes && f.attributes[incidentFieldName];
          if (!raw) return;

          const name = String(raw).trim();
          if (!name) return;

          const key = name.toLowerCase();
          if (seen.has(key)) return;

          seen.add(key);
          incidentNames.push(name);
        });

        if (INCIDENT) {
          const target = INCIDENT.toLowerCase();
          incidentNames.sort((a, b) => {
            const al = a.toLowerCase();
            const bl = b.toLowerCase();
            if (al === target && bl !== target) return -1;
            if (bl === target && al !== target) return 1;
            return al.localeCompare(bl);
          });
        } else {
          incidentNames.sort((a, b) =>
            a.toLowerCase().localeCompare(b.toLowerCase())
          );
        }

        countBadge.textContent = incidentNames.length;

        if (!incidentNames.length) {
          noIncidentsMsg.style.display = "block";
          return;
        }

        incidentNames.forEach(name => {
          const chip = document.createElement("button");
          chip.className = "incident-chip";
          chip.innerHTML =
            `<span class="incident-chip-dot"></span><span>${name}</span>`;

          chip.onclick = () => {
            const url = new URL(INCIDENT_MAP_URL, window.location.href);
            url.searchParams.set("incident", name);
            window.location.href = url.toString();
          };

          chipsEl.appendChild(chip);
        });
      })
      .catch(err => {
        console.error("Error loading incidents:", err);
        countBadge.textContent = "0";
        noIncidentsMsg.style.display = "block";
      });
  }

  loadIncidentMenu();
  </script>

</body>
</html>
