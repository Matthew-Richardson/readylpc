<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Incident Map & Evacuation Info</title>

  <!-- DNS prefetch & preconnect for external resources -->
  <link rel="dns-prefetch" href="//js.arcgis.com">
  <link rel="dns-prefetch" href="//services2.arcgis.com">
  <link rel="dns-prefetch" href="//cms9files.revize.com">
  <link rel="preconnect" href="https://js.arcgis.com" crossorigin>
  <link rel="preconnect" href="https://services2.arcgis.com" crossorigin>

  <!-- Critical CSS inline for fastest first paint -->
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;font-family:Arial,sans-serif;background:#f5f5f7;font-size:18px;overflow-x:hidden;color:#000}
    .page-shell{min-height:100vh;display:flex;flex-direction:column}
    .map-wrapper{max-width:900px;width:100%;margin:16px auto 0;padding:12px}
    .map-card{width:100%;border-radius:14px;border:1px solid rgba(0,0,0,0.2);box-shadow:0 2px 10px rgba(0,0,0,0.25);overflow:hidden;background:#fff;display:flex;flex-direction:column}
    #viewDiv{width:100%;height:460px;background:#e5e5e5}
  </style>

  <!-- Non-critical CSS loaded async -->
  <link rel="stylesheet" href="shared-styles.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="shared-styles.css"></noscript>

  <!-- ArcGIS CSS - loaded async -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css"></noscript>
</head>

<body>
  <div class="page-shell">
    <div class="map-wrapper">
      <div class="map-card">

        <div class="card-brand">
          <img
            src="https://cms9files.revize.com/laplata/_assets_/images/logo.png"
            alt="La Plata County Logo"
            class="header-logo"
            width="260"
            height="auto"
            loading="eager"
            fetchpriority="high"
            decoding="async"
          >
          <div class="site-title">ReadyLaPlata<span class="title-break"> ‚Äî </span><span class="title-sub">La Plata County Evacuation Viewer</span></div>
          <div class="call-center">
            <strong>Call Center</strong>
            <a href="tel:9703858700">970-385-8700</a>
          </div>
        </div>

        <div class="card-divider"></div>

        <div class="incident-strip">
          <div class="incident-strip-top">
            <div class="incident-bar-left">
              <span class="incident-label">
                Active incidents
                <span id="incidentCountBadge" class="incident-count-badge">0</span>
              </span>
            </div>
            <button id="infoButton" class="info-link" type="button" aria-label="Evacuation Information">
              <span class="info-icon-home">üè†</span>
              <span class="info-label">Evacuation Information</span>
            </button>
          </div>

          <div class="incident-tip">Tap an incident below to view the evacuation map.</div>
          <div id="incidentChips" class="incident-chips"></div>
          <div id="noIncidentsMsg" class="incident-none" style="display:none">No active incidents are listed.</div>
        </div>

        <div class="card-divider"></div>
        <div id="viewDiv"></div>

        <div class="map-key-merged">
          <div class="legend-title">Map Key</div>
          <div class="legend-items">
            <div class="legend-item">
              <span class="legend-icon-road"></span>
              <span>Road closure</span>
            </div>
            <div class="legend-item">
              <span class="legend-icon-info">i</span>
              <span>Information</span>
            </div>
            <div class="legend-item">
              <span class="legend-icon-warning"></span>
              <span>Special warning</span>
            </div>
          </div>
        </div>

      </div>
    </div>

    <main>
      <div id="evacRow" class="evac-row">Loading evacuation information‚Ä¶</div>
      <div class="incident-panel">
        <div id="incident-panel">Loading incident status‚Ä¶</div>
      </div>
    </main>
  </div>

  <!-- Floating CodeRED Button -->
  <a href="sms:99411?&body=LPCOEM" class="codered-fab">
    <span class="codered-fab-icon">üîî</span>
    <span class="codered-fab-text">CodeRED Alerts</span>
  </a>

  <!-- ArcGIS SDK loaded with defer -->
  <script src="https://js.arcgis.com/4.31/" defer></script>

  <script>
  (function() {
    'use strict';

    // ========== CONFIGURATION ==========
    const CONFIG = {
      webmapId: '58a8bb313db64271a55e7960cb839f64',
      incidentLayerUrl: 'https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0',
      statusBaseUrl: 'https://script.google.com/macros/s/AKfycbxOFlSc6xXHqERr7n9VQbfnXnPGRqsvbgUs5lx4y6cy9YfnYSGFkLk5nSut66ecoRUwtA/exec',
      incidentField: 'incident',
      statusValues: { SET: 'Set', GO: 'Go' }
    };

    const STATUS_DATA = {
      SET: {
        label: 'SET - Pre-Evacuation',
        color: '#fff36a',
        text: 'Voluntary Evacuation;<br>Evacuation orders are likely'
      },
      GO: {
        label: 'GO - Evacuate Now',
        color: '#41f56e',
        text: '<strong>LEAVE NOW.</strong> Immediate threat to life.<br>This area is closed to public access.'
      }
    };

    // ========== CACHED DOM ELEMENTS ==========
    const DOM = {};
    function cacheDOM() {
      DOM.evacRow = document.getElementById('evacRow');
      DOM.incidentPanel = document.getElementById('incident-panel');
      DOM.chipsEl = document.getElementById('incidentChips');
      DOM.countBadge = document.getElementById('incidentCountBadge');
      DOM.noIncidentsMsg = document.getElementById('noIncidentsMsg');
      DOM.infoButton = document.getElementById('infoButton');
    }

    // ========== UTILITIES ==========
    const INCIDENT = (() => {
      try {
        const params = new URLSearchParams(location.search);
        const inc = (params.get('incident') || params.get('Incident') || '').trim();
        return inc || null;
      } catch { return null; }
    })();

    const escapeQuery = str => str.replace(/'/g, "''");

    // ========== HTML BUILDERS ==========
    function buildBox(statusCode, features) {
      const data = STATUS_DATA[statusCode];
      const hasFeatures = features && features.length;
      
      const zonesHTML = hasFeatures
        ? `<div class="evac-zones">${features.map(f => 
            `<div class="zone-chip">${f.attributes.zonename}</div>`
          ).join('')}</div>`
        : `<div class="evac-zones"><div class="no-zones-chip">No ${statusCode} zones</div></div>`;

      const boxClass = statusCode === 'GO' ? ' evac-box-go' : statusCode === 'SET' ? ' evac-box-set' : '';

      return `<div class="evac-box${boxClass}" style="background:${data.color}">
        <div class="evac-title">${data.label}</div>
        <div class="evac-body">
          <div>The following zones are under ${statusCode} status for <strong>${INCIDENT || 'this incident'}</strong>.</div>
          ${zonesHTML}
          <div class="evac-note">${data.text}</div>
        </div>
      </div>`;
    }

    function showHelp() {
      DOM.evacRow.innerHTML = `<div class="evac-box" style="background:#f3f4f6">
        <div class="evac-title">How to use this page</div>
        <div class="evac-body">
          <div>This evacuation information requires an <strong>incident name</strong> in the URL.</div>
          <div style="margin-top:8px">Use this format:<br><code>?incident=YourIncidentName</code></div>
          <div style="margin-top:8px">Example:<br><code>?incident=East%20Canyon</code></div>
        </div>
      </div>`;

      DOM.incidentPanel.innerHTML = `<div class="evac-box" style="background:#f3f4f6">
        <div class="evac-title">Incident status</div>
        <div class="evac-body">
          <div>No incident was specified.</div>
          <div style="margin-top:8px">Append <code>?incident=YourIncidentName</code> to the URL.</div>
        </div>
      </div>`;
    }

    function showError(message) {
      DOM.evacRow.innerHTML = `<div class="evac-box" style="background:#fff36a">
        <div class="evac-title">Error</div>
        <div class="evac-body">${message}</div>
      </div>`;
    }

    // ========== DATA FETCHING ==========
    async function loadEvacuationZones() {
      if (!INCIDENT) { showHelp(); return; }

      const where = `incident='${escapeQuery(INCIDENT)}' AND STATUS IN ('${CONFIG.statusValues.SET}','${CONFIG.statusValues.GO}')`;
      const params = new URLSearchParams({ where, outFields: '*', f: 'json', returnGeometry: 'false' });

      try {
        const res = await fetch(`${CONFIG.incidentLayerUrl}/query?${params}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data.features?.length) {
          DOM.evacRow.innerHTML = `<div class="evac-box" style="background:#fff36a">
            <div class="evac-title">No data</div>
            <div class="evac-body">No zones found for <strong>${INCIDENT}</strong>.</div>
          </div>`;
          return;
        }

        const setFeatures = data.features.filter(f => f.attributes.STATUS === CONFIG.statusValues.SET);
        const goFeatures = data.features.filter(f => f.attributes.STATUS === CONFIG.statusValues.GO);
        DOM.evacRow.innerHTML = buildBox('SET', setFeatures) + buildBox('GO', goFeatures);
      } catch (err) {
        console.error('Error loading evacuation zones:', err);
        showError(`Failed to load evacuation data: ${err.message}`);
      }
    }

    async function loadIncidentStatus() {
      if (!INCIDENT) return;

      try {
        const res = await fetch(`${CONFIG.statusBaseUrl}?incident=${encodeURIComponent(INCIDENT)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const html = await res.text();

        DOM.incidentPanel.innerHTML = `<div class="status-html">${html}</div>
          <div class="status-timestamp">
            Last loaded: ${new Date().toLocaleString()}
            &nbsp;‚Ä¢&nbsp;
            <span class="source-label">Source: La Plata County Office of Emergency Management</span>
          </div>`;
      } catch (err) {
        console.error('Error loading incident status:', err);
        DOM.incidentPanel.innerHTML = '<div>Error loading incident status.</div>';
      }
    }

    // ========== MAP INITIALIZATION ==========
    function initMap() {
      if (typeof require === 'undefined') {
        // ArcGIS not loaded yet, wait
        setTimeout(initMap, 100);
        return;
      }

      require([
        'esri/WebMap',
        'esri/views/MapView',
        'esri/layers/FeatureLayer',
        'esri/widgets/Search',
        'esri/widgets/Fullscreen'
      ], (WebMap, MapView, FeatureLayer, Search, Fullscreen) => {

        DOM.infoButton.addEventListener('click', () => { location.href = 'info.html'; });

        const webmap = new WebMap({ portalItem: { id: CONFIG.webmapId } });
        const view = new MapView({ container: 'viewDiv', map: webmap });

        // Disable scroll zoom on mobile for better UX
        if (window.innerWidth < 700 && view.navigation) {
          view.navigation.mouseWheelZoomEnabled = false;
          if ('browserTouchPanEnabled' in view.navigation) view.navigation.browserTouchPanEnabled = false;
        }

        const incidentLayer = new FeatureLayer({
          url: CONFIG.incidentLayerUrl,
          outFields: ['*'],
          visible: false,
          listMode: 'hide'
        });
        webmap.add(incidentLayer);

        const zoomToIncident = name => {
          const where = `${CONFIG.incidentField} = '${escapeQuery(name)}'`;
          return incidentLayer.queryExtent({ where })
            .then(res => res.extent && view.goTo(res.extent.expand(1.2)))
            .catch(console.error);
        };

        view.when()
          .then(() => {
            view.ui.add(new Search({ view, includeDefaultSources: true }), 'top-right');
            view.ui.add(new Fullscreen({ view }), 'top-right');
            return incidentLayer.when();
          })
          .then(() => incidentLayer.queryFeatures({
            where: '1=1',
            outFields: [CONFIG.incidentField],
            returnDistinctValues: true,
            orderByFields: [CONFIG.incidentField]
          }))
          .then(fs => {
            const names = (fs.features || [])
              .map(f => f.attributes[CONFIG.incidentField])
              .filter(Boolean);

            DOM.countBadge.textContent = names.length;

            if (!names.length) {
              DOM.noIncidentsMsg.style.display = 'block';
              return;
            }
            DOM.noIncidentsMsg.style.display = 'none';

            // Sort: current incident first, then alphabetical
            const target = INCIDENT?.toLowerCase();
            names.sort((a, b) => {
              const al = a.toLowerCase(), bl = b.toLowerCase();
              if (target) {
                if (al === target && bl !== target) return -1;
                if (bl === target && al !== target) return 1;
              }
              return al.localeCompare(bl);
            });

            // Build chips with document fragment for single reflow
            const frag = document.createDocumentFragment();
            names.forEach(name => {
              const chip = document.createElement('button');
              chip.className = 'incident-chip';
              chip.dataset.incident = name;
              chip.innerHTML = `<span class="incident-chip-dot"></span><span>${name}</span>`;
              chip.addEventListener('click', () => {
                const url = new URL(location.href);
                url.searchParams.set('incident', name);
                location.href = url;
              });
              frag.appendChild(chip);
            });
            DOM.chipsEl.appendChild(frag);

            // Highlight active incident
            if (INCIDENT) {
              const match = DOM.chipsEl.querySelector(`[data-incident="${INCIDENT}"]`);
              if (match) {
                match.classList.add('active');
                zoomToIncident(INCIDENT);
              }
            }
          })
          .catch(err => {
            console.error('Error loading incidents:', err);
            DOM.countBadge.textContent = '0';
          });
      });
    }

    // ========== INIT ==========
    function init() {
      cacheDOM();
      // Fire data fetches immediately (don't wait for map)
      loadEvacuationZones();
      loadIncidentStatus();
      // Init map when ArcGIS SDK is ready
      initMap();
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
  </script>
</body>
</html>
