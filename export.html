<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodeRED KML Export â€” ReadyLaPlata</title>
  <meta name="description" content="Export evacuation zones as KML for CodeRED notifications.">
  <meta name="theme-color" content="#2d3436">
  
  <!-- Performance: DNS prefetch for external resources -->
  <link rel="dns-prefetch" href="//js.arcgis.com">
  <link rel="dns-prefetch" href="//services2.arcgis.com">
  <link rel="preconnect" href="https://js.arcgis.com" crossorigin>
  
  <style>
    /* ========================================
       Base Styles
       ======================================== */
    *, *::before, *::after { box-sizing: border-box; }
    
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      font-size: 16px;
      line-height: 1.5;
    }
    
    /* ========================================
       Layout
       ======================================== */
    .page-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .brand-banner {
      background: linear-gradient(135deg, #2d3436 0%, #434a4d 50%, #2d3436 100%);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
    }
    
    .header-logo { height: 48px; width: auto; }
    .brand-text { color: #fff; }
    .site-name { font-size: 22px; font-weight: 700; letter-spacing: -0.3px; }
    .site-subtitle { font-size: 13px; opacity: 0.9; margin-top: 2px; }
    
    .content-wrapper {
      flex: 1;
      max-width: 680px;
      width: 100%;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    
    .page-title { font-size: 28px; font-weight: 700; margin: 0 0 8px; color: #1d1d1f; }
    .page-subtitle { font-size: 15px; color: #6e6e73; margin: 0 0 32px; }
    
    /* ========================================
       Card Component
       ======================================== */
    .export-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08), 0 1px 3px rgba(0,0,0,0.06);
      padding: 28px;
      margin-bottom: 24px;
    }
    
    .card-section { margin-bottom: 28px; }
    .card-section:last-child { margin-bottom: 0; }
    
    .section-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #86868b;
      margin-bottom: 10px;
    }
    
    /* ========================================
       Form Elements
       ======================================== */
    .incident-select-wrapper { position: relative; }
    
    .incident-select {
      width: 100%;
      padding: 14px 48px 14px 16px;
      font-size: 16px;
      font-family: inherit;
      border: 2px solid #d2d2d7;
      border-radius: 12px;
      background: #fff;
      color: #1d1d1f;
      appearance: none;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .incident-select:hover { border-color: #0b4da2; }
    .incident-select:focus { outline: none; border-color: #0b4da2; box-shadow: 0 0 0 4px rgba(11, 77, 162, 0.15); }
    .incident-select:disabled { background: #f5f5f7; color: #86868b; cursor: not-allowed; }
    
    .select-arrow {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      pointer-events: none;
      color: #86868b;
    }
    
    /* ========================================
       Info Box
       ======================================== */
    .info-box {
      background: #f0f7ff;
      border: 1px solid #b3d4fc;
      border-radius: 10px;
      padding: 14px 16px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    
    .info-box svg { width: 20px; height: 20px; color: #0b4da2; flex-shrink: 0; margin-top: 1px; }
    .info-box p { margin: 0; font-size: 14px; color: #1d1d1f; }
    
    /* ========================================
       Export Button
       ======================================== */
    .export-btn {
      width: 100%;
      padding: 16px 24px;
      font-size: 17px;
      font-weight: 600;
      font-family: inherit;
      color: #fff;
      background: linear-gradient(135deg, #0b4da2 0%, #1565c0 100%);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s;
      box-shadow: 0 4px 14px rgba(11, 77, 162, 0.35);
    }
    
    .export-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(11, 77, 162, 0.45); }
    .export-btn:active:not(:disabled) { transform: translateY(0); }
    .export-btn:disabled { background: #d2d2d7; box-shadow: none; cursor: not-allowed; }
    .export-btn svg { width: 22px; height: 22px; }
    
    /* Loading spinner */
    .spinner {
      width: 22px;
      height: 22px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* ========================================
       Status Messages
       ======================================== */
    .status-msg {
      text-align: center;
      padding: 16px;
      border-radius: 10px;
      font-size: 14px;
      margin-top: 16px;
      display: none;
    }
    
    .status-msg.show { display: block; }
    .status-msg.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
    .status-msg.error { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
    .status-msg.loading { background: #fff8e1; color: #f57c00; border: 1px solid #ffe082; }
    
    /* ========================================
       Feature Count & Zone List
       ======================================== */
    .feature-count { font-size: 14px; color: #6e6e73; margin-top: 10px; display: none; }
    .feature-count.show { display: block; }
    .feature-count strong { color: #1d1d1f; }
    
    .zone-list {
      margin-top: 12px;
      padding: 12px 14px;
      background: #f9f9fb;
      border: 1px solid #e5e5e7;
      border-radius: 8px;
      display: none;
    }
    
    .zone-list.show { display: block; }
    
    .zone-list-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #86868b;
      margin-bottom: 8px;
    }
    
    .zone-list-items {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    /* Zone status chips */
    .zone-chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      background: #fff;
      border: 1px solid #d2d2d7;
      border-radius: 14px;
      font-size: 13px;
      color: #1d1d1f;
    }
    
    .zone-chip.status-set {
      background: #fff9c4;
      border-color: #fdd835;
      color: #f57f17;
    }
    
    .zone-chip.status-go {
      background: #e8f5e9;
      border-color: #81c784;
      color: #2e7d32;
    }
    
    /* ========================================
       Navigation & Footer
       ======================================== */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #0b4da2;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
      margin-bottom: 20px;
      transition: color 0.2s;
    }
    
    .back-link:hover { color: #1565c0; }
    .back-link svg { width: 18px; height: 18px; }
    
    .page-footer {
      background: #1d1d1f;
      color: rgba(255,255,255,0.7);
      padding: 20px;
      text-align: center;
      font-size: 13px;
      margin-top: auto;
    }
    
    .page-footer a { color: #fff; text-decoration: none; }
    .page-footer a:hover { text-decoration: underline; }
    
    /* ========================================
       Empty State
       ======================================== */
    .empty-state { text-align: center; padding: 40px 20px; color: #6e6e73; }
    .empty-state svg { width: 48px; height: 48px; color: #d2d2d7; margin-bottom: 16px; }
    .empty-state h3 { margin: 0 0 8px; color: #1d1d1f; font-size: 18px; }
    .empty-state p { margin: 0; font-size: 14px; }
    
    /* ========================================
       Responsive Design
       ======================================== */
    @media (max-width: 480px) {
      .brand-banner { padding: 12px 16px; gap: 12px; }
      .header-logo { height: 40px; }
      .site-name { font-size: 18px; }
      .site-subtitle { font-size: 12px; }
      .content-wrapper { padding: 16px 12px 32px; }
      .page-title { font-size: 24px; }
      .export-card { padding: 20px; border-radius: 12px; }
    }
  </style>
</head>

<body>
  <div class="page-shell">
    
    <!-- Header -->
    <header class="brand-banner">
      <img src="https://cms9files.revize.com/laplata/_assets_/images/logo.png" 
           alt="La Plata County Logo" 
           class="header-logo" 
           width="180" 
           height="auto" 
           loading="eager">
      <div class="brand-text">
        <div class="site-name">ReadyLaPlata</div>
        <div class="site-subtitle">La Plata County Evacuation Viewer</div>
      </div>
    </header>
    
    <!-- Main Content -->
    <main class="content-wrapper">
      
      <a href="index.html" class="back-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
        Back to Home
      </a>
      
      <h1 class="page-title">Export for CodeRED</h1>
      <p class="page-subtitle">Export evacuation zones as a dissolved KML boundary for CodeRED notifications.</p>
      
      <!-- Export Card -->
      <div id="exportCard" class="export-card">
        
        <!-- Incident Selector -->
        <div class="card-section">
          <div class="section-label">Select Incident</div>
          <div class="incident-select-wrapper">
            <select id="incidentSelect" class="incident-select" disabled>
              <option value="">Loading incidents...</option>
            </select>
            <svg class="select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          <div id="featureCount" class="feature-count"></div>
          <div id="zoneList" class="zone-list">
            <div class="zone-list-label">Zones to export</div>
            <div id="zoneListItems" class="zone-list-items"></div>
          </div>
        </div>
        
        <!-- Info Box -->
        <div class="card-section">
          <div class="info-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="16" x2="12" y2="12"/>
              <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
            <p>
              Exports as <strong>KML</strong> with all zones dissolved into a single boundary for CodeRED
            </p>
          </div>
        </div>
        
        <!-- Export Button -->
        <div class="card-section">
          <button id="exportBtn" class="export-btn" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            <span id="btnText">Export KML</span>
          </button>
          <div id="statusMsg" class="status-msg"></div>
        </div>
        
      </div>
      
      <!-- Empty State (shown when no incidents available) -->
      <div id="emptyState" class="export-card empty-state" style="display: none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="9" y1="15" x2="15" y2="15"/>
        </svg>
        <h3>No Incidents Available</h3>
        <p>There are currently no incidents with evacuation zones to export.</p>
      </div>
      
    </main>
    
    <!-- Footer -->
    <footer class="page-footer">
      <a href="https://www.co.laplata.co.us/government/departments/emergency_management/index.php">
        La Plata County Office of Emergency Management
      </a>
    </footer>
    
  </div>
  
  <!-- ArcGIS JavaScript API -->
  <script src="https://js.arcgis.com/4.31/"></script>
  
  <script>
    /**
     * CodeRED KML Export Tool
     * 
     * This tool exports evacuation zones from ArcGIS Feature Layer as KML files
     * for use in CodeRED emergency notification system.
     * 
     * Features:
     * - Queries evacuation zones by incident from ArcGIS Online
     * - Dissolves multiple zones into a single convex hull boundary
     * - Generates KML file compatible with CodeRED
     * 
     * Security Considerations:
     * - SQL injection prevented via parameterized escaping of incident names
     * - XSS prevented via XML entity escaping in KML output
     * - No user data stored; all processing client-side
     * - Feature layer URL is read-only public data
     */
    
    'use strict';
    
    // ========================================
    // Configuration
    // ========================================
    var CONFIG = {
      // ArcGIS Feature Layer URL (read-only public layer)
      featureLayerUrl: 'https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0',
      // Output spatial reference (WGS84 for KML compatibility)
      outSR: 4326
    };
    
    // ========================================
    // DOM Element References
    // ========================================
    var incidentSelect = document.getElementById('incidentSelect');
    var exportBtn = document.getElementById('exportBtn');
    var statusMsg = document.getElementById('statusMsg');
    var featureCountEl = document.getElementById('featureCount');
    var zoneListEl = document.getElementById('zoneList');
    var zoneListItemsEl = document.getElementById('zoneListItems');
    var emptyState = document.getElementById('emptyState');
    var exportCard = document.getElementById('exportCard');
    
    // ========================================
    // Application State
    // ========================================
    var featureLayer = null;
    var incidentFeatureCounts = {};  // Count of zones per incident
    var incidentZones = {};          // Zone details per incident
    
    // ========================================
    // UI Helper Functions
    // ========================================
    
    /**
     * Display a status message to the user
     * @param {string} message - Message to display
     * @param {string} type - Message type: 'success', 'error', or 'loading'
     */
    function showStatus(message, type) {
      statusMsg.textContent = message;
      statusMsg.className = 'status-msg show ' + type;
    }
    
    /**
     * Hide the status message
     */
    function hideStatus() {
      statusMsg.className = 'status-msg';
    }
    
    /**
     * Set the export button loading state
     * @param {boolean} loading - Whether the button should show loading state
     */
    function setButtonLoading(loading) {
      if (loading) {
        exportBtn.disabled = true;
        exportBtn.innerHTML = '<div class="spinner"></div><span>Exporting...</span>';
      } else {
        exportBtn.disabled = !incidentSelect.value;
        exportBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg><span>Export KML</span>';
      }
    }
    
    // ========================================
    // Data Helper Functions
    // ========================================
    
    /**
     * Get attribute value with case-insensitive fallback
     * Handles inconsistent field name casing from ArcGIS
     * @param {Object} attrs - Feature attributes object
     * @param {string} key1 - Primary key to check
     * @param {string} key2 - Secondary key to check
     * @param {string} key3 - Tertiary key to check
     * @returns {*} Attribute value or null
     */
    function getAttr(attrs, key1, key2, key3) {
      if (attrs[key1] !== undefined) return attrs[key1];
      if (attrs[key2] !== undefined) return attrs[key2];
      if (attrs[key3] !== undefined) return attrs[key3];
      if (attrs[key1.toLowerCase()] !== undefined) return attrs[key1.toLowerCase()];
      if (attrs[key1.toUpperCase()] !== undefined) return attrs[key1.toUpperCase()];
      return null;
    }
    
    /**
     * Convert ArcGIS feature to GeoJSON format
     * @param {Object} feature - ArcGIS feature object
     * @returns {Object|null} GeoJSON feature or null if invalid
     */
    function arcgisToGeoJSON(feature) {
      var geom = feature.geometry;
      var attrs = feature.attributes;
      
      if (!geom) return null;
      
      var geometry = null;
      
      // Handle polygon geometry (rings)
      if (geom.rings) {
        geometry = {
          type: 'Polygon',
          coordinates: geom.rings.map(function(ring) {
            return ring.map(function(pt) { return [pt[0], pt[1]]; });
          })
        };
      }
      
      if (!geometry) return null;
      
      // Copy attributes to properties
      var props = {};
      for (var key in attrs) {
        if (attrs.hasOwnProperty(key)) {
          props[key] = attrs[key];
        }
      }
      
      return { type: 'Feature', geometry: geometry, properties: props };
    }
    
    // ========================================
    // Geometry Functions
    // ========================================
    
    /**
     * Compute convex hull of a set of points using gift wrapping algorithm
     * Creates a single boundary polygon that encompasses all input points
     * @param {Array} points - Array of [x, y] coordinate pairs
     * @returns {Array} Array of [x, y] coordinates forming the convex hull (closed ring)
     */
    function convexHull(points) {
      // Remove duplicate points
      var unique = [];
      var seen = {};
      points.forEach(function(pt) {
        var key = pt[0] + ',' + pt[1];
        if (!seen[key]) {
          seen[key] = true;
          unique.push(pt);
        }
      });
      points = unique;
      
      // Need at least 3 points for a polygon
      if (points.length < 3) return points;
      
      // Find leftmost point as starting point
      var start = 0;
      for (var i = 1; i < points.length; i++) {
        if (points[i][0] < points[start][0]) {
          start = i;
        }
      }
      
      var hull = [];
      var current = start;
      var next;
      
      // Gift wrapping algorithm
      do {
        hull.push(points[current]);
        next = 0;
        
        for (var j = 1; j < points.length; j++) {
          if (next === current) {
            next = j;
            continue;
          }
          
          // Cross product to determine turn direction
          // Positive = counter-clockwise turn (point is more left)
          var cross = (points[j][0] - points[current][0]) * (points[next][1] - points[current][1]) -
                      (points[j][1] - points[current][1]) * (points[next][0] - points[current][0]);
          
          if (cross > 0) {
            next = j;
          }
        }
        
        current = next;
      } while (current !== start && hull.length < points.length);
      
      // Close the ring (first point = last point)
      hull.push(hull[0]);
      
      return hull;
    }
    
    // ========================================
    // KML Generation
    // ========================================
    
    /**
     * Escape special XML characters to prevent XSS
     * @param {string} str - String to escape
     * @returns {string} Escaped string safe for XML
     */
    function escapeXml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&apos;');
    }
    
    /**
     * Generate KML document from GeoJSON
     * @param {Object} geojson - GeoJSON FeatureCollection with single dissolved feature
     * @param {string} incidentName - Name of the incident for the KML document
     * @returns {string} KML document as string
     */
    function generateKML(geojson, incidentName) {
      var feature = geojson.features[0];
      var props = feature.properties || {};
      
      var kml = '<?xml version="1.0" encoding="UTF-8"?>\n';
      kml += '<kml xmlns="http://www.opengis.net/kml/2.2">\n';
      kml += '  <Document>\n';
      kml += '    <name>' + escapeXml(incidentName) + '</name>\n';
      
      // Define style for evacuation zone polygon
      kml += '    <Style id="evacuationStyle">\n';
      kml += '      <PolyStyle><color>7f0000ff</color><outline>1</outline></PolyStyle>\n';
      kml += '      <LineStyle><color>ff0000cc</color><width>2</width></LineStyle>\n';
      kml += '    </Style>\n';
      
      // Create placemark with polygon
      kml += '    <Placemark>\n';
      kml += '      <name>' + escapeXml(props.name || incidentName) + '</name>\n';
      if (props.zones) {
        kml += '      <description>' + escapeXml(props.zones) + '</description>\n';
      }
      kml += '      <styleUrl>#evacuationStyle</styleUrl>\n';
      
      // Output polygon coordinates
      if (feature.geometry.type === 'Polygon') {
        kml += '      <Polygon>\n';
        kml += '        <outerBoundaryIs><LinearRing><coordinates>\n';
        kml += '          ' + feature.geometry.coordinates[0].map(function(pt) {
          return pt[0] + ',' + pt[1] + ',0';
        }).join(' ') + '\n';
        kml += '        </coordinates></LinearRing></outerBoundaryIs>\n';
        kml += '      </Polygon>\n';
      }
      
      kml += '    </Placemark>\n';
      kml += '  </Document>\n';
      kml += '</kml>';
      
      return kml;
    }
    
    // ========================================
    // ArcGIS Integration
    // ========================================
    
    require(['esri/layers/FeatureLayer'], function(FeatureLayer) {
      
      // Initialize feature layer connection
      featureLayer = new FeatureLayer({ url: CONFIG.featureLayerUrl });
      
      // Load available incidents on page load
      loadIncidents();
      
      /**
       * Load all incidents from the feature layer
       * Groups zones by incident name and populates the dropdown
       */
      function loadIncidents() {
        var query = featureLayer.createQuery();
        query.where = '1=1';  // Get all features
        query.outFields = ['*'];
        query.returnGeometry = false;  // Don't need geometry for listing
        
        featureLayer.queryFeatures(query).then(function(result) {
          var incidents = {};
          
          // Group zones by incident
          result.features.forEach(function(f) {
            var incident = getAttr(f.attributes, 'incident', 'Incident', 'INCIDENT');
            if (incident && String(incident).trim()) {
              var incName = String(incident).trim();
              if (!incidents[incName]) {
                incidents[incName] = [];
              }
              
              var zoneName = getAttr(f.attributes, 'zonename', 'Zonename', 'ZONENAME') || 
                             getAttr(f.attributes, 'zone', 'Zone', 'ZONE') || 'Unknown';
              var status = getAttr(f.attributes, 'status', 'Status', 'STATUS') || '';
              
              incidents[incName].push({
                name: String(zoneName),
                status: String(status).toLowerCase()
              });
            }
          });
          
          var incidentList = Object.keys(incidents).sort();
          
          // Show empty state if no incidents
          if (incidentList.length === 0) {
            exportCard.style.display = 'none';
            emptyState.style.display = 'block';
            return;
          }
          
          // Store zone details and counts
          incidentList.forEach(function(inc) {
            incidentZones[inc] = incidents[inc];
            incidentFeatureCounts[inc] = incidents[inc].length;
          });
          
          // Populate dropdown
          incidentSelect.innerHTML = '<option value="">Select an incident...</option>';
          incidentList.forEach(function(inc) {
            var count = incidentFeatureCounts[inc] || 0;
            var opt = document.createElement('option');
            opt.value = inc;
            opt.textContent = inc + ' (' + count + ' zone' + (count !== 1 ? 's' : '') + ')';
            incidentSelect.appendChild(opt);
          });
          
          incidentSelect.disabled = false;
          
        }).catch(function(err) {
          console.error('Error loading incidents:', err);
          incidentSelect.innerHTML = '<option value="">Error loading incidents</option>';
          showStatus('Failed to load incidents: ' + err.message, 'error');
        });
      }
      
      // ========================================
      // Event Handlers
      // ========================================
      
      /**
       * Handle incident selection change
       * Updates the zone list display and enables/disables export button
       */
      incidentSelect.addEventListener('change', function() {
        var selected = this.value;
        hideStatus();
        
        if (selected) {
          exportBtn.disabled = false;
          var count = incidentFeatureCounts[selected] || 0;
          featureCountEl.innerHTML = '<strong>' + count + '</strong> evacuation zone' + (count !== 1 ? 's' : '') + ' will be dissolved into single boundary';
          featureCountEl.classList.add('show');
          
          // Display zone chips
          var zones = incidentZones[selected] || [];
          if (zones.length > 0) {
            zoneListItemsEl.innerHTML = '';
            zones.forEach(function(zone) {
              var chip = document.createElement('span');
              chip.className = 'zone-chip';
              if (zone.status === 'set') {
                chip.className += ' status-set';
              } else if (zone.status === 'go') {
                chip.className += ' status-go';
              }
              chip.textContent = zone.name;
              zoneListItemsEl.appendChild(chip);
            });
            zoneListEl.classList.add('show');
          } else {
            zoneListEl.classList.remove('show');
          }
        } else {
          exportBtn.disabled = true;
          featureCountEl.classList.remove('show');
          zoneListEl.classList.remove('show');
        }
      });
      
      /**
       * Handle export button click
       * Queries features, dissolves into convex hull, and generates KML download
       */
      exportBtn.addEventListener('click', function() {
        var incident = incidentSelect.value;
        if (!incident) return;
        
        setButtonLoading(true);
        hideStatus();
        showStatus('Querying features...', 'loading');
        
        // Build query with escaped incident name to prevent SQL injection
        var query = featureLayer.createQuery();
        query.where = "incident = '" + incident.replace(/'/g, "''") + "'";
        query.outFields = ['*'];
        query.returnGeometry = true;
        query.outSpatialReference = { wkid: CONFIG.outSR };
        
        featureLayer.queryFeatures(query).then(function(result) {
          
          if (!result.features || result.features.length === 0) {
            showStatus('No features found for this incident.', 'error');
            setButtonLoading(false);
            return;
          }
          
          showStatus('Converting ' + result.features.length + ' features...', 'loading');
          
          // Convert to GeoJSON
          var geoJSONFeatures = result.features
            .map(function(f) { return arcgisToGeoJSON(f); })
            .filter(function(f) { return f !== null; });
          
          if (geoJSONFeatures.length === 0) {
            showStatus('Could not convert features.', 'error');
            setButtonLoading(false);
            return;
          }
          
          // Generate filename: first 3 letters of incident + datetime
          var prefix = incident.replace(/[^a-zA-Z]/g, '').substring(0, 3).toUpperCase();
          if (prefix.length < 3) prefix = (prefix + 'XXX').substring(0, 3);
          var now = new Date();
          var datetime = now.getFullYear().toString() +
                        ('0' + (now.getMonth() + 1)).slice(-2) +
                        ('0' + now.getDate()).slice(-2) + '_' +
                        ('0' + now.getHours()).slice(-2) +
                        ('0' + now.getMinutes()).slice(-2);
          var filename = prefix + '_' + datetime;
          
          try {
            showStatus('Dissolving ' + geoJSONFeatures.length + ' zones into single boundary...', 'loading');
            
            // Collect all points from all polygon outer rings
            var allPoints = [];
            var zoneNames = [];
            
            geoJSONFeatures.forEach(function(feature) {
              var props = feature.properties || {};
              var zoneName = props.zonename || props.ZONENAME || props.zone || 'Zone';
              var status = props.STATUS || props.status || '';
              zoneNames.push(zoneName + (status ? ' (' + status + ')' : ''));
              
              if (feature.geometry.type === 'Polygon') {
                // Get outer ring points (first ring)
                feature.geometry.coordinates[0].forEach(function(pt) {
                  allPoints.push(pt);
                });
              }
            });
            
            // Compute convex hull to create single dissolved boundary
            var hull = convexHull(allPoints);
            
            // Create single dissolved feature
            var dissolvedFeature = {
              type: 'Feature',
              properties: {
                name: incident,
                zones: zoneNames.join(', ')
              },
              geometry: {
                type: 'Polygon',
                coordinates: [hull]
              }
            };
            
            var dissolvedGeoJSON = { type: 'FeatureCollection', features: [dissolvedFeature] };
            
            // Generate KML
            var kmlContent = generateKML(dissolvedGeoJSON, incident);
            
            // Create download
            var blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename + '.kml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('Successfully exported dissolved boundary!', 'success');
            setButtonLoading(false);
            
          } catch (exportErr) {
            console.error('Export generation error:', exportErr);
            showStatus('Export failed: ' + exportErr.message, 'error');
            setButtonLoading(false);
          }
          
        }).catch(function(err) {
          console.error('Export error:', err);
          showStatus('Export failed: ' + (err.message || 'Unknown error'), 'error');
          setButtonLoading(false);
        });
      });
      
    });
  </script>
  
</body>
</html>
