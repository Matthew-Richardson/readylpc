<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodeRED KML Export — ReadyLaPlata</title>
  <meta name="description" content="Export evacuation zones as KML for CodeRED notifications.">
  <meta name="theme-color" content="#0b4da2">
  
  <!-- Performance: DNS prefetch for external resources -->
  <link rel="dns-prefetch" href="//js.arcgis.com">
  <link rel="dns-prefetch" href="//services2.arcgis.com">
  <link rel="preconnect" href="https://js.arcgis.com" crossorigin>
  
  <style>
    /* ========================================
       Base Styles
       ======================================== */
    *, *::before, *::after { box-sizing: border-box; }
    
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      color: #1e293b;
      font-size: 16px;
      line-height: 1.5;
    }
    
    /* ========================================
       Layout
       ======================================== */
    .page-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* ========================================
       Header - Matches staff.html
       ======================================== */
    .header {
      background: linear-gradient(135deg, #0b4da2 0%, #083d82 100%);
      padding: 28px 20px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(11,77,162,0.3);
    }
    
    .header-title {
      color: #fff;
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 4px;
      letter-spacing: -0.3px;
    }
    
    .header-subtitle {
      color: rgba(255,255,255,0.85);
      font-size: 13px;
      margin: 0;
    }
    
    .content-wrapper {
      flex: 1;
      max-width: 680px;
      width: 100%;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    
    .page-title { font-size: 28px; font-weight: 700; margin: 0 0 8px; color: #0f172a; }
    .page-subtitle { font-size: 15px; color: #64748b; margin: 0 0 32px; }
    
    /* ========================================
       Card Component
       ======================================== */
    .export-card {
      background: #fff;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
      padding: 28px;
      margin-bottom: 24px;
    }
    
    .card-section { margin-bottom: 28px; }
    .card-section:last-child { margin-bottom: 0; }
    
    .section-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: #475569;
      margin-bottom: 10px;
    }
    
    /* ========================================
       Form Elements
       ======================================== */
    .incident-select-wrapper { position: relative; }
    
    .incident-select {
      width: 100%;
      padding: 14px 48px 14px 16px;
      font-size: 16px;
      font-family: inherit;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      background: #fff;
      color: #1e293b;
      appearance: none;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .incident-select:hover { border-color: #0b4da2; }
    .incident-select:focus { outline: none; border-color: #0b4da2; box-shadow: 0 0 0 3px rgba(11, 77, 162, 0.12); }
    .incident-select:disabled { background: #f8fafc; color: #94a3b8; cursor: not-allowed; }
    
    .select-arrow {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      pointer-events: none;
      color: #94a3b8;
    }
    
    /* ========================================
       Info Box
       ======================================== */
    .info-box {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      border-radius: 10px;
      padding: 14px 16px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    
    .info-box svg { width: 20px; height: 20px; color: #0b4da2; flex-shrink: 0; margin-top: 1px; }
    .info-box p { margin: 0; font-size: 14px; color: #1e293b; }
    
    /* ========================================
       Export Button
       ======================================== */
    .export-btn {
      width: 100%;
      padding: 16px 24px;
      font-size: 17px;
      font-weight: 700;
      font-family: inherit;
      color: #fff;
      background: #0b4da2;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.15s;
      box-shadow: 0 4px 12px rgba(11, 77, 162, 0.25);
    }
    
    .export-btn:hover:not(:disabled) { 
      background: #0a4291;
      transform: translateY(-1px); 
      box-shadow: 0 6px 16px rgba(11, 77, 162, 0.35); 
    }
    .export-btn:active:not(:disabled) { transform: translateY(0); }
    .export-btn:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }
    .export-btn svg { width: 22px; height: 22px; }
    
    /* Loading spinner */
    .spinner {
      width: 22px;
      height: 22px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* ========================================
       Status Messages
       ======================================== */
    .status-msg {
      text-align: center;
      padding: 16px;
      border-radius: 10px;
      font-size: 14px;
      margin-top: 16px;
      display: none;
    }
    
    .status-msg.show { display: block; }
    .status-msg.success { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
    .status-msg.error { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
    .status-msg.loading { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
    
    /* ========================================
       Feature Count & Zone List
       ======================================== */
    .feature-count { font-size: 14px; color: #64748b; margin-top: 10px; display: none; }
    .feature-count.show { display: block; }
    .feature-count strong { color: #0f172a; }
    
    .zone-list {
      margin-top: 12px;
      padding: 12px 14px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      display: none;
    }
    
    .zone-list.show { display: block; }
    
    .zone-list-label {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      color: #64748b;
      margin-bottom: 8px;
    }
    
    .zone-list-items {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    /* Zone status chips */
    .zone-chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      color: #1e293b;
    }
    
    .zone-chip.status-set {
      background: #fef3c7;
      border-color: #fcd34d;
      color: #92400e;
    }
    
    .zone-chip.status-go {
      background: #dcfce7;
      border-color: #86efac;
      color: #166534;
    }
    
    /* ========================================
       Navigation & Footer
       ======================================== */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #0b4da2;
      text-decoration: none;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 20px;
      transition: color 0.15s;
    }
    
    .back-link:hover { color: #0a4291; }
    .back-link svg { width: 18px; height: 18px; }
    
    .page-footer {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: rgba(255,255,255,0.7);
      padding: 20px;
      text-align: center;
      font-size: 13px;
      margin-top: auto;
    }
    
    .page-footer a { color: #fff; text-decoration: none; }
    .page-footer a:hover { text-decoration: underline; }
    
    /* ========================================
       Empty State
       ======================================== */
    .empty-state { text-align: center; padding: 40px 20px; color: #64748b; }
    .empty-state svg { width: 48px; height: 48px; color: #cbd5e1; margin-bottom: 16px; }
    .empty-state h3 { margin: 0 0 8px; color: #0f172a; font-size: 18px; }
    .empty-state p { margin: 0; font-size: 14px; }
    
    /* ========================================
       Responsive Design
       ======================================== */
    @media (max-width: 480px) {
      .header { padding: 20px 16px; }
      .header-title { font-size: 20px; }
      .header-subtitle { font-size: 12px; }
      .content-wrapper { padding: 16px 12px 32px; }
      .page-title { font-size: 24px; }
      .export-card { padding: 20px; border-radius: 12px; }
    }
  </style>
</head>

<body>
  <div class="page-shell">
    
    <!-- Header -->
    <header class="header">
      <h1 class="header-title">CodeRED KML Export</h1>
      <p class="header-subtitle">ReadyLaPlata — Evacuation Zone Export Tool</p>
    </header>
    
    <!-- Main Content -->
    <main class="content-wrapper">
      
      <a href="index.html" class="back-link">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
        Back to Home
      </a>
      
      <h1 class="page-title">Export for CodeRED</h1>
      <p class="page-subtitle">Export evacuation zones as a dissolved KML boundary for CodeRED notifications.</p>
      
      <!-- Export Card -->
      <div id="exportCard" class="export-card">
        
        <!-- Incident Selector -->
        <div class="card-section">
          <div class="section-label">Select Incident</div>
          <div class="incident-select-wrapper">
            <select id="incidentSelect" class="incident-select" disabled>
              <option value="">Loading incidents...</option>
            </select>
            <svg class="select-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          <div id="featureCount" class="feature-count"></div>
          <div id="zoneList" class="zone-list">
            <div class="zone-list-label">Zones to export</div>
            <div id="zoneListItems" class="zone-list-items"></div>
          </div>
        </div>
        
        <!-- Info Box -->
        <div class="card-section">
          <div class="info-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="16" x2="12" y2="12"/>
              <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
            <p>
              Exports as <strong>KML</strong> with all zones dissolved into a single boundary for CodeRED
            </p>
          </div>
        </div>
        
        <!-- Export Button -->
        <div class="card-section">
          <button id="exportBtn" class="export-btn" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            <span id="btnText">Export KML</span>
          </button>
          <div id="statusMsg" class="status-msg"></div>
        </div>
        
      </div>
      
      <!-- Empty State (shown when no incidents available) -->
      <div id="emptyState" class="export-card empty-state" style="display: none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
          <polyline points="14 2 14 8 20 8"/>
          <line x1="9" y1="15" x2="15" y2="15"/>
        </svg>
        <h3>No Incidents Available</h3>
        <p>There are currently no incidents with evacuation zones to export.</p>
      </div>
      
    </main>
    
    <!-- Footer -->
    <footer class="page-footer">
      <a href="staff.html">Staff Guide</a> · La Plata County Office of Emergency Management
    </footer>
    
  </div>

  <!-- ArcGIS API -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
  <script src="https://js.arcgis.com/4.28/"></script>
  
  <script>
    // ========================================
    // Configuration
    // ========================================
    var CONFIG = {
      featureServiceUrl: 'https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0',
      outSR: 4326  // WGS84 for KML
    };
    
    // ========================================
    // DOM References
    // ========================================
    var incidentSelect = document.getElementById('incidentSelect');
    var exportBtn = document.getElementById('exportBtn');
    var btnText = document.getElementById('btnText');
    var statusMsg = document.getElementById('statusMsg');
    var featureCountEl = document.getElementById('featureCount');
    var zoneListEl = document.getElementById('zoneList');
    var zoneListItemsEl = document.getElementById('zoneListItems');
    var exportCard = document.getElementById('exportCard');
    var emptyState = document.getElementById('emptyState');
    
    // Store incident data
    var incidentFeatureCounts = {};
    var incidentZones = {};
    
    // ========================================
    // Utility Functions
    // ========================================
    
    /**
     * Get attribute value with case-insensitive fallback
     */
    function getAttr(attrs) {
      var keys = Array.prototype.slice.call(arguments, 1);
      for (var i = 0; i < keys.length; i++) {
        if (attrs[keys[i]] !== undefined && attrs[keys[i]] !== null) {
          return attrs[keys[i]];
        }
      }
      return null;
    }
    
    /**
     * Show status message
     */
    function showStatus(msg, type) {
      statusMsg.textContent = msg;
      statusMsg.className = 'status-msg show ' + type;
    }
    
    /**
     * Hide status message
     */
    function hideStatus() {
      statusMsg.className = 'status-msg';
    }
    
    /**
     * Set button loading state
     */
    function setButtonLoading(loading) {
      if (loading) {
        btnText.innerHTML = '<span class="spinner"></span>';
        exportBtn.disabled = true;
      } else {
        btnText.textContent = 'Export KML';
        exportBtn.disabled = !incidentSelect.value;
      }
    }
    
    /**
     * Convert ArcGIS feature to GeoJSON
     */
    function arcgisToGeoJSON(feature) {
      if (!feature.geometry || !feature.geometry.rings) return null;
      
      return {
        type: 'Feature',
        properties: feature.attributes || {},
        geometry: {
          type: 'Polygon',
          coordinates: feature.geometry.rings
        }
      };
    }
    
    /**
     * Compute convex hull using Graham scan algorithm
     */
    function convexHull(points) {
      if (points.length < 3) return points;
      
      // Find bottom-most point (or left-most in case of tie)
      var start = points[0];
      for (var i = 1; i < points.length; i++) {
        if (points[i][1] < start[1] || 
            (points[i][1] === start[1] && points[i][0] < start[0])) {
          start = points[i];
        }
      }
      
      // Sort points by polar angle
      var sorted = points.slice().sort(function(a, b) {
        var angleA = Math.atan2(a[1] - start[1], a[0] - start[0]);
        var angleB = Math.atan2(b[1] - start[1], b[0] - start[0]);
        if (angleA !== angleB) return angleA - angleB;
        var distA = Math.pow(a[0] - start[0], 2) + Math.pow(a[1] - start[1], 2);
        var distB = Math.pow(b[0] - start[0], 2) + Math.pow(b[1] - start[1], 2);
        return distA - distB;
      });
      
      // Build hull
      var hull = [];
      for (var i = 0; i < sorted.length; i++) {
        while (hull.length >= 2) {
          var a = hull[hull.length - 2];
          var b = hull[hull.length - 1];
          var c = sorted[i];
          var cross = (b[0] - a[0]) * (c[1] - a[1]) - (b[1] - a[1]) * (c[0] - a[0]);
          if (cross <= 0) {
            hull.pop();
          } else {
            break;
          }
        }
        hull.push(sorted[i]);
      }
      
      // Close the ring
      if (hull.length > 0 && (hull[0][0] !== hull[hull.length-1][0] || hull[0][1] !== hull[hull.length-1][1])) {
        hull.push(hull[0]);
      }
      
      return hull;
    }
    
    /**
     * Generate KML content from GeoJSON
     */
    function generateKML(geojson, incidentName) {
      var kml = '<?xml version="1.0" encoding="UTF-8"?>\n';
      kml += '<kml xmlns="http://www.opengis.net/kml/2.2">\n';
      kml += '  <Document>\n';
      kml += '    <name>' + escapeXml(incidentName) + ' - Evacuation Boundary</name>\n';
      kml += '    <description>Dissolved evacuation zone boundary for CodeRED</description>\n';
      
      // Style for the boundary
      kml += '    <Style id="evacStyle">\n';
      kml += '      <LineStyle>\n';
      kml += '        <color>ff0000ff</color>\n';
      kml += '        <width>3</width>\n';
      kml += '      </LineStyle>\n';
      kml += '      <PolyStyle>\n';
      kml += '        <color>400000ff</color>\n';
      kml += '      </PolyStyle>\n';
      kml += '    </Style>\n';
      
      geojson.features.forEach(function(feature) {
        var props = feature.properties || {};
        var name = props.name || incidentName;
        
        kml += '    <Placemark>\n';
        kml += '      <name>' + escapeXml(name) + '</name>\n';
        if (props.zones) {
          kml += '      <description>Zones: ' + escapeXml(props.zones) + '</description>\n';
        }
        kml += '      <styleUrl>#evacStyle</styleUrl>\n';
        
        if (feature.geometry.type === 'Polygon') {
          kml += '      <Polygon>\n';
          kml += '        <outerBoundaryIs>\n';
          kml += '          <LinearRing>\n';
          kml += '            <coordinates>\n';
          feature.geometry.coordinates[0].forEach(function(coord) {
            kml += '              ' + coord[0] + ',' + coord[1] + ',0\n';
          });
          kml += '            </coordinates>\n';
          kml += '          </LinearRing>\n';
          kml += '        </outerBoundaryIs>\n';
          kml += '      </Polygon>\n';
        }
        
        kml += '    </Placemark>\n';
      });
      
      kml += '  </Document>\n';
      kml += '</kml>';
      
      return kml;
    }
    
    /**
     * Escape XML special characters
     */
    function escapeXml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&apos;');
    }
    
    // ========================================
    // ArcGIS API Integration
    // ========================================
    require([
      'esri/layers/FeatureLayer'
    ], function(FeatureLayer) {
      
      var featureLayer = new FeatureLayer({
        url: CONFIG.featureServiceUrl
      });
      
      // Load available incidents
      loadIncidents();
      
      /**
       * Load all unique incidents from the feature layer
       */
      function loadIncidents() {
        var query = featureLayer.createQuery();
        query.where = '1=1';  // Get all features
        query.outFields = ['*'];
        query.returnGeometry = false;  // Don't need geometry for listing
        
        featureLayer.queryFeatures(query).then(function(result) {
          var incidents = {};
          
          // Group zones by incident
          result.features.forEach(function(f) {
            var incident = getAttr(f.attributes, 'incident', 'Incident', 'INCIDENT');
            if (incident && String(incident).trim()) {
              var incName = String(incident).trim();
              if (!incidents[incName]) {
                incidents[incName] = [];
              }
              
              var zoneName = getAttr(f.attributes, 'zonename', 'Zonename', 'ZONENAME') || 
                             getAttr(f.attributes, 'zone', 'Zone', 'ZONE') || 'Unknown';
              var status = getAttr(f.attributes, 'status', 'Status', 'STATUS') || '';
              
              incidents[incName].push({
                name: String(zoneName),
                status: String(status).toLowerCase()
              });
            }
          });
          
          var incidentList = Object.keys(incidents).sort();
          
          // Show empty state if no incidents
          if (incidentList.length === 0) {
            exportCard.style.display = 'none';
            emptyState.style.display = 'block';
            return;
          }
          
          // Store zone details and counts
          incidentList.forEach(function(inc) {
            incidentZones[inc] = incidents[inc];
            incidentFeatureCounts[inc] = incidents[inc].length;
          });
          
          // Populate dropdown
          incidentSelect.innerHTML = '<option value="">Select an incident...</option>';
          incidentList.forEach(function(inc) {
            var count = incidentFeatureCounts[inc] || 0;
            var opt = document.createElement('option');
            opt.value = inc;
            opt.textContent = inc + ' (' + count + ' zone' + (count !== 1 ? 's' : '') + ')';
            incidentSelect.appendChild(opt);
          });
          
          incidentSelect.disabled = false;
          
        }).catch(function(err) {
          console.error('Error loading incidents:', err);
          incidentSelect.innerHTML = '<option value="">Error loading incidents</option>';
          showStatus('Failed to load incidents: ' + err.message, 'error');
        });
      }
      
      // ========================================
      // Event Handlers
      // ========================================
      
      /**
       * Handle incident selection change
       * Updates the zone list display and enables/disables export button
       */
      incidentSelect.addEventListener('change', function() {
        var selected = this.value;
        hideStatus();
        
        if (selected) {
          exportBtn.disabled = false;
          var count = incidentFeatureCounts[selected] || 0;
          featureCountEl.innerHTML = '<strong>' + count + '</strong> evacuation zone' + (count !== 1 ? 's' : '') + ' will be dissolved into single boundary';
          featureCountEl.classList.add('show');
          
          // Display zone chips
          var zones = incidentZones[selected] || [];
          if (zones.length > 0) {
            zoneListItemsEl.innerHTML = '';
            zones.forEach(function(zone) {
              var chip = document.createElement('span');
              chip.className = 'zone-chip';
              if (zone.status === 'set') {
                chip.className += ' status-set';
              } else if (zone.status === 'go') {
                chip.className += ' status-go';
              }
              chip.textContent = zone.name;
              zoneListItemsEl.appendChild(chip);
            });
            zoneListEl.classList.add('show');
          } else {
            zoneListEl.classList.remove('show');
          }
        } else {
          exportBtn.disabled = true;
          featureCountEl.classList.remove('show');
          zoneListEl.classList.remove('show');
        }
      });
      
      /**
       * Handle export button click
       * Queries features, dissolves into convex hull, and generates KML download
       */
      exportBtn.addEventListener('click', function() {
        var incident = incidentSelect.value;
        if (!incident) return;
        
        setButtonLoading(true);
        hideStatus();
        showStatus('Querying features...', 'loading');
        
        // Build query with escaped incident name to prevent SQL injection
        var query = featureLayer.createQuery();
        query.where = "incident = '" + incident.replace(/'/g, "''") + "'";
        query.outFields = ['*'];
        query.returnGeometry = true;
        query.outSpatialReference = { wkid: CONFIG.outSR };
        
        featureLayer.queryFeatures(query).then(function(result) {
          
          if (!result.features || result.features.length === 0) {
            showStatus('No features found for this incident.', 'error');
            setButtonLoading(false);
            return;
          }
          
          showStatus('Converting ' + result.features.length + ' features...', 'loading');
          
          // Convert to GeoJSON
          var geoJSONFeatures = result.features
            .map(function(f) { return arcgisToGeoJSON(f); })
            .filter(function(f) { return f !== null; });
          
          if (geoJSONFeatures.length === 0) {
            showStatus('Could not convert features.', 'error');
            setButtonLoading(false);
            return;
          }
          
          // Generate filename: first 3 letters of incident + datetime
          var prefix = incident.replace(/[^a-zA-Z]/g, '').substring(0, 3).toUpperCase();
          if (prefix.length < 3) prefix = (prefix + 'XXX').substring(0, 3);
          var now = new Date();
          var datetime = now.getFullYear().toString() +
                        ('0' + (now.getMonth() + 1)).slice(-2) +
                        ('0' + now.getDate()).slice(-2) + '_' +
                        ('0' + now.getHours()).slice(-2) +
                        ('0' + now.getMinutes()).slice(-2);
          var filename = prefix + '_' + datetime;
          
          try {
            showStatus('Dissolving ' + geoJSONFeatures.length + ' zones into single boundary...', 'loading');
            
            // Collect all points from all polygon outer rings
            var allPoints = [];
            var zoneNames = [];
            
            geoJSONFeatures.forEach(function(feature) {
              var props = feature.properties || {};
              var zoneName = props.zonename || props.ZONENAME || props.zone || 'Zone';
              var status = props.STATUS || props.status || '';
              zoneNames.push(zoneName + (status ? ' (' + status + ')' : ''));
              
              if (feature.geometry.type === 'Polygon') {
                // Get outer ring points (first ring)
                feature.geometry.coordinates[0].forEach(function(pt) {
                  allPoints.push(pt);
                });
              }
            });
            
            // Compute convex hull to create single dissolved boundary
            var hull = convexHull(allPoints);
            
            // Create single dissolved feature
            var dissolvedFeature = {
              type: 'Feature',
              properties: {
                name: incident,
                zones: zoneNames.join(', ')
              },
              geometry: {
                type: 'Polygon',
                coordinates: [hull]
              }
            };
            
            var dissolvedGeoJSON = { type: 'FeatureCollection', features: [dissolvedFeature] };
            
            // Generate KML
            var kmlContent = generateKML(dissolvedGeoJSON, incident);
            
            // Create download
            var blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename + '.kml';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('Successfully exported dissolved boundary!', 'success');
            setButtonLoading(false);
            
          } catch (exportErr) {
            console.error('Export generation error:', exportErr);
            showStatus('Export failed: ' + exportErr.message, 'error');
            setButtonLoading(false);
          }
          
        }).catch(function(err) {
          console.error('Export error:', err);
          showStatus('Export failed: ' + (err.message || 'Unknown error'), 'error');
          setButtonLoading(false);
        });
      });
      
    });
  </script>
  
</body>
</html>
