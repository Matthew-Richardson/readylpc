<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReadyLaPlata — La Plata County Evacuation Viewer</title>
  
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta name="description" content="Official evacuation information and interactive maps for La Plata County, Colorado. View active incidents, evacuation zones, and sign up for emergency alerts.">
  <meta name="theme-color" content="#0b4da2">
  
  <meta property="og:title" content="ReadyLaPlata — La Plata County Evacuation Viewer">
  <meta property="og:description" content="Official evacuation information and interactive maps for La Plata County, Colorado. View active incidents and evacuation zones.">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="en_US">
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ReadyLaPlata — La Plata County Evacuation Viewer">
  <meta name="twitter:description" content="Official evacuation information for La Plata County, Colorado.">

  <link rel="dns-prefetch" href="//js.arcgis.com">
  <link rel="dns-prefetch" href="//services2.arcgis.com">
  <link rel="preconnect" href="https://js.arcgis.com" crossorigin>
  <link rel="preconnect" href="https://services2.arcgis.com" crossorigin>

  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;font-family:Arial,sans-serif;background:#f5f5f7;font-size:18px;overflow-x:hidden;color:#000}
    .page-shell{min-height:100vh;display:flex;flex-direction:column}
    .map-wrapper{max-width:900px;width:100%;margin:16px auto 0;padding:12px}
    .map-card{width:100%;border-radius:14px;border:1px solid rgba(0,0,0,0.15);box-shadow:0 4px 20px rgba(0,0,0,0.12);overflow:hidden;background:#fff;display:flex;flex-direction:column}
    #viewDiv{width:100%;height:clamp(400px, 55vh, 550px);background:#e5e5e5}
  </style>

  <link rel="stylesheet" href="shared-styles.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="shared-styles.css"></noscript>

  <link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="https://js.arcgis.com/4.31/esri/themes/light/main.css"></noscript>
</head>

<body>
  <div class="page-shell">
    <div class="map-wrapper">
      <div class="map-card">

        <button id="announcementAlertBtn" class="announcement-alert-btn" type="button" aria-label="View announcement">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
        </button>

        <div id="siteBanner" class="site-banner"></div>

        <div class="brand-banner">
          <div class="brand-center">
            <img src="https://cms9files.revize.com/laplata/_assets_/images/logo.png" alt="La Plata County Logo" class="header-logo" width="180" height="auto" loading="eager" fetchpriority="high" decoding="async">
            <div class="brand-text">
              <div class="site-name">ReadyLaPlata</div>
              <div class="site-subtitle">La Plata County Evacuation Viewer</div>
            </div>
            <div class="official-badge">Official Emergency Information</div>
          </div>
          <div class="banner-nav">
            <button id="infoButton" class="nav-btn" type="button">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
              <span>Home</span>
            </button>
            <button id="coderedButton" class="nav-btn" type="button">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
              <span>CodeRED Alerts</span>
            </button>
            <div class="nav-divider"></div>
            <div class="call-center-inline">
              <span class="call-label">Call Center:</span>
              <svg class="phone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
              <a href="tel:9703858700">970-385-8700</a>
            </div>
          </div>
        </div>

        <div class="content-overlap">
          <div class="incident-strip">
            <div class="incident-strip-top">
              <div class="incident-bar-left">
                <span class="incident-label">Active incidents <span id="incidentCountBadge" class="incident-count-badge">0</span></span>
              </div>
            </div>
            <div class="incident-tip">Click a pin on the map or tap an incident below to view details.</div>
            <div id="incidentChips" class="incident-chips"></div>
            <div id="noIncidentsMsg" class="incident-none">
              <div class="incident-none-content">
                <div class="incident-none-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <div class="incident-none-text">
                  <div class="incident-none-title">No Active Incidents</div>
                  <p class="incident-none-body">No active evacuations in La Plata County.</p>
                </div>
              </div>
              <a href="#" id="noIncidentCodered" class="incident-none-cta-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                Sign up for CodeRED Alerts
              </a>
            </div>
          </div>

          <div class="card-divider"></div>
          <div id="viewDiv"></div>

          <div class="map-key-merged">
            <div class="legend-title">Map Key</div>
            <div class="legend-items">
              <div class="legend-item">
                <span style="display:inline-block;width:22px;height:22px;position:relative;">
                  <span style="position:absolute;top:6px;left:50%;transform:translateX(-50%) rotate(45deg);width:12px;height:12px;background:#0b4da2;border:2px solid #fff;"></span>
                </span>
                <span>Incident Location</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="incident-panel">
      <div class="past-incidents-card">
        <div class="past-incidents-header">
          <div class="past-incidents-icon-wrap">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
            </svg>
          </div>
          <div class="past-incidents-title-wrap">
            <h2 class="past-incidents-title">Past Incidents</h2>
            <div class="past-incidents-subtitle">Historical evacuation records</div>
          </div>
        </div>
        <div id="pastIncidentsTable" class="past-incidents-body">
          <div class="past-incidents-loading">Loading past incidents...</div>
        </div>
        <div class="past-incidents-disclaimer">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
          </svg>
          <span>Even after evacuations are lifted, emergency personnel may still be active in the area. Please follow all posted signs and instructions.</span>
        </div>
      </div>

      <div class="status-timestamp">
        <span id="lastLoaded">Last loaded: --</span>
        &nbsp;•&nbsp;
        <span class="source-label">Source: La Plata County Office of Emergency Management</span>
      </div>
    </div>
  </div>

  <!-- CodeRED Overlay -->
  <div id="coderedOverlay" class="codered-overlay" aria-hidden="true">
    <div class="codered-dialog" role="dialog" aria-labelledby="codered-title">
      <button id="coderedClose" class="codered-close" aria-label="Close">&times;</button>
      <h2 id="codered-title" class="codered-title">CodeRED Emergency Alerts</h2>
      <div class="codered-subtitle">Get notified about emergencies in La Plata County</div>
      <div class="codered-body">
        <p><strong>CodeRED</strong> is an emergency notification system that allows La Plata County to send critical information during emergencies.</p>
        <p>Sign up to receive alerts via phone, text, and email.</p>
      </div>
      <div class="codered-actions">
        <a href="https://public.coderedweb.com/CNE/en-US/" class="primary-pill" target="_blank" rel="noopener noreferrer">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Sign up on CodeRED
        </a>
      </div>
    </div>
  </div>

  <!-- Announcement Overlay (content loaded from announcement.json) -->
  <div id="announcementOverlay" class="announcement-overlay" aria-hidden="true">
    <div class="announcement-dialog" role="dialog" aria-modal="true" aria-labelledby="announcementTitle">
      <button id="announcementClose" class="announcement-close" type="button" aria-label="Close">×</button>
      <!-- Content injected by initAnnouncement() -->
    </div>
  </div>

  <script src="https://js.arcgis.com/4.31/" defer></script>
  <script src="shared.js"></script>
  <script>
  (function() {
    'use strict';

    const { $, escHTML, createChip, formatTimestamp, updateTimestamp, initCoderedOverlay, initAnnouncement, BRAND } = ReadyLaPlata;

    const CONFIG = {
      incidentLayerUrl: 'https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0',
      pastIncidentsJsonUrl: 'pastincident.json',
      incidentField: 'incident',
      mapCenter: [-107.8801, 37.2753],
      mapScale: 800000
    };

    const DOM = {
      countBadge: $('incidentCountBadge'),
      chipsEl: $('incidentChips'),
      infoButton: $('infoButton'),
      coderedButton: $('coderedButton'),
      coderedOverlay: $('coderedOverlay'),
      coderedClose: $('coderedClose'),
      lastLoaded: $('lastLoaded'),
      noIncidentsMsg: $('noIncidentsMsg'),
      noIncidentCodered: $('noIncidentCodered'),
      pastIncidentsTable: $('pastIncidentsTable'),
      announcementOverlay: $('announcementOverlay'),
      announcementClose: $('announcementClose'),
      announcementDismiss: $('announcementDismiss'),
      announcementAlertBtn: $('announcementAlertBtn')
    };

    function initMap() {
      if (typeof require === 'undefined') {
        setTimeout(initMap, 100);
        return;
      }

      require([
        'esri/Map', 'esri/views/MapView', 'esri/layers/FeatureLayer', 'esri/layers/GraphicsLayer',
        'esri/Graphic', 'esri/widgets/Search', 'esri/widgets/Fullscreen', 'esri/geometry/Point'
      ], (Map, MapView, FeatureLayer, GraphicsLayer, Graphic, Search, Fullscreen, Point) => {

        const map = new Map({ basemap: 'topo-vector' });
        const pinsLayer = new GraphicsLayer({ title: 'Incident Locations' });
        map.add(pinsLayer);

        const view = new MapView({
          container: 'viewDiv',
          map,
          center: CONFIG.mapCenter,
          scale: CONFIG.mapScale,
          popup: { dockEnabled: true, dockOptions: { buttonEnabled: false, breakpoint: false } }
        });

        if (window.innerWidth < 700 && view.navigation) {
          view.navigation.mouseWheelZoomEnabled = false;
          view.navigation.browserTouchPanEnabled = false;
        }

        view.when(() => {
          view.on('pointer-move', e => {
            view.hitTest(e).then(res => {
              const hasPin = res.results.some(r => r.graphic?.layer === pinsLayer && r.graphic?.attributes?.type === 'marker');
              view.container.style.cursor = hasPin ? 'pointer' : 'default';
            });
          });
        });

        const incidentLayer = new FeatureLayer({
          url: CONFIG.incidentLayerUrl,
          outFields: ['*'],
          visible: false,
          listMode: 'hide'
        });
        map.add(incidentLayer);

        view.when()
          .then(() => {
            view.ui.add(new Search({ view, includeDefaultSources: true }), 'top-right');
            view.ui.add(new Fullscreen({ view }), 'top-right');
            return incidentLayer.when();
          })
          .then(() => incidentLayer.queryFeatures({
            where: '1=1',
            outFields: [CONFIG.incidentField],
            returnDistinctValues: true,
            orderByFields: [CONFIG.incidentField]
          }))
          .then(fs => {
            const names = (fs.features || []).map(f => f.attributes[CONFIG.incidentField]).filter(Boolean);

            DOM.countBadge.textContent = names.length;
            if (names.length) DOM.countBadge.classList.add('has-incidents');
            else DOM.noIncidentsMsg.classList.add('is-visible');
            updateTimestamp(DOM.lastLoaded);

            if (!names.length) return;

            const frag = document.createDocumentFragment();
            for (const name of names) {
              frag.appendChild(createChip(name, () => location.href = `evac.html?incident=${encodeURIComponent(name)}`));
            }
            DOM.chipsEl?.appendChild(frag);

            const pinPromises = names.map(incidentName => 
              incidentLayer.queryExtent({ where: `${CONFIG.incidentField}='${incidentName.replace(/'/g, "''")}'` })
                .then(result => {
                  if (!result.extent) return;
                  const { center } = result.extent;
                  const point = new Point({ longitude: center.longitude, latitude: center.latitude, spatialReference: center.spatialReference });

                  pinsLayer.addMany([
                    new Graphic({
                      geometry: point,
                      symbol: { type: 'simple-marker', style: 'diamond', color: [11, 77, 162], size: 28, outline: { color: [255, 255, 255], width: 4 }, yoffset: 14 },
                      attributes: { incident: incidentName, type: 'marker' },
                      popupTemplate: {
                        title: incidentName,
                        content: `<div style="padding:8px;"><a href="evac.html?incident=${encodeURIComponent(incidentName)}" style="color:#0b4da2;font-weight:700;text-decoration:underline;">View Evacuation Details →</a></div>`
                      }
                    }),
                    new Graphic({
                      geometry: point,
                      symbol: { type: 'text', color: [0, 0, 0], text: incidentName, font: { size: 14, weight: 'bold', family: 'Arial, sans-serif' }, haloColor: [255, 255, 255], haloSize: 2.5, yoffset: -26 },
                      attributes: { incident: incidentName, type: 'label' }
                    })
                  ]);
                }).catch(console.error)
            );

            return Promise.all(pinPromises);
          })
          .catch(err => {
            console.error('Error loading incidents:', err);
            DOM.countBadge.textContent = '0';
          });

        view.on('click', e => {
          view.hitTest(e).then(res => {
            const result = res.results.find(r => r.graphic?.layer === pinsLayer && r.graphic?.attributes?.incident);
            if (result) location.href = `evac.html?incident=${encodeURIComponent(result.graphic.attributes.incident)}`;
          });
        });
      });
    }

    async function loadPastIncidents() {
      if (!DOM.pastIncidentsTable) return;

      try {
        const res = await fetch(CONFIG.pastIncidentsJsonUrl);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const incidents = await res.json();

        if (!incidents.length) {
          DOM.pastIncidentsTable.innerHTML = '<div class="past-incidents-loading">No past incidents recorded.</div>';
          return;
        }

        incidents.sort((a, b) => new Date(b.liftedDate || b.startDate || 0) - new Date(a.liftedDate || a.startDate || 0));

        const formatDate = val => {
          if (!val) return '—';
          const d = new Date(val);
          return isNaN(d.getTime()) ? val : d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        };

        const rows = incidents.map(inc => `
          <tr>
            <td style="padding:10px 12px;border-bottom:1px solid ${BRAND.borderLight};font-weight:600;color:${BRAND.textHeading};">${escHTML(inc.name || '—')}</td>
            <td style="padding:10px 12px;border-bottom:1px solid ${BRAND.borderLight};color:${BRAND.gray};text-align:center;">${escHTML(formatDate(inc.startDate))}</td>
            <td style="padding:10px 12px;border-bottom:1px solid ${BRAND.borderLight};color:${BRAND.gray};text-align:center;">${escHTML(formatDate(inc.liftedDate))}</td>
          </tr>`).join('');

        DOM.pastIncidentsTable.innerHTML = `
          <table style="width:100%;border-collapse:collapse;font-size:14px;">
            <thead>
              <tr style="background:${BRAND.grayLight};">
                <th style="padding:10px 12px;text-align:left;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:${BRAND.textMuted};border-bottom:2px solid ${BRAND.border};">Incident Name</th>
                <th style="padding:10px 12px;text-align:center;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:${BRAND.textMuted};border-bottom:2px solid ${BRAND.border};">Start Date</th>
                <th style="padding:10px 12px;text-align:center;font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:${BRAND.textMuted};border-bottom:2px solid ${BRAND.border};">Evacuations Lifted</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>`;
      } catch (err) {
        console.error('Error loading past incidents:', err);
        DOM.pastIncidentsTable.innerHTML = '<div class="past-incidents-error">Unable to load past incidents.</div>';
      }
    }

    DOM.infoButton?.addEventListener('click', () => location.href = 'index.html');
    initCoderedOverlay(DOM);
    initAnnouncement(DOM);
    initMap();
    loadPastIncidents();
  })();
  </script>
</body>
</html>
