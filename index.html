<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReadyLaPlata — La Plata County Evacuation Viewer</title>
  
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta name="description" content="Official evacuation information and interactive maps for La Plata County, Colorado. View active incidents, evacuation zones, and sign up for emergency alerts.">
  <meta name="theme-color" content="#0b4da2">
  
  <meta property="og:title" content="ReadyLaPlata — La Plata County Evacuation Viewer">
  <meta property="og:description" content="Official evacuation information and interactive maps for La Plata County, Colorado. View active incidents and evacuation zones.">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="en_US">
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ReadyLaPlata — La Plata County Evacuation Viewer">
  <meta name="twitter:description" content="Official evacuation information for La Plata County, Colorado.">

  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%;font-family:Arial,sans-serif;background:#f5f5f7;font-size:18px;overflow-x:hidden;color:#000}
    .page-shell{min-height:100vh;display:flex;flex-direction:column}
    .map-wrapper{max-width:900px;width:100%;margin:16px auto 0;padding:12px}
    .map-card{width:100%;border-radius:14px;border:1px solid rgba(0,0,0,0.15);box-shadow:0 4px 20px rgba(0,0,0,0.12);overflow:hidden;background:#fff;display:flex;flex-direction:column}
  </style>

  <link rel="stylesheet" href="shared-styles.css">
</head>

<body>
  <div class="page-shell">
    <div class="map-wrapper">
      <div class="map-card">

        <!-- Announcement Alert Button - appears in upper right when active -->
        <button id="announcementAlertBtn" class="announcement-alert-btn" type="button" aria-label="View announcement">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
        </button>

        <!-- Site Banner: Leave empty to hide, add text to display -->
        <div id="siteBanner" class="site-banner"></div>

        <div class="brand-banner">
          <div class="brand-center">
            <img src="https://cms9files.revize.com/laplata/_assets_/images/logo.png" alt="La Plata County Logo" class="header-logo" width="180">
            <div class="brand-text">
              <div class="site-name">ReadyLaPlata</div>
              <div class="site-subtitle">La Plata County Evacuation Viewer</div>
            </div>
            <div class="official-badge">Official Emergency Information</div>
          </div>
          <div class="banner-nav">
            <button id="overviewButton" class="nav-btn" type="button" aria-label="Overview Map">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
              <span>Overview Map</span>
            </button>
            <button id="coderedButton" class="nav-btn" type="button" aria-label="CodeRED Alerts">
              <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
              <span>CodeRED Alerts</span>
            </button>
            <div class="nav-divider"></div>
            <div class="call-center-inline">
              <span class="call-label">Call Center:</span>
              <svg class="phone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
              <a href="tel:9703858700">970-385-8700</a>
            </div>
          </div>
        </div>

        <div class="content-overlap"><div class="incident-strip">
          <div class="incident-strip-top">
            <div class="incident-bar-left">
              <span class="incident-label">
                Active incidents
                <span id="incidentCountBadge" class="incident-count-badge">0</span>
              </span>
            </div>
          </div>
          <div class="incident-tip">Tap an incident below to view the evacuation map.</div>
          <div id="incidentChips" class="incident-chips"></div>
          <div id="noIncidentsMsg" class="incident-none">
            <div class="incident-none-content">
              <div class="incident-none-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
              </div>
              <div class="incident-none-text">
                <div class="incident-none-title">No Active Incidents</div>
                <p class="incident-none-body">No active evacuations in La Plata County.</p>
              </div>
            </div>
            <a href="#" id="noIncidentCodered" class="incident-none-cta-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
              Sign up for CodeRED Alerts
            </a>
          </div>
        </div>

        <div class="card-divider"></div>
        </div><!-- end content-overlap -->
      </div>
    </div>

    <main>
      <div class="incident-panel">
        <div class="home-wrapper">
          <div class="preview-container">
            <div class="preview-frame">
              <div class="evac-stages">
                <div class="stage-header-main">
                  <div class="stage-tagline">La Plata County</div>
                  <div class="stage-headline">Stay Ready, Year-Round</div>
                  <div class="stage-body" style="margin-top:8px;max-width:780px;margin-left:auto;margin-right:auto;font-size:15px;line-height:1.5;">
                    <p>La Plata County Office of Emergency Management (<strong>LPCOEM</strong>) — uses the Ready, Set, Go! system to establish evacuation zones. Click the incident map above to confirm your zone. During an incident your zone name and area is subject to change.</p>
                  </div>
                </div>

                <div class="stage-subhead">Ready, Set, Go! System</div>

                <div id="stageTimeline" class="stage-timeline">
                  <svg id="triangleLines" class="triangle-lines" aria-hidden="true">
                    <defs>
                      <linearGradient id="grad-ready-set" gradientUnits="userSpaceOnUse">
                        <stop offset="0%" stop-color="#b33a3a"/><stop offset="100%" stop-color="#a68f00"/>
                      </linearGradient>
                      <linearGradient id="grad-ready-go" gradientUnits="userSpaceOnUse">
                        <stop offset="0%" stop-color="#b33a3a"/><stop offset="100%" stop-color="#0a7c25"/>
                      </linearGradient>
                      <linearGradient id="grad-set-go" gradientUnits="userSpaceOnUse">
                        <stop offset="0%" stop-color="#a68f00"/><stop offset="100%" stop-color="#0a7c25"/>
                      </linearGradient>
                    </defs>
                    <line id="line-ready-set" stroke="url(#grad-ready-set)" stroke-width="4" stroke-linecap="round"/>
                    <line id="line-ready-go" stroke="url(#grad-ready-go)" stroke-width="4" stroke-linecap="round"/>
                    <line id="line-set-go" stroke="url(#grad-set-go)" stroke-width="4" stroke-linecap="round"/>
                  </svg>

                  <div class="stage-item stage-item-ready">
                    <div id="pinReady" class="stage-pin stage-pin-ready"></div>
                    <div class="stage-card stage-card-ready">
                      <h2 class="stage-title">READY</h2>
                      <div class="stage-subtitle">Be READY, Stay SAFE</div>
                      <div class="stage-body">
                        <p><strong>Stay Informed:</strong> Sign-up for CodeRED, ensure Gov't Alerts are enabled on your cell phone, and use apps like Watch Duty.</p>
                        <p><strong>Arrangements:</strong> Make a plan and practice your evacuation; People, Pets, Photos, Papers and Pills.</p>
                        <p><strong>Fire Ready:</strong> Fire Mitigation and last minute safety measures, "Go Kit" with Protective Clothing and masks.</p>
                        <p><strong>Evacuate:</strong> Don't hesitate or ignore evacuation orders. Know multiple ways out.</p>
                      </div>
                    </div>
                  </div>

                  <div class="stage-bottom-row">
                    <div class="stage-item stage-item-set">
                      <div id="pinSet" class="stage-pin stage-pin-set"></div>
                      <div class="stage-card stage-card-set">
                        <h2 class="stage-title">SET</h2>
                        <div class="stage-subtitle">Pre-Evacuation</div>
                        <div class="stage-body stage-body-center">
                          <p><strong>SET - Pre-Evacuation</strong></p>
                          <p>Voluntary Evacuation; Evacuation orders are likely.</p>
                        </div>
                      </div>
                    </div>

                    <div class="stage-item stage-item-go">
                      <div id="pinGo" class="stage-pin stage-pin-go"></div>
                      <div class="stage-card stage-card-go">
                        <h2 class="stage-title">GO</h2>
                        <div class="stage-subtitle">Evacuate Now</div>
                        <div class="stage-body stage-body-center">
                          <p><strong>GO - Evacuate Now</strong></p>
                          <p>LEAVE NOW. Immediate threat to life.</p>
                          <p>This area is closed to public access.</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="status-timestamp">
            <span id="lastLoaded">Last loaded: --</span>
            &nbsp;•&nbsp;
            <span class="source-label">Source: La Plata County Office of Emergency Management</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div id="coderedOverlay" class="codered-overlay" aria-hidden="true">
    <div class="codered-dialog" role="dialog" aria-modal="true" aria-labelledby="coderedTitle">
      <button id="coderedClose" class="codered-close" type="button" aria-label="Close CodeRED info">×</button>
      <h2 id="coderedTitle" class="codered-title">CodeRED Emergency Alerts</h2>
      <p class="codered-subtitle">Stay informed about wildfires, floods, and other emergencies in La Plata County.</p>
      <div class="codered-body">
        <p><strong>CodeRED</strong> is the official emergency alerting system used by La Plata County Office of Emergency Management (LPCOEM).</p>
        <p>You can receive notifications by text, phone call, and email about evacuation notices, road closures, and other time-sensitive information.</p>
      </div>
      <div class="codered-actions">
        <a href="https://public.coderedweb.com/CNE/en-US/" class="primary-pill" target="_blank" rel="noopener noreferrer">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Sign up on CodeRED
        </a>
      </div>
    </div>
  </div>

  <!-- ========== ANNOUNCEMENT OVERLAY ========== -->
  <div id="announcementOverlay" class="announcement-overlay" aria-hidden="true">
    <div class="announcement-dialog" role="dialog" aria-modal="true" aria-labelledby="announcementTitle">
      <button id="announcementClose" class="announcement-close" type="button" aria-label="Close">×</button>
      
      <div class="announcement-header">
        <img src="https://cms9files.revize.com/laplata/_assets_/images/logo.png" alt="La Plata County Logo" class="announcement-logo">
        <div class="announcement-header-text">
          <h2 id="announcementTitle" class="announcement-title">CodeRED Security Update</h2>
          <p class="announcement-subtitle">Important information about your alert account</p>
        </div>
        <div class="announcement-badge">Official Notice</div>
      </div>
      
      <div class="announcement-body">
        <div class="announcement-content">
          <p>We are reaching out to share an important update regarding the security of our alert system <strong>CodeRED</strong>.</p>
          
          <p>Out of an abundance of caution, <strong>we recommend that all users who currently have an account change their password</strong>. Updating your password helps ensure your information remains secure and protected.</p>
          
          <p>Some individuals receive alerts through CodeRED without having an online account. If you are one of these legacy users, no immediate action is required. However, if you would like to view, update, or manage your information, you can do so by creating an account at any time.</p>
          
          <p>Creating an account allows you to:</p>
          <ul class="announcement-list">
            <li>Review and update your contact information</li>
            <li>Manage alert preferences</li>
            <li>Ensure your information stays current</li>
          </ul>
          
          <div class="announcement-contact">
            <div class="announcement-contact-title">Questions or Need Assistance?</div>
            <div class="announcement-contact-row">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
              <a href="mailto:OEMECC@lpcgov.org">OEMECC@lpcgov.org</a>
            </div>
            <div class="announcement-contact-row">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
              <a href="tel:9703826275">970-382-6275</a>
            </div>
          </div>
        </div>
      </div>
      
      <div class="announcement-footer">
        <a href="https://public.coderedweb.com/CNE/en-US/" class="primary-pill" target="_blank" rel="noopener noreferrer">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Manage My CodeRED Account
        </a>
        <button id="announcementDismiss" class="secondary-pill" type="button">
          I'll do this later
        </button>
      </div>
    </div>
  </div>

  <script>
  (function() {
    'use strict';

    // ========== CONFIGURATION ==========
    const CONFIG = {
      mapUrl: 'evac.html',
      incidentLayerUrl: 'https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0/query',
      incidentField: 'incident'
    };

    // ========== ANNOUNCEMENT TOGGLE ==========
    // SHOW_ANNOUNCEMENT: shows the bell icon on all pages when true
    // AUTO_OPEN_ANNOUNCEMENT: auto-opens the popup on HOME PAGE ONLY (this page) when true
    const SHOW_ANNOUNCEMENT = true;
    const AUTO_OPEN_ANNOUNCEMENT = true;

    // ========== DOM CACHE ==========
    const $ = id => document.getElementById(id);
    const DOM = {};

    // ========== URL PARAMETER (computed once) ==========
    const INCIDENT = (() => {
      const params = new URLSearchParams(location.search);
      return (params.get('incident') || params.get('Incident') || '').trim() || null;
    })();

    // ========== UTILITIES ==========
    // Format timestamp with timezone
    const formatTimestamp = () => {
      const now = new Date();
      const options = { 
        year: 'numeric', month: 'numeric', day: 'numeric',
        hour: 'numeric', minute: '2-digit', second: '2-digit',
        timeZoneName: 'short'
      };
      return now.toLocaleString('en-US', options);
    };

    const updateTimestamp = () => {
      if (DOM.lastLoaded) DOM.lastLoaded.textContent = 'Last loaded: ' + formatTimestamp();
    };

    const createChip = (name, onClick) => {
      const chip = document.createElement('button');
      chip.className = 'incident-chip';
      chip.innerHTML = '<span class="incident-chip-icon">!</span><span>' + name + '</span>';
      chip.addEventListener('click', onClick);
      return chip;
    };

    const sortIncidents = (names, target) => {
      const targetLower = target?.toLowerCase();
      return names.sort((a, b) => {
        const al = a.toLowerCase(), bl = b.toLowerCase();
        if (targetLower) {
          if (al === targetLower) return -1;
          if (bl === targetLower) return 1;
        }
        return al.localeCompare(bl);
      });
    };

    // ========== DATA FETCHING ==========
    async function loadIncidents() {
      const params = new URLSearchParams({
        where: '1=1',
        outFields: CONFIG.incidentField,
        returnDistinctValues: 'true',
        f: 'json'
      });

      try {
        const res = await fetch(CONFIG.incidentLayerUrl + '?' + params);
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const data = await res.json();
        const seen = new Set();

        const names = (data.features || [])
          .map(f => f.attributes?.[CONFIG.incidentField]?.trim())
          .filter(n => {
            if (!n) return false;
            const key = n.toLowerCase();
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
          });

        sortIncidents(names, INCIDENT);

        DOM.countBadge.textContent = names.length;
        if (names.length) DOM.countBadge.classList.add('has-incidents');
        updateTimestamp();

        if (!names.length) {
          DOM.noIncidentsMsg.classList.add('is-visible');
          return;
        }

        const frag = document.createDocumentFragment();
        for (const name of names) {
          frag.appendChild(createChip(name, () => {
            const url = new URL(CONFIG.mapUrl, location.href);
            url.searchParams.set('incident', name);
            location.href = url;
          }));
        }
        DOM.chipsEl.appendChild(frag);
      } catch (err) {
        console.error('Error loading incidents:', err);
        DOM.countBadge.textContent = '0';
        DOM.noIncidentsMsg.classList.add('is-visible');
      }
    }

    // ========== CODERED OVERLAY ==========
    function initCoderedOverlay() {
      const overlay = DOM.coderedOverlay;
      if (!DOM.coderedButton || !overlay) return;

      const toggle = open => {
        overlay.classList.toggle('is-open', open);
        overlay.setAttribute('aria-hidden', String(!open));
      };

      DOM.coderedButton.addEventListener('click', () => toggle(true));
      DOM.coderedClose?.addEventListener('click', () => toggle(false));
      DOM.noIncidentCodered?.addEventListener('click', e => { e.preventDefault(); toggle(true); });
      overlay.addEventListener('click', e => { if (e.target === overlay) toggle(false); });
      document.addEventListener('keydown', e => { if (e.key === 'Escape' && overlay.classList.contains('is-open')) toggle(false); });
    }

    // ========== ANNOUNCEMENT OVERLAY ==========
    function initAnnouncement() {
      const overlay = DOM.announcementOverlay;
      const alertBtn = DOM.announcementAlertBtn;
      
      if (!SHOW_ANNOUNCEMENT || !overlay) return;
      
      // Show the alert button when announcement is active
      if (alertBtn) alertBtn.classList.add('is-active');

      const toggle = open => {
        overlay.classList.toggle('is-open', open);
        overlay.setAttribute('aria-hidden', String(!open));
        
        // Mark as viewed when closed
        if (!open && alertBtn) {
          alertBtn.classList.add('is-viewed');
        }
      };

      // Auto-open on page load only if enabled (HOME PAGE ONLY)
      if (AUTO_OPEN_ANNOUNCEMENT) {
        toggle(true);
      }

      // Close handlers
      DOM.announcementClose?.addEventListener('click', () => toggle(false));
      DOM.announcementDismiss?.addEventListener('click', () => toggle(false));
      overlay.addEventListener('click', e => { if (e.target === overlay) toggle(false); });
      document.addEventListener('keydown', e => { if (e.key === 'Escape' && overlay.classList.contains('is-open')) toggle(false); });
      
      // Alert button opens the announcement
      alertBtn?.addEventListener('click', () => toggle(true));
    }

    // ========== TRIANGLE LINES ==========
    function initTriangleLines() {
      const container = $('stageTimeline');
      const svg = $('triangleLines');
      const pins = { ready: $('pinReady'), set: $('pinSet'), go: $('pinGo') };
      
      if (!container || !svg || !pins.ready || !pins.set || !pins.go) return;

      const lines = {
        readySet: $('line-ready-set'),
        readyGo: $('line-ready-go'),
        setGo: $('line-set-go')
      };

      const grads = {
        readySet: $('grad-ready-set'),
        readyGo: $('grad-ready-go'),
        setGo: $('grad-set-go')
      };

      const updateLines = () => {
        const containerRect = container.getBoundingClientRect();
        
        const getCenter = el => {
          const rect = el.getBoundingClientRect();
          return {
            x: rect.left + rect.width / 2 - containerRect.left,
            y: rect.top + rect.height / 2 - containerRect.top
          };
        };

        const ready = getCenter(pins.ready);
        const set = getCenter(pins.set);
        const go = getCenter(pins.go);

        const setLine = (line, p1, p2) => {
          line.setAttribute('x1', p1.x);
          line.setAttribute('y1', p1.y);
          line.setAttribute('x2', p2.x);
          line.setAttribute('y2', p2.y);
        };

        const setGrad = (grad, p1, p2) => {
          grad.setAttribute('x1', p1.x);
          grad.setAttribute('y1', p1.y);
          grad.setAttribute('x2', p2.x);
          grad.setAttribute('y2', p2.y);
        };

        setLine(lines.readySet, ready, set);
        setLine(lines.readyGo, ready, go);
        setLine(lines.setGo, set, go);

        setGrad(grads.readySet, ready, set);
        setGrad(grads.readyGo, ready, go);
        setGrad(grads.setGo, set, go);
      };

      // Initial draw and delayed redraw after layout
      updateLines();
      setTimeout(updateLines, 100);
      
      // Debounced resize handler
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(updateLines, 50);
      });
    }

    // ========== INIT ==========
    function init() {
      DOM.chipsEl = $('incidentChips');
      DOM.countBadge = $('incidentCountBadge');
      DOM.noIncidentsMsg = $('noIncidentsMsg');
      DOM.noIncidentCodered = $('noIncidentCodered');
      DOM.overviewButton = $('overviewButton');
      DOM.coderedButton = $('coderedButton');
      DOM.coderedOverlay = $('coderedOverlay');
      DOM.coderedClose = $('coderedClose');
      DOM.lastLoaded = $('lastLoaded');
      
      // Announcement elements
      DOM.announcementOverlay = $('announcementOverlay');
      DOM.announcementClose = $('announcementClose');
      DOM.announcementDismiss = $('announcementDismiss');
      DOM.announcementAlertBtn = $('announcementAlertBtn');

      DOM.overviewButton?.addEventListener('click', () => location.href = 'overview.html');
      
      loadIncidents();
      initCoderedOverlay();
      initAnnouncement();
      initTriangleLines();
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
  </script>
</body>
</html>
