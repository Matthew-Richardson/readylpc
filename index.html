<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReadyLaPlata — La Plata County Evacuation Viewer</title>

  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <meta name="description" content="Official evacuation information and interactive maps for La Plata County, Colorado. View active incidents, evacuation zones, and sign up for emergency alerts.">
  <meta name="theme-color" content="#0b4da2">

  <meta property="og:title" content="ReadyLaPlata — La Plata County Evacuation Viewer">
  <meta property="og:description" content="Official evacuation information and interactive maps for La Plata County, Colorado. View active incidents and evacuation zones.">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="en_US">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ReadyLaPlata — La Plata County Evacuation Viewer">
  <meta name="twitter:description" content="Official evacuation information for La Plata County, Colorado.">

  <!-- Preconnect to external resources -->
  <link rel="preconnect" href="https://services2.arcgis.com" crossorigin>
  <link rel="preconnect" href="https://cms9files.revize.com">
  <link rel="dns-prefetch" href="//services2.arcgis.com">

  <!-- Critical CSS for above-the-fold content -->
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:Arial,sans-serif;background:#f5f5f7;font-size:18px;overflow-x:hidden;color:#000}
    .page-shell{min-height:100vh;display:flex;flex-direction:column}
    .map-wrapper{max-width:900px;width:100%;margin:16px auto 0;padding:12px}
    .map-card{width:100%;border-radius:14px;border:1px solid rgba(0,0,0,0.15);box-shadow:0 4px 20px rgba(0,0,0,0.12);overflow:hidden;background:#fff;display:flex;flex-direction:column}
  </style>

  <link rel="stylesheet" href="shared-styles.css">
</head>

<body>
  <div class="page-shell">
    <div class="map-wrapper">
      <div class="map-card">

        <button id="announcementAlertBtn" class="announcement-alert-btn" type="button" aria-label="View announcement">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
        </button>

        <div id="siteBanner" class="site-banner"></div>

        <div class="brand-banner">
          <div class="brand-row">
            <div class="brand-group">
              <img src="https://cms9files.revize.com/laplata/_assets_/images/logo.png" alt="La Plata County Logo" class="header-logo" width="160" height="auto" loading="eager" fetchpriority="high" decoding="async">
              <div class="brand-text">
                <div class="site-name">ReadyLaPlata</div>
                <div class="site-subtitle">La Plata County Evacuation Viewer</div>
              </div>
            </div>
            <div class="banner-nav">
              <button id="overviewButton" class="nav-btn" type="button">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
                <span>Overview Map</span>
              </button>
              <button id="coderedButton" class="nav-btn" type="button">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                <span>CodeRED Alerts</span>
              </button>
            </div>
          </div>
        </div>

        <div class="content-overlap">
          <div class="incident-strip">
            <!-- Active incidents state -->
            <div id="incidentsActive" class="incident-box incident-box--alert">
              <div class="incident-box-header incident-box-header--alert">
                <svg class="incident-box-header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <span class="incident-box-header-text"><span id="incidentCountBadge">0</span> Active Incident<span id="incidentPlural">s</span></span>
              </div>
              <div class="incident-box-body">
                <p class="incident-tip">Tap an incident to view the evacuation map.</p>
                <div id="incidentChips" class="incident-chips"></div>
              </div>
            </div>
            <!-- No incidents state -->
            <div id="noIncidentsMsg" class="incident-box incident-box--calm">
              <div class="incident-box-content-row">
                <div class="incident-none-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <div class="incident-none-text">
                  <div class="incident-none-title">No Active Incidents</div>
                  <p class="incident-none-body">No active evacuations in La Plata County.</p>
                </div>
              </div>
              <div class="incident-box-footer">
                <a href="#" id="noIncidentCodered" class="incident-none-cta-link">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                  Sign up for CodeRED Alerts
                </a>
              </div>
            </div>
          </div>
          <div class="card-divider"></div>
        </div>
      </div>
    </div>

    <main>
      <div class="incident-panel">
        <div class="home-wrapper">
          <div class="preview-container">
            <div class="preview-frame">
              <div class="evac-stages">
                <div class="stage-header-main">
                  <div class="stage-tagline">La Plata County</div>
                  <div class="stage-headline">Stay Ready, Year-Round</div>
                  <div class="stage-body" style="margin-top:8px;max-width:780px;margin-left:auto;margin-right:auto;font-size:15px;line-height:1.5;">
                    <p>La Plata County Office of Emergency Management (<strong>LPCOEM</strong>) — uses the Ready, Set, Go! system to establish evacuation zones. Click the incident map above to confirm your zone. During an incident your zone name and area is subject to change.</p>
                  </div>
                </div>

                <div class="stage-subhead">Ready, Set, Go! System</div>

                <div id="stageTimeline" class="stage-timeline">
                  <svg id="triangleLines" class="triangle-lines" aria-hidden="true">
                    <defs>
                      <linearGradient id="grad-ready-set" gradientUnits="userSpaceOnUse"><stop offset="0%" stop-color="#b33a3a"/><stop offset="100%" stop-color="#a68f00"/></linearGradient>
                      <linearGradient id="grad-ready-go" gradientUnits="userSpaceOnUse"><stop offset="0%" stop-color="#b33a3a"/><stop offset="100%" stop-color="#0a7c25"/></linearGradient>
                      <linearGradient id="grad-set-go" gradientUnits="userSpaceOnUse"><stop offset="0%" stop-color="#a68f00"/><stop offset="100%" stop-color="#0a7c25"/></linearGradient>
                    </defs>
                    <line id="line-ready-set" stroke="url(#grad-ready-set)" stroke-width="4" stroke-linecap="round"/>
                    <line id="line-ready-go" stroke="url(#grad-ready-go)" stroke-width="4" stroke-linecap="round"/>
                    <line id="line-set-go" stroke="url(#grad-set-go)" stroke-width="4" stroke-linecap="round"/>
                  </svg>

                  <div class="stage-item stage-item-ready">
                    <div id="pinReady" class="stage-pin stage-pin-ready"></div>
                    <div class="stage-card stage-card-ready">
                      <h2 class="stage-title">READY</h2>
                      <div class="stage-subtitle">Be READY, Stay SAFE</div>
                      <div class="stage-body">
                        <p><strong>Stay Informed:</strong> Sign-up for CodeRED, ensure Gov't Alerts are enabled on your cell phone, and use apps like Watch Duty.</p>
                        <p><strong>Arrangements:</strong> Make a plan and practice your evacuation; People, Pets, Photos, Papers and Pills.</p>
                        <p><strong>Fire Ready:</strong> Fire Mitigation and last minute safety measures, "Go Kit" with Protective Clothing and masks.</p>
                        <p><strong>Evacuate:</strong> Don't hesitate or ignore evacuation orders. Know multiple ways out.</p>
                      </div>
                    </div>
                  </div>

                  <div class="stage-bottom-row">
                    <div class="stage-item stage-item-set">
                      <div id="pinSet" class="stage-pin stage-pin-set"></div>
                      <div class="stage-card stage-card-set">
                        <h2 class="stage-title">SET</h2>
                        <div class="stage-subtitle">Pre-Evacuation</div>
                        <div class="stage-body stage-body-center">
                          <p><strong>SET - Pre-Evacuation</strong></p>
                          <p>Voluntary Evacuation; Evacuation orders are likely.</p>
                        </div>
                      </div>
                    </div>

                    <div class="stage-item stage-item-go">
                      <div id="pinGo" class="stage-pin stage-pin-go"></div>
                      <div class="stage-card stage-card-go">
                        <h2 class="stage-title">GO</h2>
                        <div class="stage-subtitle">Evacuate Now</div>
                        <div class="stage-body stage-body-center">
                          <p><strong>GO - Evacuate Now</strong></p>
                          <p>LEAVE NOW. Immediate threat to life.</p>
                          <p>This area is closed to public access.</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="status-timestamp">
            <span id="lastLoaded">Last loaded: --</span>
            &nbsp;•&nbsp;
            <span class="source-label">Source: La Plata County Office of Emergency Management</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- CodeRED Overlay -->
  <div id="coderedOverlay" class="codered-overlay" aria-hidden="true">
    <div class="codered-dialog" role="dialog" aria-modal="true" aria-labelledby="coderedTitle">
      <button id="coderedClose" class="codered-close" type="button" aria-label="Close">×</button>
      <div class="codered-header">
        <div class="codered-title-wrap">
          <h2 id="coderedTitle" class="codered-title">CodeRED Emergency Alerts</h2>
          <p class="codered-subtitle">Stay informed about wildfires, floods, and other emergencies in La Plata County.</p>
        </div>
      </div>
      <div class="codered-body">
        <p><strong>CodeRED</strong> is the official emergency alerting system used by La Plata County Office of Emergency Management (LPCOEM).</p>
        <p>You can receive notifications by text, phone call, and email about evacuation notices, road closures, and other time-sensitive information.</p>
      </div>
      <div class="codered-actions">
        <a href="https://accountportal.onsolve.net/lpcalerts" class="primary-pill" target="_blank" rel="noopener noreferrer">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Sign up on CodeRED
        </a>
        <button id="callerIdButton" class="secondary-pill" type="button">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
          Save CodeRED Caller ID
        </button>
      </div>
    </div>
  </div>

  <!-- Caller ID Help Overlay -->
  <div id="callerIdOverlay" class="callerid-overlay" aria-hidden="true">
    <div class="callerid-dialog" role="dialog" aria-modal="true" aria-labelledby="callerIdTitle">
      <button id="callerIdClose" class="callerid-close" type="button" aria-label="Close">×</button>
      
      <div class="callerid-header">
        <div class="callerid-title-wrap">
          <h2 id="callerIdTitle" class="callerid-title">Save CodeRED Caller ID</h2>
          <p class="callerid-subtitle">Prevent emergency alerts from being marked as spam</p>
        </div>
      </div>
      
      <div class="callerid-body">
        <p class="callerid-intro">CodeRED alerts may be blocked by your phone's spam filter. Save these numbers as a contact to ensure you receive emergency notifications:</p>
        
        <div class="callerid-numbers">
          <div class="callerid-number-card">
            <div class="callerid-number-label">Text Messages</div>
            <div class="callerid-number-value">386-71</div>
          </div>
          <div class="callerid-number-card">
            <div class="callerid-number-label">Voice Calls</div>
            <div class="callerid-number-value">(206) 536-3695</div>
          </div>
        </div>
        
        <div class="callerid-download callerid-download--top">
          <button type="button" class="callerid-download-btn" onclick="ReadyLaPlata.downloadVCard()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
            Add to Contacts Automatically
          </button>
          <p class="callerid-download-hint"><strong>Tap 'CREATE NEW CONTACT' inside your phone's app</strong></p>
        </div>
        
        <div class="callerid-manual-divider">
          <span>or add manually</span>
        </div>
        
        <div class="callerid-tabs">
          <button class="callerid-tab is-active" data-tab="iphone" type="button">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
            iPhone
          </button>
          <button class="callerid-tab" data-tab="android" type="button">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 18c0 .55.45 1 1 1h1v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h2v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h1c.55 0 1-.45 1-1V8H6v10zM3.5 8C2.67 8 2 8.67 2 9.5v7c0 .83.67 1.5 1.5 1.5S5 17.33 5 16.5v-7C5 8.67 4.33 8 3.5 8zm17 0c-.83 0-1.5.67-1.5 1.5v7c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-7c0-.83-.67-1.5-1.5-1.5zm-4.97-5.84l1.3-1.3c.2-.2.2-.51 0-.71-.2-.2-.51-.2-.71 0l-1.48 1.48C13.85 1.23 12.95 1 12 1c-.96 0-1.86.23-2.66.63L7.85.15c-.2-.2-.51-.2-.71 0-.2.2-.2.51 0 .71l1.31 1.31C6.97 3.26 6 5.01 6 7h12c0-1.99-.97-3.75-2.47-4.84zM10 5H9V4h1v1zm5 0h-1V4h1v1z"/></svg>
            Android
          </button>
        </div>
        
        <div id="iphoneInstructions" class="callerid-instructions is-visible">
          <div class="callerid-instructions-title">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
            iPhone Instructions
          </div>
          <ol class="callerid-steps">
            <li>Open the <strong>Contacts</strong> app</li>
            <li>Tap the <strong>+</strong> button to create a new contact</li>
            <li>Enter <code>CodeRED Alerts</code> as the name</li>
            <li>Add phone number: <code>206-536-3695</code></li>
            <li>Tap <strong>add phone</strong> and enter: <code>386-71</code></li>
            <li>Tap <strong>Done</strong> to save the contact</li>
          </ol>
        </div>
        
        <div id="androidInstructions" class="callerid-instructions">
          <div class="callerid-instructions-title">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 18c0 .55.45 1 1 1h1v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h2v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h1c.55 0 1-.45 1-1V8H6v10zM3.5 8C2.67 8 2 8.67 2 9.5v7c0 .83.67 1.5 1.5 1.5S5 17.33 5 16.5v-7C5 8.67 4.33 8 3.5 8zm17 0c-.83 0-1.5.67-1.5 1.5v7c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-7c0-.83-.67-1.5-1.5-1.5zm-4.97-5.84l1.3-1.3c.2-.2.2-.51 0-.71-.2-.2-.51-.2-.71 0l-1.48 1.48C13.85 1.23 12.95 1 12 1c-.96 0-1.86.23-2.66.63L7.85.15c-.2-.2-.51-.2-.71 0-.2.2-.2.51 0 .71l1.31 1.31C6.97 3.26 6 5.01 6 7h12c0-1.99-.97-3.75-2.47-4.84zM10 5H9V4h1v1zm5 0h-1V4h1v1z"/></svg>
            Android Instructions
          </div>
          <ol class="callerid-steps">
            <li>Open the <strong>Contacts</strong> app</li>
            <li>Tap <strong>+</strong> or <strong>Create contact</strong></li>
            <li>Enter <code>CodeRED Alerts</code> as the name</li>
            <li>Add phone number: <code>206-536-3695</code></li>
            <li>Tap <strong>Add phone</strong> and enter: <code>386-71</code></li>
            <li>Tap the <strong>checkmark</strong> or <strong>Save</strong></li>
          </ol>
        </div>
        
        <div class="callerid-note">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          <span>Some carriers may still filter messages. Check your spam/blocked messages folder if you're not receiving alerts.</span>
        </div>
      </div>
      
      <div class="callerid-footer">
        <button id="callerIdDismiss" class="secondary-pill" type="button">Done</button>
      </div>
    </div>
  </div>

  <!-- Announcement Overlay (content loaded from announcement.json) -->
  <div id="announcementOverlay" class="announcement-overlay" aria-hidden="true">
    <div class="announcement-dialog" role="dialog" aria-modal="true" aria-labelledby="announcementTitle">
      <button id="announcementClose" class="announcement-close" type="button" aria-label="Close">×</button>
      <!-- Content injected by initAnnouncement() -->
    </div>
  </div>

  <script src="shared.js"></script>
  <script>
  (function() {
    'use strict';

    const { $, escHTML, createChip, sortIncidents, getIncidentParam, updateTimestamp, initCoderedOverlay, initCallerIdOverlay, initDrillBanner, initAnnouncement, initScrollIndicator } = ReadyLaPlata;

    // Configuration
    const CONFIG = {
      mapUrl: 'evac.html',
      incidentLayerUrl: 'https://services2.arcgis.com/ilLrLpXfElYxSy9y/ArcGIS/rest/services/LPC_Evac_Zones_View/FeatureServer/0/query',
      incidentField: 'incident'
    };

    const INCIDENT = getIncidentParam();

    // DOM elements (cached once)
    const DOM = {
      siteBanner: $('siteBanner'),
      chipsEl: $('incidentChips'),
      countBadge: $('incidentCountBadge'),
      incidentPlural: $('incidentPlural'),
      incidentsActive: $('incidentsActive'),
      noIncidentsMsg: $('noIncidentsMsg'),
      noIncidentCodered: $('noIncidentCodered'),
      overviewButton: $('overviewButton'),
      coderedButton: $('coderedButton'),
      coderedOverlay: $('coderedOverlay'),
      coderedClose: $('coderedClose'),
      callerIdButton: $('callerIdButton'),
      callerIdOverlay: $('callerIdOverlay'),
      callerIdClose: $('callerIdClose'),
      lastLoaded: $('lastLoaded'),
      announcementOverlay: $('announcementOverlay'),
      announcementClose: $('announcementClose'),
      announcementDismiss: $('announcementDismiss'),
      announcementAlertBtn: $('announcementAlertBtn')
    };

    // Initialize Caller ID tab switching
    function initCallerIdTabs() {
      const tabs = document.querySelectorAll('.callerid-tab');
      const iphoneInstructions = $('iphoneInstructions');
      const androidInstructions = $('androidInstructions');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          tabs.forEach(t => t.classList.remove('is-active'));
          tab.classList.add('is-active');
          
          const tabName = tab.dataset.tab;
          if (tabName === 'iphone') {
            iphoneInstructions?.classList.add('is-visible');
            androidInstructions?.classList.remove('is-visible');
          } else {
            iphoneInstructions?.classList.remove('is-visible');
            androidInstructions?.classList.add('is-visible');
          }
        });
      });
      
      // Dismiss button
      $('callerIdDismiss')?.addEventListener('click', () => {
        DOM.callerIdOverlay?.classList.remove('is-open');
        DOM.callerIdOverlay?.setAttribute('aria-hidden', 'true');
      });
    }

    async function loadIncidents() {
      const params = new URLSearchParams({
        where: '1=1',
        outFields: CONFIG.incidentField,
        returnDistinctValues: 'true',
        f: 'json'
      });

      try {
        const res = await fetch(CONFIG.incidentLayerUrl + '?' + params);
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const data = await res.json();
        const seen = new Set();
        const names = (data.features || [])
          .map(f => f.attributes?.[CONFIG.incidentField]?.trim())
          .filter(n => {
            if (!n) return false;
            const key = n.toLowerCase();
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
          });

        sortIncidents(names, INCIDENT);

        DOM.countBadge.textContent = names.length;
        DOM.incidentPlural.textContent = names.length === 1 ? '' : 's';
        updateTimestamp(DOM.lastLoaded);

        if (!names.length) {
          DOM.incidentsActive.classList.remove('has-incidents');
          DOM.noIncidentsMsg.classList.remove('hidden');
          return;
        }

        DOM.incidentsActive.classList.add('has-incidents');
        DOM.noIncidentsMsg.classList.add('hidden');

        const frag = document.createDocumentFragment();
        for (const name of names) {
          frag.appendChild(createChip(name, () => {
            const url = new URL(CONFIG.mapUrl, location.href);
            url.searchParams.set('incident', name);
            location.href = url;
          }));
        }
        DOM.chipsEl.appendChild(frag);
      } catch (err) {
        console.error('Error loading incidents:', err);
        DOM.countBadge.textContent = '0';
        DOM.incidentsActive.classList.remove('has-incidents');
        DOM.noIncidentsMsg.classList.remove('hidden');
      }
    }

    function initTriangleLines() {
      const container = $('stageTimeline');
      const svg = $('triangleLines');
      const pins = { ready: $('pinReady'), set: $('pinSet'), go: $('pinGo') };
      
      if (!container || !svg || !pins.ready || !pins.set || !pins.go) return;

      const lines = {
        readySet: $('line-ready-set'),
        readyGo: $('line-ready-go'),
        setGo: $('line-set-go')
      };

      const grads = {
        readySet: $('grad-ready-set'),
        readyGo: $('grad-ready-go'),
        setGo: $('grad-set-go')
      };

      const updateLines = () => {
        const containerRect = container.getBoundingClientRect();
        
        const getCenter = el => {
          const rect = el.getBoundingClientRect();
          return {
            x: rect.left + rect.width / 2 - containerRect.left,
            y: rect.top + rect.height / 2 - containerRect.top
          };
        };

        const ready = getCenter(pins.ready);
        const set = getCenter(pins.set);
        const go = getCenter(pins.go);

        const setAttr = (el, p1, p2) => {
          el.setAttribute('x1', p1.x);
          el.setAttribute('y1', p1.y);
          el.setAttribute('x2', p2.x);
          el.setAttribute('y2', p2.y);
        };

        setAttr(lines.readySet, ready, set);
        setAttr(lines.readyGo, ready, go);
        setAttr(lines.setGo, set, go);

        setAttr(grads.readySet, ready, set);
        setAttr(grads.readyGo, ready, go);
        setAttr(grads.setGo, set, go);
      };

      updateLines();
      setTimeout(updateLines, 100);
      
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(updateLines, 50);
      });
    }

    // Initialize
    DOM.overviewButton?.addEventListener('click', () => location.href = 'overview.html');
    
    loadIncidents();
    initCoderedOverlay(DOM);
    initCallerIdOverlay(DOM);
    initCallerIdTabs();
    initDrillBanner(DOM);
    initAnnouncement(DOM);
    initTriangleLines();
    initScrollIndicator();
  })();
  </script>
</body>
</html>
